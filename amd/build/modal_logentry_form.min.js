define ("local_booking/modal_logentry_form",["jquery","core/event","core/str","core/notification","core/custom_interaction_events","core/modal","core/modal_registry","core/fragment","local_booking/events","local_booking/repository","local_booking/selectors"],function(a,b,c,d,e,f,g,h,i,j,k){var l=!1,m={ADVANCED_FORM:"[data-form-type=\"other\"]",SAVE_BUTTON:"[data-action=\"save\"]",LOADING_ICON_CONTAINER:"[data-region=\"loading-icon-container\"]"},n=function(a){f.call(this,a);this.contextId=null;this.courseId=null;this.userId=null;this.logentryId=null;this.flightDate=null;this.exerciseId=null;this.pirepLookupId=null;this.hasfindpirep=!1;this.reloadingBody=!1;this.reloadingTitle=!1;this.saveButton=this.getFooter().find(m.SAVE_BUTTON)};n.TYPE="local_booking-modal_logentry_form";n.prototype=Object.create(f.prototype);n.prototype.constructor=n;n.prototype.setContextId=function(a){this.contextId=a};n.prototype.getContextId=function(){return this.contextId};n.prototype.setCourseId=function(a){this.courseId=a};n.prototype.getCourseId=function(){return this.courseId};n.prototype.hasCourseId=function(){return null!==this.courseId};n.prototype.setExerciseId=function(a){this.exerciseId=a};n.prototype.getExerciseId=function(){return this.exerciseId};n.prototype.hasExerciseId=function(){return null!==this.exerciseId};n.prototype.setUserId=function(a){this.userId=a};n.prototype.getUserId=function(){return this.userId};n.prototype.hasUserId=function(){return null!==this.userId};n.prototype.setLogentryId=function(a){this.logentryId=a};n.prototype.getLogentryId=function(){return this.logentryId};n.prototype.hasLogentryId=function(){return null!==this.logentryId&&0!=this.logentryId};n.prototype.setFlightDate=function(a){this.flightDate=a};n.prototype.getFlightDate=function(){return this.flightDate};n.prototype.hasFlightDate=function(){return null!==this.flightDate};n.prototype.setFlightType=function(a){this.flightType=a};n.prototype.getFlightType=function(){return this.flightType};n.prototype.hasFindPIREP=function(a){if("undefined"!=typeof a){this.hasfindpirep=a}return this.hasfindpirep};n.prototype.getForm=function(){return this.getBody().find("form")};n.prototype.disableButtons=function(){this.saveButton.prop("disabled",!0)};n.prototype.enableButtons=function(){this.saveButton.prop("disabled",!1)};n.prototype.reloadTitleContent=function(){if(this.reloadingTitle){return this.titlePromise}this.reloadingTitle=!0;this.titlePromise=j.getExerciseName(this.courseId,this.exerciseId).then(function(a){return a.exercisename}).fail(d.exception);this.titlePromise.then(function(a){this.setTitle(a);return a}.bind(this)).always(function(){this.reloadingTitle=!1}.bind(this)).fail(d.exception);return this.titlePromise};n.prototype.reloadBodyContent=function(b){if(this.reloadingBody){return this.bodyPromise}this.reloadingBody=!0;this.disableButtons();var c={};if(this.hasUserId()){c.userid=this.getUserId()}if(this.hasLogentryId()){c.logentryid=this.getLogentryId()}if(this.hasFlightDate()){c.flightdate=this.getFlightDate()}if(this.hasCourseId()){c.courseid=this.getCourseId()}if(this.hasExerciseId()){c.exerciseid=this.getExerciseId()}if("undefined"!=typeof b){c.formdata=b}this.bodyPromise=h.loadFragment("local_booking","logentry_form",this.getContextId(),c);this.setBody(this.bodyPromise);this.bodyPromise.then(function(){if(this.hasFindPIREP()){var b=a("#id_p1pirep").parent();if(!a("#id_error2_p1pirep").length){b.append("<div id=\"id_find_pirep\" tabindex=\"0\" style=\"\"><button type=\"button\" class=\"btn btn-primary\" data-form-type=\"action\"><i class=\"icon fa fa-search fa-fw\"></i></button></div>")}}this.doDynamicDisplay();this.enableButtons();this.setInputMask();this.registerChangeListeners()}.bind(this)).fail(d.exception).always(function(){this.reloadingBody=!1}.bind(this)).fail(d.exception);return this.bodyPromise};n.prototype.setInputMask=function(){if("Dual"==a(k.bookingwrapper).data("trainingtype")){Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_dualtime"))}else if("Multicrew"==a(k.bookingwrapper).data("trainingtype")){Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_multipilottime"))}if("check"==a("input[name='flighttypehidden']").val()){Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_picustime"))}else{Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_groundtime"))}Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_flighttime"));Inputmask({regex:"^([01]?[0-9]|2[0-3]):[0-5][0-9]"}).mask(document.getElementById("id_deptime"));Inputmask({regex:"^([01]?[0-9]|2[0-3]):[0-5][0-9]"}).mask(document.getElementById("id_arrtime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_nighttime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_ifrtime"));Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp1day"));Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp1night"));if(0==this.getLogentryId()){Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp2day"));Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp2night"))}};n.prototype.registerChangeListeners=function(){if(this.hasFindPIREP()){var b=a("#id_find_pirep");b.on("click",function(b){if(!isNaN(a("#id_p1pirep").val())){return this.getPIREPData(b)}}.bind(this))}var c=a("input[name=\"flighttype\"]");c.on("change",function(){a("input[name='flighttypehidden']").val(a("input[name='flighttype']:checked").val());this.doDynamicDisplay();this.applyFlightTimes()}.bind(this));var d=a("input[name=\"passfail\"]");d.on("change",function(){this.doDynamicDisplay();this.applyFlightTimes()}.bind(this));var e=a("input[name=\"flightrule\"]");e.on("change",function(){this.doDynamicDisplay();this.applyFlightTimes()}.bind(this));flighttime=document.getElementById("id_flighttime");flighttime.onchange=function(){return this.applyFlightTimes(!0)}.bind(this)};n.prototype.getPIREPData=function(b){var e=this.getFooter().find(m.LOADING_ICON_CONTAINER);rule=a(k.bookingwrapper).data("trainingtype");pirepdiv=a("#id_p1pirep").parent();pirep=a("#id_p1pirep").val();courseid=this.getCourseId();if(""!=pirep){e.removeClass("hidden");return j.findPirep(pirep,courseid,a("#id_p1id").val()).then(function(b){a("#id_p1pirep").removeClass("is-invalid");if(b.result){if(!a("#id_valid_p1pirep").length){c.get_string("pirepfound","local_booking").then(function(b){pirepdiv.append("<div class=\"form-control-feedback valid-feedback\" id=\"id_valid_p1pirep\" tabindex=\"0\" style=\"\">"+b+"</div>");a("#id_p1pirep").addClass("is-valid");return b}).fail(d.exception)}var e=new Date(1e3*b.logentry.flightdate),f=""+(e.getMonth()+1),g=""+e.getDate(),h=e.getFullYear(),i=b.logentry.deptime,j=i.substring(0,2),k=i.substring(i.indexOf(":")+1,i.length);a("#id_flightdate_day").val(g);a("#id_flightdate_month").val(f);a("#id_flightdate_year").val(h);a("#id_flightdate_hour").val(j);a("#id_flightdate_minute").val(k);a("input[name=\"linkedpirep\"]").val(b.logentry.linkedpirep);a("#id_flighttime").val(b.logentry.flighttime);a("#id_depicao").val(b.logentry.depicao);a("#id_arricao").val(b.logentry.arricao);a("#id_deptime").val(b.logentry.deptime);a("#id_arrtime").val(b.logentry.arrtime);a("#id_callsign").val(b.logentry.callsign);a("#id_aircraft").val(b.logentry.aircraft);a("#id_aircraftreg").val(b.logentry.aircraftreg);a("#id_enginetype").val(b.logentry.enginetype);a("#id_route").val(b.logentry.route);a("#id_fstd").val(b.logentry.fstd);this.doDynamicDisplay();this.applyFlightTimes()}else{a("#id_p1pirep").addClass("is-invalid");if(!a("#id_error2_p1pirep").length){pirepdiv.append("<div class=\"form-control-feedback invalid-feedback\" id=\"id_error2_p1pirep\" tabindex=\"0\" style=\"\">"+b.warnings[0].message+"</div>");a("#id_p1pirep").val("");a("#id_p1pirep").focus()}else{a("#id_error2_p1pirep").show()}if(this.hasFindPIREP()){a("#id_p1pirep").parent().each(function(){a("#id_find_pirep").insertAfter(a("#id_p1pirep"),this)})}}}.bind(this)).always(function(){e.addClass("hidden");b.preventDefault();b.stopPropagation()}).fail(d.exception)}else{return""}};n.prototype.applyFlightTimes=function(b){var c=a(k.bookingwrapper).data("trainingtype"),d=a("input[name='flighttypehidden']").val(),e=a("#id_flighttime").val(),f=a("input[name='passfail']:checked").val(),g="ifr"==a("input[name='flightrule']:checked").val(),h=0!=this.getLogentryId();if(!h||b){if("training"==d||"check"==d&&"fail"==f){a("#id_dualtime").val("Dual"==c?e:"");a("#id_ifrtime").val(g?e:"");a("#id_multipilottime").val("Multicrew"==c?e:"");a("#id_copilottime").val("Multicrew"==c?e:"");a("#id_checkpilottime").val("check"==d?e:"");a("#id_picustime").val("")}else if("solo"==d){a("#id_ifrtime").val(g?e:"");a("#id_dualtime").val("");a("#id_multipilottime").val("");a("#id_copilottime").val("");a("#id_picustime").val("")}else if("check"==d||"pass"==f){a("#id_ifrtime").val(g?e:"");a("#id_picustime").val(e);a("#id_checkpilottime").val(e);a("#id_multipilottime").val("Multicrew"==c?e:"");a("#id_dualtime").val("");a("#id_copilottime").val("")}}};n.prototype.doDynamicDisplay=function(){var b=a(k.bookingwrapper).data("trainingtype"),e=a("input[name='flighttypehidden']").val(),f=a("input[name='passfail']:checked").val(),g="ifr"==a("input[name='flightrule']:checked").val(),h=0!=this.getLogentryId(),i=function(b,c,d,e){var f=4<arguments.length&&arguments[4]!==void 0?arguments[4]:!1;if("undefined"!=typeof b&&"undefined"!=typeof c){var g=this.getForm().find("[aria-expanded=\"true\"]").attr("aria-expanded");if(g||f){if(d){a(b).slideDown("fast")}else{a(b).slideUp("fast")}}if("undefined"!=typeof e){a(c).val(e)}}}.bind(this),j=function(b,e,f){if(h){c.get_string(e,"local_booking").then(function(c){a(b).text(c);return c}).fail(d.exception)}else{c.get_string(f,"local_booking").then(function(c){a(b).text(c);return c}).fail(d.exception)}};if("training"==e||"check"==e&&"fail"==f){if("training"==e||h){p1label="Dual"==b?"p1dual":"p1multicrew"}else{p1label="examiner"}j("label[for='id_p1pirep']","pirep","training"==e?"instpirep":"examinerpirep");j("label[for='id_p1id']",p1label,p1label);i("#fitem_id_p2id","#id_p2id",!0);i("#fitem_id_dualtime","#id_dualtime","Dual"==b);i("#fitem_id_groundtime","#id_groundtime",!0,a("#id_groundtime").val(),!0);i("#fitem_id_ifrtime","#id_ifrtime",g);i("#fitem_id_nighttime","#id_nighttime",g);i("#fitem_id_multipilottime","#id_multipilottime","Multicrew"==b);i("#fitem_id_copilottime","#id_copilottime","Multicrew"==b);i("#fitem_id_checkpilottime","#id_checkpilottime",!1);i("#fitem_id_picustime","#id_picustime",!1)}else if("solo"==e){j("label[for='id_p1pirep']","logbooksolopirep","logbooksolopirep");j("label[for='id_p1id']","p2dual","p2dual");if(!h){a("#id_p1id").val(a("#id_p2id").val())}i("#fitem_id_ifrtime","#id_ifrtime",g);a("#id_landingsp1day").val("1");a("#id_landingsp2day").val("0");i("#fitem_id_p2id","#id_p2id",!1,a("#id_p2id").val(),!0);i("#fitem_id_groundtime","#id_groundtime",!1,"",!0);i("#fitem_id_dualtime","#id_dualtime",!1);i("#fitem_id_multipilottime","#id_multipilottime",!1);i("#fitem_id_copilottime","#id_copilottime",!1);i("#fitem_id_picustime","#id_picustime",!1);i("#fgroup_id_landingsp2","#id_landingsp2",!1)}else if("check"==e||"pass"==f){j("label[for='id_p1pirep']","pirep","examinerpirep");j("label[for='id_p1id']","examiner","examiner");i("#fitem_id_p2id","#id_p2id",!0);i("#fitem_id_ifrtime","#id_ifrtime",g);i("#fitem_id_multipilottime","#id_multipilottime","Multicrew"==b);i("#fitem_id_picustime","#id_picustime",!0);i("#fitem_id_dualtime","#id_dualtime",!1);i("#fitem_id_copilottime","#id_copilottime",!1);i("#fitem_id_checkpilottime","#id_checkpilottime",!1)}};n.prototype.reloadAllContent=function(){return a.when(this.reloadTitleContent(),this.reloadBodyContent())};n.prototype.show=function(){this.reloadAllContent();f.prototype.show.call(this)};n.prototype.hide=function(){f.prototype.hide.call(this);this.setLogentryId(null);this.setFlightDate(null);this.setContextId(null);this.setCourseId(null);this.setExerciseId(null)};n.prototype.getFormData=function(){return this.getForm().serialize()};n.prototype.save=function(){var b,c=this.saveButton.find(m.LOADING_ICON_CONTAINER);if(!("training"==a("input[name='flighttypehidden']").val())){a("#id_groundtime").val(0)}b=this.getForm().find("[aria-invalid=\"true\"]");if(b.length){b.first().focus();return}c.removeClass("hidden");this.disableButtons();var e=this.getFormData(),f="contextid="+this.contextId+"&courseid="+this.courseId+"&exerciseid="+this.exerciseId+"&userid="+this.userId;return j.submitCreateUpdateLogentryForm(f,e).then(function(b){if(b.validationerror){this.reloadBodyContent(e)}else{var c=this.hasLogentryId();this.hide();if(c){a("body").trigger(i.updated,[b.logentry])}else{a("body").trigger(i.created,[b.logentry])}}}.bind(this)).always(function(){c.addClass("hidden");d.fetchNotifications();this.enableButtons()}.bind(this)).fail(d.exception)};n.prototype.registerEventListeners=function(){f.prototype.registerEventListeners.call(this);this.getModal().on(e.events.activate,m.SAVE_BUTTON,function(a,b){this.getForm().submit();b.originalEvent.preventDefault();a.stopPropagation()}.bind(this));this.getModal().on("submit",function(a){b.notifyFormSubmitAjax(this.getForm()[0]);this.save();a.preventDefault();a.stopPropagation()}.bind(this));this.getModal().on("click","a[aria-expanded]",function(){setTimeout(function(){this.doDynamicDisplay()}.bind(this),100)}.bind(this))};if(!l){g.register(n.TYPE,n,"local_booking/modal_logentry_form");l=!0}return n});
//# sourceMappingURL=modal_logentry_form.min.js.map
