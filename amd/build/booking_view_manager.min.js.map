{"version":3,"sources":["../src/booking_view_manager.js"],"names":["refreshBookingsContent","root","courseId","categoryId","target","filter","startLoading","template","attr","mybookingstarget","find","Selectors","mybookingswrapper","bookingwrapper","data","bookingsContext","M","util","js_pending","get","join","Repository","getBookingsData","then","context","viewingbooking","Templates","render","html","js","replaceNode","always","js_complete","stopLoading","fail","Notification","exception","renderLogentryModal","e","LogentryFormPromise","contextId","userId","logentryId","isNew","pendingPromise","Pending","modal","logegntrySession","flightDate","exerciseId","flightType","closest","actions","viewLogEntry","dataset","containers","summaryForm","setContextId","setCourseId","setUserId","setLogentryId","setExerciseId","setFlightDate","setFlightType","getRoot","on","ModalEvents","hidden","destroy","show","stopImmediatePropagation","resolve","catch","renderLogentrySummaryModal","getLogentryById","getEventResponse","logentry","Error","Str","get_string","logentryData","modalParams","title","type","ModalLogentrySummaryForm","TYPE","body","ModalFactory","create","loadingIconContainer","loadingIcon","removeClass","one","addClass"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module handles session booking and logentry view changes.\n *\n * @module     local_booking/booking_view_manager\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport * as Str from 'core/str';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport ModalLogentrySummaryForm from 'local_booking/modal_logentry_summary';\nimport * as Repository from 'local_booking/repository';\nimport * as Selectors from 'local_booking/selectors';\n\n/**\n * Refresh student progression, mybookings, and myassignees content.\n *\n * @method  refreshBookingsContent\n * @param   {object} root The root element.\n * @param   {number} courseId The id of the course associated with the progression view shown\n * @param   {number} categoryId The id of the category associated with the progression view shown\n * @param   {object} target The element being replaced. If not specified, the bookingwrapper is used.\n * @param   {string} filter The filter to show students, inactive (including graduates), suspended, and default to active.\n * @return  {promise}\n */\nexport const refreshBookingsContent = (root, courseId, categoryId, target = null, filter = null) => {\n    startLoading(root);\n\n    const template = root.attr('data-template'),\n        mybookingstarget = root.find(Selectors.mybookingswrapper);\n    target = target || root.find(Selectors.bookingwrapper);\n    courseId = courseId || root.find(Selectors.bookingwrapper).data('courseid');\n    filter = filter || 'active';\n    var bookingsContext;\n    M.util.js_pending([root.get('id'), courseId, categoryId].join('-'));\n    return Repository.getBookingsData(courseId, filter)\n        .then((context) => {\n            context.viewingbooking = true;\n            bookingsContext = context;\n            return Templates.render(template, context);\n        })\n        .then((html, js) => {\n            return Templates.replaceNode(target, html, js);\n        })\n        .then(() => {\n            return Templates.render('local_booking/my_bookings', bookingsContext);\n        })\n        .then((html, js) => {\n            return Templates.replaceNode(mybookingstarget, html, js);\n        })\n        .always(() => {\n            M.util.js_complete([root.get('id'), courseId, categoryId].join('-'));\n            return stopLoading(root);\n        })\n        .fail(Notification.exception);\n};\n\n/**\n * Render the logentry new/edit modal.\n *\n * @method  renderLogentryModal\n * @param   {object} root       The container element\n * @param   {object} e          The triggered event.\n * @param   {Number} LogentryFormPromise  The Logentry form promise.\n * @param   {object} target     The target element.\n * @param   {Number} contextId  The course context id of the logentry.\n * @param   {number} courseId   The graded session course id.\n * @param   {number} userId     The graded session user id.\n * @param   {number} logentryId The graded session logbook entry id.\n * @param   {bool}   isNew      Whether the render is for edit.\n * @returns {promise}\n */\n export const renderLogentryModal = (root, e, LogentryFormPromise, target, contextId, courseId, userId, logentryId, isNew) => {\n    const pendingPromise = new Pending('local_booking/booking_view_manager:renderLogentryModal');\n\n    return LogentryFormPromise\n    .then(function(modal) {\n        // Show the logentry form modal form when the user clicks on a session\n        // in the 'Instructor dashboard' page to add or edit a logentry\n        LogentryFormPromise.then(function(modal) {\n            var logegntrySession, flightDate, exerciseId, flightType;\n\n            // Sel elements not meant for new or additional logentries\n            if (isNew) {\n                // From booking_session_exporter\n                logegntrySession = target.closest(Selectors.actions.viewLogEntry);\n                flightDate = logegntrySession.dataset.flightDate;\n                exerciseId = logegntrySession.dataset.exerciseId;\n                flightType = logegntrySession.dataset.flightType;\n            } else {\n                // From get_logentry_by_id\n                logegntrySession = root.find(Selectors.containers.summaryForm);\n                flightDate = logegntrySession.data('flight-date');\n                exerciseId = logegntrySession.data('exercise-id');\n                flightType = logegntrySession.data('flight-type');\n            }\n\n            // Set form properties\n            modal.setContextId(contextId);\n            modal.setCourseId(courseId);\n            modal.setUserId(userId);\n            modal.setLogentryId(logentryId);\n            modal.setExerciseId(exerciseId);\n            modal.setFlightDate(flightDate);\n            modal.setFlightType(flightType);\n\n            // Handle hidden event.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                // Destroy when hidden.\n                modal.destroy();\n            });\n\n            modal.show();\n            e.stopImmediatePropagation();\n            return;\n        })\n        .fail(Notification.exception);\n        return modal;\n    })\n    .then(function(modal) {\n        pendingPromise.resolve();\n        return modal;\n    })\n    .catch(Notification.exception);\n };\n\n/**\n * Render the logentry summary modal.\n *\n * @method  renderLogentrySummaryModal\n * @param   {number} courseId The graded session course id.\n * @param   {number} userId The graded session user id.\n * @param   {number} logentryId The graded session logbook entry id.\n * @returns {promise}\n */\n export const renderLogentrySummaryModal = (courseId, userId, logentryId) => {\n    const pendingPromise = new Pending('local_booking/booking_view_manager:renderLogentrySummaryModal');\n\n    // Booking repository promise.\n    return Repository.getLogentryById(logentryId, courseId, userId)\n    .then((getEventResponse) => {\n        if (!getEventResponse.logentry) {\n            throw new Error(Str.get_string('errorlogentryfetch', 'local_booking') + logentryId);\n        }\n\n        return getEventResponse.logentry;\n    })\n    .then(logentryData => {\n        // Build the modal parameters from the logentry data.\n        const modalParams = {\n            title: Str.get_string('logentry', 'local_booking'),\n            type: ModalLogentrySummaryForm.TYPE,\n            body: Templates.render('local_booking/logentry_summary_body', logentryData)\n        };\n\n        // Create the modal.\n        return ModalFactory.create(modalParams);\n    })\n    .then(modal => {\n        // Handle hidden event.\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            // Destroy when hidden.\n            modal.destroy();\n        });\n        // Finally, render the modal!\n        modal.show();\n\n        return modal;\n    })\n    .then(modal => {\n        pendingPromise.resolve();\n\n        return modal;\n    })\n    .catch(Notification.exception);\n};\n\n/**\n * Set the element state to loading.\n *\n * @method  startLoading\n * @param   {object} root The container element\n */\n export const startLoading = (root) => {\n    const loadingIconContainer = root.find(Selectors.containers.loadingIcon);\n    loadingIconContainer.removeClass('hidden');\n\n    $(root).one('submit', function() {\n        $(this).find('input[type=\"submit\"]').attr('disabled', 'disabled');\n    });\n};\n\n/**\n * Remove the loading state from the element.\n *\n * @method  stopLoading\n * @param   {object} root The container element\n */\nexport const stopLoading = (root) => {\n    const loadingIconContainer = root.find(Selectors.containers.loadingIcon);\n    loadingIconContainer.addClass('hidden');\n\n    $(root).one('submit', function() {\n        $(this).find('input[type=\"submit\"]').attr('enabled', 'enabled');\n    });\n};\n"],"file":"booking_view_manager.min.js"}