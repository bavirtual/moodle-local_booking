{"version":3,"sources":["../src/booking.js"],"names":["define","$","Str","ModalFactory","ModalEvents","Pending","ModalLogentryForm","ViewManager","BookingActions","BookingEvents","BookingSelectors","SELECTORS","PROGRESSION_WRAPPER","CANCEL_BUTTON","SESSION_ENTRY","registerBookingEventListeners","root","logentryFormModalPromise","body","on","canceled","refreshProgressionContent","refreshMyBookingsContent","created","updated","deleted","registerEditListeners","registerLogentryFormModal","logentryFormPromise","create","type","TYPE","large","actions","edit","e","preventDefault","target","currentTarget","bookingWrapper","closest","progressionwrapper","logentryWrapper","logentryItem","then","modal","setSessionDate","data","setLogentryId","setStudentId","setCourseId","setContextId","show","stopImmediatePropagation","fail","Notification","exception","registerEventListeners","contextId","courseId","sessionDate","attr","studentId","exerciseId","logentryId","setExerciseId","logentrySession","pendingPromise","matches","viewEvent","dataset","querySelector","stopPropagation","renderLogentrySummaryModal","resolve","catch","get_string","promptMsg","comment","prompt","cancelBooking","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for handling progression booking activity\n * Improvised from core_calendar.\n *\n * @module     local_booking/booking\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n            'jquery',\n            'core/str',\n            'core/modal_factory',\n            'core/modal_events',\n            'core/pending',\n            'local_booking/modal_logentry_form',\n            'local_booking/booking_view_manager',\n            'local_booking/booking_actions',\n            'local_booking/events',\n            'local_booking/selectors'\n        ],\n        function(\n            $,\n            Str,\n            ModalFactory,\n            ModalEvents,\n            Pending,\n            ModalLogentryForm,\n            ViewManager,\n            BookingActions,\n            BookingEvents,\n            BookingSelectors\n        ) {\n\n    var SELECTORS = {\n        PROGRESSION_WRAPPER: \".progressionwrapper\",\n        CANCEL_BUTTON: \"[data-region='cancel-button']\",\n        SESSION_ENTRY: \"[data-region='session-entry']\",\n    };\n\n    /**\n     * Listen to and handle any calendar events fired by the calendar UI.\n     *\n     * @method registerBookingEventListeners\n     * @param {object} root The calendar root element\n     * @param {object} logentryFormModalPromise A promise reolved with the event form modal\n     */\n     var registerBookingEventListeners = function(root, logentryFormModalPromise) {\n        var body = $('body');\n\n        body.on(BookingEvents.canceled, function() {\n            ViewManager.refreshProgressionContent(root);\n            ViewManager.refreshMyBookingsContent(root);\n        });\n        body.on(BookingEvents.created, function() {\n            ViewManager.refreshProgressionContent(root);\n        });\n        body.on(BookingEvents.updated, function() {\n            ViewManager.refreshProgressionContent(root);\n        });\n        body.on(BookingEvents.deleted, function() {\n            ViewManager.refreshProgressionContent(root);\n        });\n\n        // if (logentryFormModalPromise !== 'undefined') {\n            BookingActions.registerEditListeners(root, logentryFormModalPromise);\n        // }\n    };\n\n    /**\n     * Create the logentry form modal for creating new logentries and\n     * editing existing logentries.\n     *\n     * @method registerLogentryFormModal\n     * @param {object} root The progression booking root element\n     * @return {object} The create modal promise\n     */\n     var registerLogentryFormModal = function(root) {\n        var logentryFormPromise = ModalFactory.create({\n            type: ModalLogentryForm.TYPE,\n            large: true\n        });\n\n        root.on('click', BookingSelectors.actions.edit, function(e) {\n            e.preventDefault();\n            var target = $(e.currentTarget),\n                bookingWrapper = target.closest(BookingSelectors.progressionwrapper),\n                logentryWrapper = target.closest(BookingSelectors.logentryItem);\n\n            logentryFormPromise.then(function(modal) {\n                // When something within the progression booking tells us the user wants\n                // to edit an logentry then show the logentry form modal.\n                modal.setSessionDate(logentryWrapper.data('sessionDate'));\n                modal.setLogentryId(logentryWrapper.data('logentryId'));\n                modal.setStudentId(logentryWrapper.data('studentId'));\n                modal.setCourseId(bookingWrapper.data('courseId'));\n                modal.setContextId(bookingWrapper.data('contextId'));\n                modal.show();\n\n                e.stopImmediatePropagation();\n                return;\n            }).fail(Notification.exception);\n        });\n\n\n        return logentryFormPromise;\n    };\n\n    /**\n     * Register event listeners for the module.\n     *\n     * @param {object} root The calendar root element\n     */\n     var registerEventListeners = function(root) {\n\n        var logentryFormPromise = registerLogentryFormModal(root),\n            contextId = $(SELECTORS.PROGRESSION_WRAPPER).data('context-id'),\n            courseId = $(SELECTORS.PROGRESSION_WRAPPER).data('courseid');\n        registerBookingEventListeners(root, logentryFormPromise);\n\n        if (contextId) {\n            // Listen the click on the progression table of sessions.\n            root.on('click', SELECTORS.SESSION_ENTRY, function(e) {\n                var sessionDate = $(this).attr('data-session-date');\n                var studentId = $(this).attr('data-student-id');\n                var exerciseId = $(this).attr('data-exercise-id');\n                var logentryId = $(this).attr('data-logentry-id');\n\n                if (logentryId == 0) {\n                    logentryFormPromise.then(function(modal) {\n                        modal.setContextId(contextId);\n                        modal.setCourseId(courseId);\n                        modal.setStudentId(studentId);\n                        modal.setExerciseId(exerciseId);\n                        modal.setLogentryId(logentryId);\n                        modal.setSessionDate(sessionDate);\n                        modal.show();\n                        return;\n                    })\n                    .fail(Notification.exception);\n\n                    e.preventDefault();\n                } else {\n                    let logentrySession = null;\n                    let logentryId = null;\n                    const target = e.target;\n                    const pendingPromise = new Pending('local_booking/booking_view_manager:logentrySession:click');\n\n                    if (target.matches(BookingSelectors.actions.viewEvent)) {\n                        logentrySession = target;\n                    } else {\n                        logentrySession = target.closest(BookingSelectors.actions.viewEvent);\n                    }\n\n                    if (logentrySession) {\n                        logentryId = logentrySession.dataset.logentryId;\n                    } else {\n                        logentryId = target.querySelector(BookingSelectors.actions.viewEvent).dataset.logentryId;\n                    }\n\n                    if (logentryId) {\n                        // A link was found. Show the modal.\n\n                        e.preventDefault();\n                        // We've handled the event so stop it from bubbling\n                        // and causing the day click handler to fire.\n                        e.stopPropagation();\n\n                        ViewManager.renderLogentrySummaryModal(logentryId, courseId, studentId)\n                        .then(pendingPromise.resolve)\n                        .catch();\n                    } else {\n                        pendingPromise.resolve();\n                    }\n\n                }\n            });\n        }\n\n        // Listen the click on the Cancel booking buttons.\n        root.on('click', SELECTORS.CANCEL_BUTTON, function(e) {\n            // eslint-disable-next-line no-alert\n            Str.get_string('cancellationcomment', 'local_booking').then(function(promptMsg) {\n                var comment = prompt(promptMsg);\n                if (comment !== null) {\n                    BookingActions.cancelBooking(root, e, comment);\n                }\n                return;\n            }).catch(Notification.exception);\n        });\n    };\n\n    return {\n        init: function(root) {\n            root = $(root);\n            ViewManager.init(root);\n            registerEventListeners(root);\n            registerLogentryFormModal(root);\n        }\n    };\n});\n"],"file":"booking.min.js"}