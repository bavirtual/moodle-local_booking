define ("local_booking/slot_actions",["jquery","core/notification","local_booking/repository","local_booking/calendar_view_manager"],function(a,b,c,d){var l={CALENDAR_WRAPPER:"[class=calendarwrapper]",SLOTS_TABLE:"[data-region=\"slots-week\"]",SLOT_DAY:"[data-region=\"day\"]",SAVE_BUTTON:"[data-region=\"save-button\"]",PASTE_BUTTON:"[data-region='paste-button']",BOOK_BUTTON:"[data-region='book-button']",DAY_TIME_SLOT:"[data-action='day-time-slot']",LOADING_ICON_CONTAINER:"[data-region=\"loading-icon-container\"]"},m=[],n,o=[],p=!1;function e(a){d.startLoading(a);var e=a.find(l.CALENDAR_WRAPPER).data("courseid"),g=a.find(l.CALENDAR_WRAPPER).data("exercise-id"),h=a.find(l.CALENDAR_WRAPPER).data("student-id");f(a,"book");return c.saveBookedSlot(n,e,g,h).then(function(a){if(a.validationerror){alert("Errors encountered: Unable to save slot!")}else{location.href=M.cfg.wwwroot+"/local/booking/view.php?courseid="+e}}.bind(this)).always(function(){d.stopLoading(a)}.bind(this)).fail(b.exception)}function f(b,c){var d="book"==c?"slot-booked":"slot-marked",e=b.find(l.CALENDAR_WRAPPER).data("year"),f=b.find(l.CALENDAR_WRAPPER).data("week"),h=b.find(l.SLOTS_TABLE).attr("id"),j=a("#"+h+" th"),k=document.getElementById(h).rows[0].cells.length,n;m.length=0;j.each(function(){if("slot-week-day"==a(this).data("region")){n=j.index(this)+1;return!1}});for(var o=function(b){var c=a("#"+h+" td:nth-child("+b+")").map(function(){return[[a(this).data(d),a(this).data("slot-timestamp")]]}).get(),i={};c.forEach(function(a,b){var h=b==c.length-1;if(a[0]){if(0===Object.keys(i).length&&i.constructor===Object){i.starttime=a[1]}else{i.endtime=a[1]}}else if(!(0===Object.keys(i).length&&i.constructor===Object)){i=g(i,d,f,e)}if(h&&!(0===Object.keys(i).length&&i.constructor===Object)){i=g(i,d,f,e)}})},p=n;p<=k;p++){o(p)}}function g(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0,d=3<arguments.length&&arguments[3]!==void 0?arguments[3]:0;if("slot-marked"==b){m.push(a)}else if("slot-booked"==b){a.week=c;a.year=d;n=a}return{}}function h(a){if(0<o.length){a.find(l.PASTE_BUTTON).addClass("slot-button-blue").removeClass("slot-button-gray")}else{a.find(l.PASTE_BUTTON).addClass("slot-button-gray").removeClass("slot-button-blue")}}function i(a,b,c){f(a,b);var d="slot-button-gray",e=a.find("book"==b?l.BOOK_BUTTON:l.SAVE_BUTTON),g=c||"book"==b&&n!==void 0&&0!==n.length||"post"==b&&m!==void 0&&0!==m.length;e.addClass(g?"slot-button-blue":d).removeClass(!g?"slot-button-blue":d);e.prop("disabled",!g)}function j(b,c,d){var e="book"==d?"slot-booked":"slot-marked",f="book"==d?"slot-booked":"slot-selected";if(!a(b).data(e)){a(b).addClass(f)}else{a(b).removeClass(f)}a(b).data(e,!a(b).data(e))}function k(a,b,c){var d=3<arguments.length&&arguments[3]!==void 0?arguments[3]:!1;if("undefined"!=typeof c&&(p||d)){if(!c.is(l.DAY_TIME_SLOT)&&"all"!==b&&""!==b){j(c,a,b);i(a,b)}}}return{saveWeekSlots:function(a){d.startLoading(a);var e=a.find(l.CALENDAR_WRAPPER).data("courseid"),g=a.find(l.CALENDAR_WRAPPER).data("year"),h=a.find(l.CALENDAR_WRAPPER).data("week");f(a);var i=null;if(0!=m.length){i=c.saveSlots(m,e,g,h)}else{i=c.clearSlots(e,g,h)}return i.then(function(a){if(a.validationerror){alert("Errors encountered: Unable to process availability posting action!")}}.bind(this)).always(function(){b.fetchNotifications();return d.stopLoading(a)}.bind(this)).fail(b.exception)},saveBookedSlot:e,clearWeekSlots:function(b){a("td").filter(function(){if(0==a(this).data("slot-booked")){a(this).data("slot-marked",0);a(this).removeClass("slot-selected")}});i(b,"post",!0)},pasteSlots:function(b){var c=document.getElementById(b.find(l.SLOTS_TABLE).attr("id"));o.forEach(function(b){var d=c.rows[b[0]].cells[b[1]];a(d).data("slot-marked",1);a(d).addClass("slot-selected",1)});i(b,"post")},setPasteState:h,setSaveButtonState:i,copySlots:function(b){o.length=0;a(l.SLOT_DAY).each(function(b,c){if(a(c).data("slot-marked")){o.push([c.closest("tr").rowIndex,c.cellIndex])}});h(b)},postSlots:k,setPosting:function(a){p=a},Slots:m,SlotIndexes:o}});
//# sourceMappingURL=slot_actions.min.js.map
