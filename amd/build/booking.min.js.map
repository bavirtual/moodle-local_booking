{"version":3,"file":"booking.min.js","sources":["../src/booking.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for registering listeners\n * for all session booking and logentry events.\n *\n * @module     local_booking/booking\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n        'jquery',\n        'core/str',\n        'core/pending',\n        'core/modal_factory',\n        'core/notification',\n        'local_booking/booking_view_manager',\n        'local_booking/booking_actions',\n        'local_booking/events',\n        'local_booking/modal_logentry_form',\n        'local_booking/selectors'\n    ],\n    function(\n        $,\n        Str,\n        Pending,\n        ModalFactory,\n        Notification,\n        ViewManager,\n        BookingActions,\n        BookingEvents,\n        ModalLogentryEditForm,\n        Selectors\n    ) {\n\n    /**\n     * Listen to and handle any logentry events fired by\n     * Logentry and PIREP the modal forms.\n     *\n     * @method registerBookingEventListeners\n     * @param  {object} root The booking root element\n     */\n     const registerBookingEventListeners = function(root) {\n        const body = $('body');\n\n        body.on(BookingEvents.canceled, function() {\n            ViewManager.refreshBookingsContent(root);\n        });\n        body.on(BookingEvents.created, function() {\n            ViewManager.refreshBookingsContent(root);\n        });\n        body.on(BookingEvents.updated, function() {\n            ViewManager.refreshBookingsContent(root);\n        });\n        body.on(BookingEvents.deleted, function() {\n            ViewManager.refreshBookingsContent(root);\n        });\n\n        // Listen to the click on the Cancel booking buttons in 'Instructor dashboard' page.\n        root.on('click', Selectors.cancelbutton, function(e) {\n            Str.get_string('commentcancel', 'local_booking').then(function(promptMsg) {\n                // eslint-disable-next-line no-alert\n                const comment = prompt(promptMsg);\n                if (comment !== null) {\n                    BookingActions.cancelBooking(root, e, comment, false);\n                }\n                return;\n            }).catch(Notification.exception);\n        });\n\n        // Listen to the click on the 'No-show' booking buttons in 'Instructor dashboard' page.\n        root.on('click', Selectors.noshowbutton, function(e) {\n            // Get number of no shows\n            const noshows = $(e.target).closest(Selectors.noshowbutton).data('noshows');\n            // Get the message associated with the number of no-show occurence\n            const noShowComment = Str.get_string('commentnoshow' + noshows, 'local_booking').then(function(noshowMsg) {\n                return noshowMsg;\n            }).catch(Notification.exception);\n            // Chain the two retrieved strings in the prompt\n            $.when(Str.get_string('commentnoshow', 'local_booking'), noShowComment)\n            .then(function(promptMsg, noshowMsg) {\n                // eslint-disable-next-line no-alert\n                if (confirm(promptMsg + '\\n\\n' + noshowMsg)) {\n                    BookingActions.cancelBooking(root, e, null, true);\n                }\n                return;\n            }).catch(Notification.exception);\n        });\n\n        // Register the listeners required to redirect to\n        // $('input[name=\"studentsfilter\"]').change(function() {\n        // $('input[type=radio][name=studentsfilter]').change(function() {\n        root.on('change', 'input[type=radio][name=studentsfilter]', function() {\n            // Call redirect to assignment feedback page\n            ViewManager.refreshBookingsContent(root, 0, 0, null, $('input[name=\"studentsfilter\"]:checked').val());\n        });\n\n        // Register the listeners required to redirect to\n        root.on('click', Selectors.actions.gotoFeedback, function(e) {\n            // Call redirect to assignment feedback page\n            BookingActions.gotoFeedback(root, e);\n\n            e.preventDefault();\n        });\n    };\n\n    /**\n     * Register event listeners for session clicks.\n     *\n     * @param {object} root The root element.\n     */\n    const registerSessionEventListeners = (root) => {\n\n        // Get promise for the logentry form for create and edit\n        const contextId = $(Selectors.bookingwrapper).data('contextid'),\n        courseId = $(Selectors.bookingwrapper).data('courseid');\n\n        if (contextId) {\n            // Listen the click on the progression table of sessions for a logentry (new/view).\n            root.on('click', Selectors.actions.viewLogEntry, function(e) {\n                let logentryId = $(this).attr('data-logentry-id'),\n                userId = $(this).attr('data-student-id');\n\n                // A logentry needs to be created or edite, show the modal form.\n                e.preventDefault();\n                // We've handled the event so stop it from bubbling\n                // and causing the day click handler to fire.\n                e.stopPropagation();\n\n                if (logentryId == 0) {\n                    registerLogentryEditForm(null, e, contextId, courseId, userId, logentryId, true);\n                } else {\n                    registerLogentrySummaryForm(contextId, courseId, userId, logentryId);\n                }\n                e.stopImmediatePropagation();\n            });\n        }\n    };\n\n    /**\n     * Register the form and listeners required for\n     * creating and editing logentries.\n     *\n     * @method registerLogentryEditForm\n     * @param  {object} root       The root element.\n     * @param  {object} e          The triggered event.\n     * @param  {Number} contextId  The course context id of the logentry.\n     * @param  {Number} courseId   The course id of the logentry.\n     * @param  {Number} userId     The user id the logentry belongs to.\n     * @param  {Number} logentryId The logentry id.\n     * @param  {bool}   isNew      Whether to register for edit mode.\n     */\n    const registerLogentryEditForm = (root, e, contextId, courseId, userId, logentryId, isNew) => {\n        const LogentryFormPromise = ModalFactory.create({\n            type: ModalLogentryEditForm.TYPE,\n            large: true\n        });\n\n        const target = e.target;\n        const pendingPromise = new Pending('local_booking/registerLogentryEditForm');\n\n        ViewManager.renderLogentryModal(root, e, LogentryFormPromise, target, contextId, courseId, userId, logentryId, isNew)\n        .then(pendingPromise.resolve())\n        .catch();\n    };\n\n    /**\n     * Register the form and listeners required for\n     * viewing the logentry summary form.\n     *\n     * @method registerLogentrySummaryForm\n     * @param  {Number} contextId  The course context id of the logentry.\n     * @param  {Number} courseId   The course id of the logentry.\n     * @param  {Number} userId     The user id the logentry belongs to.\n     * @param  {Number} logentryId The logentry id.\n     */\n    const registerLogentrySummaryForm = (contextId, courseId, userId, logentryId) => {\n        const pendingPromise = new Pending('local_booking/registerLogentrySummaryForm');\n\n        if (logentryId) {\n            ViewManager.renderLogentrySummaryModal(courseId, userId, logentryId)\n            .then(function(modal) {\n                $('body').on(BookingEvents.editLogentry, function(e, userId, logentryId) {\n                    registerLogentryEditForm(modal.getRoot(), e, contextId, courseId, userId, logentryId);\n                    e.stopImmediatePropagation();\n                });\n                $('body').on(BookingEvents.addLogentry, function(e, userId) {\n                    registerLogentryEditForm(modal.getRoot(), e, contextId, courseId, userId, 0);\n                    e.stopImmediatePropagation();\n                });\n                return modal;\n            })\n            .then(pendingPromise.resolve())\n            .catch();\n        } else {\n            pendingPromise.resolve();\n        }\n    };\n\n    /**\n     * Register event listeners for logbook entry,\n     * and session cancellation in both\n     * 'Instructor dashboard' and 'Session selection' pages.\n     *\n     * @method  registerEventListeners\n     * @param   {object} root The booking root element\n     */\n     const registerEventListeners = function(root) {\n\n        // Register listeners to booking actions\n        registerBookingEventListeners(root);\n\n        // Register listeners to session click actions\n        registerSessionEventListeners(root);\n    };\n\n    return {\n        init: function(root) {\n            var root = $(root);\n            registerEventListeners(root);\n            ViewManager.stopLoading(root);\n        }\n    };\n});\n"],"names":["define","$","Str","Pending","ModalFactory","Notification","ViewManager","BookingActions","BookingEvents","ModalLogentryEditForm","Selectors","registerLogentryEditForm","root","e","contextId","courseId","userId","logentryId","isNew","LogentryFormPromise","create","type","TYPE","large","target","pendingPromise","renderLogentryModal","then","resolve","registerLogentrySummaryForm","renderLogentrySummaryModal","modal","on","editLogentry","getRoot","stopImmediatePropagation","addLogentry","registerEventListeners","body","canceled","refreshBookingsContent","created","updated","deleted","cancelbutton","get_string","promptMsg","comment","prompt","cancelBooking","exception","noshowbutton","noshows","closest","data","noShowComment","noshowMsg","when","confirm","val","actions","gotoFeedback","preventDefault","registerBookingEventListeners","bookingwrapper","viewLogEntry","this","attr","stopPropagation","registerSessionEventListeners","init","stopLoading"],"mappings":";;;;;;;;;AAyBAA,+BAAO,CACC,SACA,WACA,eACA,qBACA,oBACA,qCACA,gCACA,uBACA,oCACA,4BAEJ,SACIC,EACAC,IACAC,QACAC,aACAC,aACAC,YACAC,eACAC,cACAC,sBACAC,WAUH,IA8GKC,yBAA2B,SAACC,KAAMC,EAAGC,UAAWC,SAAUC,OAAQC,WAAYC,OAChF,IAAMC,oBAAsBf,aAAagB,OAAO,CAC5CC,KAAMZ,sBAAsBa,KAC5BC,OAAO,IAGLC,OAASX,EAAEW,OACXC,eAAiB,IAAItB,QAAQ,0CAEnCG,YAAYoB,oBAAoBd,KAAMC,EAAGM,oBAAqBK,OAAQV,UAAWC,SAAUC,OAAQC,WAAYC,OAC9GS,KAAKF,eAAeG,oBAcnBC,4BAA8B,SAACf,UAAWC,SAAUC,OAAQC,YAC9D,IAAMQ,eAAiB,IAAItB,QAAQ,6CAE/Bc,WACAX,YAAYwB,2BAA2Bf,SAAUC,OAAQC,YACxDU,MAAK,SAASI,OASX,OARA9B,EAAE,QAAQ+B,GAAGxB,cAAcyB,cAAc,SAASpB,EAAGG,OAAQC,YACzDN,yBAAyBoB,MAAMG,UAAWrB,EAAGC,UAAWC,SAAUC,OAAQC,YAC1EJ,EAAEsB,0BACN,IACAlC,EAAE,QAAQ+B,GAAGxB,cAAc4B,aAAa,SAASvB,EAAGG,QAChDL,yBAAyBoB,MAAMG,UAAWrB,EAAGC,UAAWC,SAAUC,OAAQ,GAC1EH,EAAEsB,0BACN,IACOJ,SAEVJ,KAAKF,eAAeG,WAAU,QAG/BH,eAAeG,WAYhBS,uBAAyB,SAASzB,OArKF,SAASA,MAC5C,IAAM0B,KAAOrC,EAAE,QAEfqC,KAAKN,GAAGxB,cAAc+B,UAAU,WAC5BjC,YAAYkC,uBAAuB5B,KACvC,IACA0B,KAAKN,GAAGxB,cAAciC,SAAS,WAC3BnC,YAAYkC,uBAAuB5B,KACvC,IACA0B,KAAKN,GAAGxB,cAAckC,SAAS,WAC3BpC,YAAYkC,uBAAuB5B,KACvC,IACA0B,KAAKN,GAAGxB,cAAcmC,SAAS,WAC3BrC,YAAYkC,uBAAuB5B,KACvC,IAGAA,KAAKoB,GAAG,QAAStB,UAAUkC,cAAc,SAAS/B,GAC9CX,IAAI2C,WAAW,gBAAiB,iBAAiBlB,MAAK,SAASmB,WAE3D,IAAMC,QAAUC,OAAOF,WACP,OAAZC,SACAxC,eAAe0C,cAAcrC,KAAMC,EAAGkC,SAAS,EAGtD,IAAO,MAAC1C,aAAa6C,UAC1B,IAGAtC,KAAKoB,GAAG,QAAStB,UAAUyC,cAAc,SAAStC,GAE9C,IAAMuC,QAAUnD,EAAEY,EAAEW,QAAQ6B,QAAQ3C,UAAUyC,cAAcG,KAAK,WAE3DC,cAAgBrD,IAAI2C,WAAW,gBAAkBO,QAAS,iBAAiBzB,MAAK,SAAS6B,WAC3F,OAAOA,SACV,IAAO,MAACnD,aAAa6C,WAEtBjD,EAAEwD,KAAKvD,IAAI2C,WAAW,gBAAiB,iBAAkBU,eACxD5B,MAAK,SAASmB,UAAWU,WAElBE,QAAQZ,UAAY,OAASU,YAC7BjD,eAAe0C,cAAcrC,KAAMC,EAAG,MAAM,EAGnD,IAAO,MAACR,aAAa6C,UAC1B,IAKAtC,KAAKoB,GAAG,SAAU,0CAA0C,WAExD1B,YAAYkC,uBAAuB5B,KAAM,EAAG,EAAG,KAAMX,EAAE,wCAAwC0D,MACnG,IAGA/C,KAAKoB,GAAG,QAAStB,UAAUkD,QAAQC,cAAc,SAAShD,GAEtDN,eAAesD,aAAajD,KAAMC,GAElCA,EAAEiD,gBACN,IA2GAC,CAA8BnD,MAnGI,SAACA,MAGnC,IAAME,UAAYb,EAAES,UAAUsD,gBAAgBV,KAAK,aACnDvC,SAAWd,EAAES,UAAUsD,gBAAgBV,KAAK,YAExCxC,WAEAF,KAAKoB,GAAG,QAAStB,UAAUkD,QAAQK,cAAc,SAASpD,GACtD,IAAII,WAAahB,EAAEiE,MAAMC,KAAK,oBAC9BnD,OAASf,EAAEiE,MAAMC,KAAK,mBAGtBtD,EAAEiD,iBAGFjD,EAAEuD,kBAEgB,GAAdnD,WACAN,yBAAyB,KAAME,EAAGC,UAAWC,SAAUC,OAAQC,YAAY,GAE3EY,4BAA4Bf,UAAWC,SAAUC,OAAQC,YAE7DJ,EAAEsB,0BACN,IA8EJkC,CAA8BzD,OAGlC,MAAO,CACH0D,KAAM,SAAS1D,MACPA,KAAOX,EAAEW,MACbyB,uBAAuBzB,MACvBN,YAAYiE,YAAY3D,KAC5B,EAER"}