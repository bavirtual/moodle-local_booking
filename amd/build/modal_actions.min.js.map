{"version":3,"file":"modal_actions.min.js","sources":["../src/modal_actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module handles additional logentry modal form action.\n *\n * @module     local_booking/modal_actions\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/str',\n    'core/notification',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/pending',\n    'local_booking/repository',\n    'local_booking/events',\n    'local_booking/selectors',\n    'local_booking/booking_actions',\n],\nfunction(\n    $,\n    Str,\n    Notification,\n    ModalFactory,\n    ModalEvents,\n    Pending,\n    Repository,\n    BookingSessions,\n    BookingSelectors,\n    BookingActions,\n) {\n\n    /**\n     * Prepares the action for the summary modal's delete action.\n     *\n     * @method  confirmDeletion\n     * @param   {Number} logentryId The ID of the logentry.\n     * @param   {Number} userId The user of the logentry.\n     * @param   {Number} courseId The course of the logentry.\n     * @return  {Promise}\n     */\n    var confirmDeletion = (logentryId, userId, courseId) => {\n        var pendingPromise = new Pending('local_booking/booking_actions:confirmDeletion');\n        var deleteStrings = [\n            {\n                key: 'deletelogentry',\n                component: 'local_booking'\n            },\n        ];\n\n        var deletePromise;\n        deleteStrings.push({\n            key: 'confirmlogentrydelete',\n            component: 'local_booking'\n        });\n\n\n        deletePromise = ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n        });\n\n        var stringsPromise = Str.get_strings(deleteStrings);\n\n        // Setup modal delete prompt form\n        var finalPromise = $.when(stringsPromise, deletePromise)\n        .then(function(strings, deleteModal) {\n            deleteModal.setRemoveOnClose(true);\n            deleteModal.setTitle(strings[0]);\n            deleteModal.setBody(strings[1]);\n            deleteModal.setSaveButtonText(strings[0]);\n\n            deleteModal.show();\n\n            deleteModal.getRoot().on(ModalEvents.save, function() {\n                var pendingPromise = new Pending('local_booking/booking_actions:initModal:deletedlogentry');\n                Repository.deleteLogentry(logentryId, userId, courseId)\n                    .then(function() {\n                        $('body').trigger(BookingSessions.logentrydeleted, [logentryId, false]);\n                        return;\n                    })\n                    .then(pendingPromise.resolve)\n                    .always(function() {\n                        Notification.fetchNotifications();\n                    })\n                    .catch(Notification.exception);\n            });\n\n            return deleteModal;\n        })\n        .then(function(modal) {\n            pendingPromise.resolve();\n\n            return modal;\n        })\n        .catch(Notification.exception);\n\n        return finalPromise;\n    };\n\n    /**\n     * Register the listeners required to delete the logentry.\n     *\n     * @method  registerDelete\n     * @param   {jQuery} root\n     */\n     var registerDelete = (root) => {\n        root.on('click', BookingSelectors.actions.deleteLogentry, function(e) {\n            // Fetch the logentry title, and pass them into the new dialogue.\n            const target = e.target;\n            var logentrySource = root.find(BookingSelectors.logentryitem),\n                logentryId = logentrySource.data('logentryId') ||\n                target.closest(BookingSelectors.containers.summaryForm).dataset.logentryId,\n                userId = logentrySource.data('userId') ||\n                target.closest(BookingSelectors.containers.summaryForm).dataset.userId,\n                courseId = logentrySource.data('courseId') || $(BookingSelectors.logbookwrapper).data('courseid');\n            confirmDeletion(logentryId, userId, courseId);\n\n            e.preventDefault();\n        });\n    };\n\n    /**\n     * Register the listeners required to redirect to\n     * exercise (assignment) grading page.\n     *\n     * @method  registerRedirect\n     * @param   {jQuery} root\n     */\n     const registerRedirect = function(root) {\n        root.on('click', BookingSelectors.actions.gotoFeedback, function(e) {\n            // Call redirect to assignment feedback page\n            BookingActions.gotoFeedback(root, e);\n\n            e.preventDefault();\n        });\n    };\n\n    return {\n        registerDelete: registerDelete,\n        registerRedirect: registerRedirect\n    };\n});\n"],"names":["define","$","Str","Notification","ModalFactory","ModalEvents","Pending","Repository","BookingSessions","BookingSelectors","BookingActions","registerDelete","root","on","actions","deleteLogentry","e","target","logentrySource","find","logentryitem","logentryId","userId","courseId","deletePromise","pendingPromise","deleteStrings","key","component","push","create","type","types","SAVE_CANCEL","stringsPromise","get_strings","when","then","strings","deleteModal","setRemoveOnClose","setTitle","setBody","setSaveButtonText","show","getRoot","save","trigger","logentrydeleted","resolve","always","fetchNotifications","exception","modal","confirmDeletion","data","closest","containers","summaryForm","dataset","logbookwrapper","preventDefault","registerRedirect","gotoFeedback"],"mappings":";;;;;;;;AAuBAA,qCAAO,CACH,SACA,WACA,oBACA,qBACA,oBACA,eACA,2BACA,uBACA,0BACA,kCAEJ,SACIC,EACAC,IACAC,aACAC,aACAC,YACAC,QACAC,WACAC,gBACAC,iBACAC,gBA4GA,MAAO,CACHC,eAjCkB,SAACC,MACnBA,KAAKC,GAAG,QAASJ,iBAAiBK,QAAQC,gBAAgB,SAASC,GAE/D,IAAMC,OAASD,EAAEC,OACbC,eAAiBN,KAAKO,KAAKV,iBAAiBW,eApElC,SAACC,WAAYC,OAAQC,UACvC,IAQIC,cARAC,eAAiB,IAAInB,QAAQ,iDAC7BoB,cAAgB,CAChB,CACIC,IAAK,iBACLC,UAAW,kBAKnBF,cAAcG,KAAK,CACfF,IAAK,wBACLC,UAAW,kBAIfJ,cAAgBpB,aAAa0B,OAAO,CAChCC,KAAM3B,aAAa4B,MAAMC,cAG7B,IAAIC,eAAiBhC,IAAIiC,YAAYT,eAGlBzB,EAAEmC,KAAKF,eAAgBV,eACzCa,MAAK,SAASC,QAASC,aAsBpB,OArBAA,YAAYC,kBAAiB,GAC7BD,YAAYE,SAASH,QAAQ,IAC7BC,YAAYG,QAAQJ,QAAQ,IAC5BC,YAAYI,kBAAkBL,QAAQ,IAEtCC,YAAYK,OAEZL,YAAYM,UAAUhC,GAAGR,YAAYyC,MAAM,WACvC,IAAIrB,eAAiB,IAAInB,QAAQ,2DACjCC,WAAWQ,eAAeM,WAAYC,OAAQC,UACzCc,MAAK,WACFpC,EAAE,QAAQ8C,QAAQvC,gBAAgBwC,gBAAiB,CAAC3B,YAAY,GAEnE,IACAgB,KAAKZ,eAAewB,SACpBC,QAAO,WACJ/C,aAAagD,oBAChB,IACK,MAAChD,aAAaiD,UAC5B,IAEOb,WACX,IACCF,MAAK,SAASgB,OAGX,OAFA5B,eAAewB,UAERI,KACV,IACK,MAAClD,aAAaiD,WAqBhBE,CALiBpC,eAAeqC,KAAK,eACjCtC,OAAOuC,QAAQ/C,iBAAiBgD,WAAWC,aAAaC,QAAQtC,WACvDH,eAAeqC,KAAK,WAC7BtC,OAAOuC,QAAQ/C,iBAAiBgD,WAAWC,aAAaC,QAAQrC,OACrDJ,eAAeqC,KAAK,aAAetD,EAAEQ,iBAAiBmD,gBAAgBL,KAAK,aAG1FvC,EAAE6C,gBACN,KAqBAC,iBAXsB,SAASlD,MAC/BA,KAAKC,GAAG,QAASJ,iBAAiBK,QAAQiD,cAAc,SAAS/C,GAE7DN,eAAeqD,aAAanD,KAAMI,GAElCA,EAAE6C,gBACN,KAOR"}