{"version":3,"file":"booking_actions.min.js","sources":["../src/booking_actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module handles session booking and logentry operations\n * including CRUD and UI events.\n *\n * @module     local_booking/booking_actions\n * @author     Mustafa Hajjar (mustafa.hajjar)\n * @copyright  BAVirtual.co.uk Â© 2024\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/pending',\n    'core/notification',\n    'local_booking/booking_view_manager',\n    'local_booking/repository',\n    'local_booking/modal_actions',\n    'local_booking/events',\n    'local_booking/selectors',\n    ],\n    function(\n        $,\n        Pending,\n        Notification,\n        ViewManager,\n        Repository,\n        ModalActions,\n        BookingEvents,\n        Selectors,\n    ) {\n\n    /**\n     * Cancel a booking.\n     *\n     * @method  cancelBooking\n     * @param   {object} root\n     * @param   {object} e\n     */\n    function cancelBooking(root, e = null) {\n        const pendingPromise = new Pending('local_booking/registerCancelBookingForm'),\n            bookingRoot = $(Selectors.wrappers.bookingwrapper);\n\n        // Show loading icon in both mybookings and dashboard\n        ViewManager.startLoading(root);\n        ViewManager.startLoading(bookingRoot);\n\n        // Render the cancel booking confirmation modal form\n        ViewManager.renderCancelBookingConfirmation(e);\n\n        ViewManager.stopLoading(root);\n        ViewManager.stopLoading(bookingRoot);\n\n        pendingPromise.resolve();\n    }\n\n    /**\n     * Process a no-show session.\n     *\n     * @method  processNoShow\n     * @param   {object} root\n     * @param   {object} e\n     */\n    function processNoShow(root, e = null) {\n        const pendingPromise = new Pending('local_booking/registerNoShowWarningConfirmation'),\n            body = $('body'),\n            bookingRoot = $(Selectors.wrappers.bookingwrapper),\n            noshowButton = $(e.target).closest(Selectors.regions.noshowbutton),\n            noshows = noshowButton.data('noshows'),\n            bookingId = noshowButton.data('bookingid');\n\n        // Show no-show confirmation prompt\n        ModalActions.showWarning('commentnoshow' + noshows, 'commentnoshowtitle', {}, {\n            fromComponent: true,\n            buttonType: 'yesno'\n        });\n\n        // Listen to the confirmation before processing the no-show session and booking cancellation.\n        body.on(BookingEvents.responseYES, function() {\n\n            // Show loading icon in both mybookings and dashboard\n            ViewManager.startLoading(root);\n            ViewManager.startLoading(bookingRoot);\n\n            return Repository.cancelBooking(bookingId, null, true)\n            .then(function(response) {\n                if (response.result) {\n                    $('body').trigger(BookingEvents.noshowProcessed);\n                }\n                return;\n            })\n            .always(function() {\n                Notification.fetchNotifications();\n                ViewManager.stopLoading(root);\n                ViewManager.stopLoading(bookingRoot);\n                return;\n            })\n            .fail(Notification.exception);\n        });\n\n        pendingPromise.resolve();\n\n    }\n\n    /**\n     * Redirect to exercise (assignment) grading page.\n     *\n     * @method  gotoFeedback\n     * @param   {object} root\n     * @param   {object} e\n     */\n     function gotoFeedback(root, e) {\n        let Source = root.find(Selectors.logentryitem),\n            courseId, exerciseId, userId;\n\n        // Call redirect to assignment feedback page\n        if (Source.length !== 0) {\n            // Get from logentry modal\n            courseId = Source.data('courseId');\n            exerciseId = Source.data('exerciseId');\n            userId = Source.data('userId');\n        } else {\n            // Get from closest dashboard session clicked\n            Source = $(e.target).closest(Selectors.regions.session);\n            courseId = $(Selectors.wrappers.bookingwrapper).data('courseid');\n            exerciseId = Source.data('exerciseId');\n            userId = Source.data('studentId');\n        }\n\n        // Trigger redirect to feedback\n        $('body').trigger(BookingEvents.gotoFeedback, [exerciseId]);\n\n        // Redirect to the grading and feedback page\n        location.href = M.cfg.wwwroot + '/local/booking/assign.php?courseid=' + courseId +\n                '&exeid=' + exerciseId + '&rownum=0&userid=' + userId + '&passed=1';\n    }\n\n    return {\n        gotoFeedback: gotoFeedback,\n        cancelBooking: cancelBooking,\n        processNoShow: processNoShow,\n    };\n});\n"],"names":["define","$","Pending","Notification","ViewManager","Repository","ModalActions","BookingEvents","Selectors","gotoFeedback","root","e","courseId","exerciseId","userId","Source","find","logentryitem","length","data","target","closest","regions","session","wrappers","bookingwrapper","trigger","location","href","M","cfg","wwwroot","cancelBooking","pendingPromise","bookingRoot","startLoading","renderCancelBookingConfirmation","stopLoading","resolve","processNoShow","body","noshowButton","noshowbutton","noshows","bookingId","showWarning","fromComponent","buttonType","on","responseYES","then","response","result","noshowProcessed","always","fetchNotifications","fail","exception"],"mappings":";;;;;;;;;AAyBAA,uCAAO,CACH,SACA,eACA,oBACA,qCACA,2BACA,8BACA,uBACA,4BAEA,SACIC,EACAC,QACAC,aACAC,YACAC,WACAC,aACAC,cACAC,iBA4GG,CACHC,sBA3BmBC,KAAMC,OAErBC,SAAUC,WAAYC,OADtBC,OAASL,KAAKM,KAAKR,UAAUS,cAIX,IAAlBF,OAAOG,QAEPN,SAAWG,OAAOI,KAAK,YACvBN,WAAaE,OAAOI,KAAK,cACzBL,OAASC,OAAOI,KAAK,YAGrBJ,OAASd,EAAEU,EAAES,QAAQC,QAAQb,UAAUc,QAAQC,SAC/CX,SAAWX,EAAEO,UAAUgB,SAASC,gBAAgBN,KAAK,YACrDN,WAAaE,OAAOI,KAAK,cACzBL,OAASC,OAAOI,KAAK,cAIzBlB,EAAE,QAAQyB,QAAQnB,cAAcE,aAAc,CAACI,aAG/Cc,SAASC,KAAOC,EAAEC,IAAIC,QAAU,sCAAwCnB,SAChE,UAAYC,WAAa,oBAAsBC,OAAS,aAKhEkB,uBApGmBtB,UAAMC,yDAAI,WACvBsB,eAAiB,IAAI/B,QAAQ,2CAC/BgC,YAAcjC,EAAEO,UAAUgB,SAASC,gBAGvCrB,YAAY+B,aAAazB,MACzBN,YAAY+B,aAAaD,aAGzB9B,YAAYgC,gCAAgCzB,GAE5CP,YAAYiC,YAAY3B,MACxBN,YAAYiC,YAAYH,aAExBD,eAAeK,WAuFfC,uBA7EmB7B,UAAMC,yDAAI,WACvBsB,eAAiB,IAAI/B,QAAQ,mDAC/BsC,KAAOvC,EAAE,QACTiC,YAAcjC,EAAEO,UAAUgB,SAASC,gBACnCgB,aAAexC,EAAEU,EAAES,QAAQC,QAAQb,UAAUc,QAAQoB,cACrDC,QAAUF,aAAatB,KAAK,WAC5ByB,UAAYH,aAAatB,KAAK,aAGlCb,aAAauC,YAAY,gBAAkBF,QAAS,qBAAsB,GAAI,CAC1EG,eAAe,EACfC,WAAY,UAIhBP,KAAKQ,GAAGzC,cAAc0C,aAAa,kBAG/B7C,YAAY+B,aAAazB,MACzBN,YAAY+B,aAAaD,aAElB7B,WAAW2B,cAAcY,UAAW,MAAM,GAChDM,MAAK,SAASC,UACPA,SAASC,QACTnD,EAAE,QAAQyB,QAAQnB,cAAc8C,oBAIvCC,QAAO,WACJnD,aAAaoD,qBACbnD,YAAYiC,YAAY3B,MACxBN,YAAYiC,YAAYH,gBAG3BsB,KAAKrD,aAAasD,cAGvBxB,eAAeK"}