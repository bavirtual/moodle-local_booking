{"version":3,"sources":["../src/logbook_actions.js"],"names":["define","$","Notification","ModalFactory","ModalLogbookForm","LogbookEvents","BookingSelectors","Pending","registerEditListeners","root","eventFormModalPromise","pendingPromise","then","modal","on","editEvent","e","eventId","calendarWrapper","find","wrapper","setEventId","setContextId","data","show","stopImmediatePropagation","resolve","catch","exception","registerLogentryFormModal","eventFormPromise","create","type","TYPE","large","actions","progressionwrapper","exerciseId","setExerciseId","today","firstDay","day","length","setStartTime","setCourseId","fail","preventDefault","edit","target","currentTarget","closest","eventWrapper","eventItem"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module handles logbook entry add and edits\n *\n * @module     local_booking/logbook_actions\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/notification',\n    'core/modal_factory',\n    'local_booking/modal_logentry_form',\n    'local_booking/events',\n    'local_booking/selectors',\n    'core/pending',\n],\nfunction(\n    $,\n    Notification,\n    ModalFactory,\n    ModalLogbookForm,\n    LogbookEvents,\n    BookingSelectors,\n    Pending\n) {\n\n    /**\n     * Create the logbook form modal for creating new\n     * logbook entries and editing existing entries.\n     *\n     * @method registerLogentryFormModal\n     * @param {object} root The booking root element\n     * @return {object} The create modal promise\n     */\n    var registerLogentryFormModal = function(root) {\n        var eventFormPromise = ModalFactory.create({\n            type: ModalLogbookForm.TYPE,\n            large: true\n        });\n\n        // Bind click event on a graded session cell.\n        root.on('click', BookingSelectors.actions.create, function(e) {\n            eventFormPromise.then(function(modal) {\n                var wrapper = root.find(BookingSelectors.progressionwrapper);\n\n                var exerciseId = wrapper.data('exerciseid');\n                if (typeof exerciseId !== 'undefined') {\n                    modal.setExerciseId(exerciseId);\n                }\n\n                // Attempt to find the cell for today.\n                // If it can't be found, then use the start time of the first day on the calendar.\n                var today = root.find(BookingSelectors.today);\n                var firstDay = root.find(BookingSelectors.day);\n                if (!today.length && firstDay.length) {\n                    modal.setStartTime(firstDay.data('newEventTimestamp'));\n                }\n\n                modal.setContextId(wrapper.data('context-id'));\n                modal.setCourseId(wrapper.data('courseid'));\n                modal.show();\n                return;\n            })\n            .fail(Notification.exception);\n\n            e.preventDefault();\n        });\n\n        root.on('click', BookingSelectors.actions.edit, function(e) {\n            e.preventDefault();\n            var target = $(e.currentTarget),\n                calendarWrapper = target.closest(BookingSelectors.wrapper),\n                eventWrapper = target.closest(BookingSelectors.eventItem);\n\n            eventFormPromise.then(function(modal) {\n                // When something within the calendar tells us the user wants\n                // to edit an event then show the event form modal.\n                modal.setEventId(eventWrapper.data('eventId'));\n\n                modal.setContextId(calendarWrapper.data('contextId'));\n                modal.show();\n\n                e.stopImmediatePropagation();\n                return;\n            }).fail(Notification.exception);\n        });\n\n\n        return eventFormPromise;\n    };\n\n    /**\n     * Register the listeners required to edit the event.\n     *\n     * @param   {jQuery} root\n     * @param   {Promise} eventFormModalPromise\n     * @returns {Promise}\n     */\n    function registerEditListeners(root, eventFormModalPromise) {\n        var pendingPromise = new Pending('local_booking/logbook_actions:registerEditListeners');\n\n        return eventFormModalPromise\n        .then(function(modal) {\n            // When something within the calendar tells us the user wants\n            // to edit an event then show the event form modal.\n            $('body').on(LogbookEvents.editEvent, function(e, eventId) {\n                var calendarWrapper = root.find(BookingSelectors.wrapper);\n                modal.setEventId(eventId);\n                modal.setContextId(calendarWrapper.data('contextId'));\n                modal.show();\n\n                e.stopImmediatePropagation();\n            });\n            return modal;\n        })\n        .then(function(modal) {\n            pendingPromise.resolve();\n\n            return modal;\n        })\n        .catch(Notification.exception);\n    }\n\n    return {\n        registerEditListeners: registerEditListeners,\n        registerLogentryFormModal: registerLogentryFormModal\n    };\n});\n"],"file":"logbook_actions.min.js"}