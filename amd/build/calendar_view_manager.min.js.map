{"version":3,"sources":["../src/calendar_view_manager.js"],"names":["registerEventListeners","root","on","Selectors","links","navLink","e","wrapper","find","calendarwrapper","courseId","data","categoryId","link","currentTarget","changeWeek","href","dataset","year","week","time","preventDefault","viewSelector","CustomEvents","define","events","activate","option","target","classList","contains","courseid","categoryid","refreshWeekContent","then","window","history","pushState","fail","Notification","exception","template","startLoading","attr","M","util","js_pending","get","join","action","view","studentId","exerciseId","Date","now","Repository","getCalendarWeekData","context","viewingmonth","Templates","render","html","js","replaceNode","always","js_complete","SlotActions","setPasteState","setSaveButtonState","stopLoading","url","length","args","reloadCurrentMonth","loadingIconContainer","containers","loadingIcon","removeClass","one","addClass","init"],"mappings":"wrBAyBA,OACA,OACA,OACA,OACA,OACA,OACA,O,4lBAOOA,CAAAA,CAAsB,CAAG,SAACC,CAAD,CAAU,CACtCA,CAAI,CAAG,cAAEA,CAAF,CAAP,CAGAA,CAAI,CAACC,EAAL,CAAQ,OAAR,CAAiBC,CAAS,CAACC,KAAV,CAAgBC,OAAjC,CAA0C,SAACC,CAAD,CAAO,IACvCC,CAAAA,CAAO,CAAGN,CAAI,CAACO,IAAL,CAAUL,CAAS,CAACM,eAApB,CAD6B,CAEvCC,CAAQ,CAAGH,CAAO,CAACI,IAAR,CAAa,UAAb,CAF4B,CAGvCC,CAAU,CAAGL,CAAO,CAACI,IAAR,CAAa,YAAb,CAH0B,CAIvCE,CAAI,CAAGP,CAAC,CAACQ,aAJ8B,CAM7CC,CAAU,CAACd,CAAD,CAAOY,CAAI,CAACG,IAAZ,CAAkBH,CAAI,CAACI,OAAL,CAAaC,IAA/B,CAAqCL,CAAI,CAACI,OAAL,CAAaE,IAAlD,CAAwDN,CAAI,CAACI,OAAL,CAAaG,IAArE,CAA2EV,CAA3E,CAAqFE,CAArF,CAAV,CACAN,CAAC,CAACe,cAAF,EACH,CARD,EAUA,GAAMC,CAAAA,CAAY,CAAGrB,CAAI,CAACO,IAAL,CAAUL,CAAS,CAACmB,YAApB,CAArB,CACAC,UAAaC,MAAb,CAAoBF,CAApB,CAAkC,CAACC,UAAaE,MAAb,CAAoBC,QAArB,CAAlC,EACAJ,CAAY,CAACpB,EAAb,CACIqB,UAAaE,MAAb,CAAoBC,QADxB,CAEI,SAACpB,CAAD,CAAO,CACHA,CAAC,CAACe,cAAF,GAEA,GAAMM,CAAAA,CAAM,CAAGrB,CAAC,CAACsB,MAAjB,CACA,GAAID,CAAM,CAACE,SAAP,CAAiBC,QAAjB,CAA0B,QAA1B,CAAJ,CAAyC,CACrC,MACH,CAED,GAAMZ,CAAAA,CAAI,CAAGS,CAAM,CAACV,OAAP,CAAeC,IAA5B,CACIC,CAAI,CAAGQ,CAAM,CAACV,OAAP,CAAeE,IAD1B,CAEIC,CAAI,CAAGO,CAAM,CAACV,OAAP,CAAeG,IAF1B,CAGIV,CAAQ,CAAGiB,CAAM,CAACV,OAAP,CAAec,QAH9B,CAIInB,CAAU,CAAGe,CAAM,CAACV,OAAP,CAAee,UAJhC,CAMAC,CAAkB,CAAChC,CAAD,CAAOiB,CAAP,CAAaC,CAAb,CAAmBC,CAAnB,CAAyBV,CAAzB,CAAmCE,CAAnC,CAA+CX,CAA/C,CAAqD,6BAArD,CAAlB,CACKiC,IADL,CACU,UAAM,CACR,MAAOC,CAAAA,MAAM,CAACC,OAAP,CAAeC,SAAf,CAAyB,EAAzB,CAA6B,EAA7B,CAAiC,YAAjC,CACV,CAHL,EAGOC,IAHP,CAGYC,UAAaC,SAHzB,CAIH,CApBL,CAuBH,C,CAeaP,CAAkB,CAAG,SAAChC,CAAD,CAAOiB,CAAP,CAAaC,CAAb,CAAmBC,CAAnB,CAAyBV,CAAzB,CAAmCE,CAAnC,CAAgF,IAAjCgB,CAAAA,CAAiC,wDAAxB,IAAwB,CAAlBa,CAAkB,wDAAP,EAAO,CAC/GC,CAAY,CAACzC,CAAD,CAAZ,CAEA2B,CAAM,CAAGA,CAAM,EAAI3B,CAAI,CAACO,IAAL,CAAUL,CAAS,CAACM,eAApB,CAAnB,CACAgC,CAAQ,CAAGA,CAAQ,EAAIxC,CAAI,CAAC0C,IAAL,CAAU,eAAV,CAAvB,CACAC,CAAC,CAACC,IAAF,CAAOC,UAAP,CAAkB,CAAC7C,CAAI,CAAC8C,GAAL,CAAS,IAAT,CAAD,CAAiB7B,CAAjB,CAAuBC,CAAvB,CAA6BT,CAA7B,EAAuCsC,IAAvC,CAA4C,GAA5C,CAAlB,EAL+G,GAOzGC,CAAAA,CAAM,CAAGrB,CAAM,CAACjB,IAAP,CAAY,QAAZ,CAPgG,CAQzGuC,CAAI,CAAGtB,CAAM,CAACjB,IAAP,CAAY,SAAZ,EAAyB,KAAzB,CAAiC,MARiE,CASzGwC,CAAS,CAAGvB,CAAM,CAACjB,IAAP,CAAY,YAAZ,CAT6F,CAUzGyC,CAAU,CAAGxB,CAAM,CAACjB,IAAP,CAAY,aAAZ,CAV4F,CAW/GS,CAAI,CAAW,CAAR,EAAAA,CAAI,CAAQiC,IAAI,CAACC,GAAL,GAAa,GAArB,CAA4BlC,CAAvC,CAEA,MAAOmC,CAAAA,CAAU,CAACC,mBAAX,CAA+BtC,CAA/B,CAAqCC,CAArC,CAA2CC,CAA3C,CAAiDV,CAAjD,CAA2DE,CAA3D,CAAuEqC,CAAvE,CAA+EC,CAA/E,CAAqFC,CAArF,CAAgGC,CAAhG,EACFlB,IADE,CACG,SAAAuB,CAAO,CAAI,CACbA,CAAO,CAACC,YAAR,IACA,MAAOC,WAAUC,MAAV,CAAiBnB,CAAjB,CAA2BgB,CAA3B,CACV,CAJE,EAKFvB,IALE,CAKG,SAAC2B,CAAD,CAAOC,CAAP,CAAc,CAChB,MAAOH,WAAUI,WAAV,CAAsBnC,CAAtB,CAA8BiC,CAA9B,CAAoCC,CAApC,CACV,CAPE,EAQFE,MARE,CAQK,UAAM,CACVpB,CAAC,CAACC,IAAF,CAAOoB,WAAP,CAAmB,CAAChE,CAAI,CAAC8C,GAAL,CAAS,IAAT,CAAD,CAAiB7B,CAAjB,CAAuBC,CAAvB,CAA6BT,CAA7B,EAAuCsC,IAAvC,CAA4C,GAA5C,CAAnB,EACAkB,UAAYC,aAAZ,CAA0BlE,CAA1B,EACAiE,UAAYE,kBAAZ,CAA+BnE,CAA/B,CAAqCgD,CAArC,EACA,MAAOoB,CAAAA,CAAW,CAACpE,CAAD,CACrB,CAbE,EAcFqC,IAdE,CAcGC,UAAaC,SAdhB,CAeV,C,wBAcM,GAAMzB,CAAAA,CAAU,CAAG,SAACd,CAAD,CAAOqE,CAAP,CAAYpD,CAAZ,CAAkBC,CAAlB,CAAwBC,CAAxB,CAA8BV,CAA9B,CAAwCE,CAAxC,CAAuD,CAC7E,MAAOqB,CAAAA,CAAkB,CAAChC,CAAD,CAAOiB,CAAP,CAAaC,CAAb,CAAmBC,CAAnB,CAAyBV,CAAzB,CAAmCE,CAAnC,CAA+C,IAA/C,CAAqD,EAArD,CAAlB,CACFsB,IADE,CACG,UAAa,CACf,GAAIoC,CAAG,CAACC,MAAJ,EAAsB,GAAR,GAAAD,CAAlB,CAA+B,CAC3BnC,MAAM,CAACC,OAAP,CAAeC,SAAf,CAAyB,EAAzB,CAA6B,EAA7B,CAAiCiC,CAAjC,CACH,CAHc,2BAATE,CAAS,uBAATA,CAAS,iBAIf,MAAOA,CAAAA,CACV,CANE,CAOV,CARM,C,eAkBA,GAAMC,CAAAA,CAAkB,CAAG,SAACxE,CAAD,CAAwC,IAAjCS,CAAAA,CAAiC,wDAAtB,CAAsB,CAAnBE,CAAmB,wDAAN,CAAM,CAChEM,CAAI,CAAGjB,CAAI,CAACO,IAAL,CAAUL,CAAS,CAACM,eAApB,EAAqCE,IAArC,CAA0C,MAA1C,CADyD,CAEhEQ,CAAI,CAAGlB,CAAI,CAACO,IAAL,CAAUL,CAAS,CAACM,eAApB,EAAqCE,IAArC,CAA0C,MAA1C,CAFyD,CAGhES,CAAI,CAAGnB,CAAI,CAACO,IAAL,CAAUL,CAAS,CAACM,eAApB,EAAqCE,IAArC,CAA0C,MAA1C,CAHyD,CAKtED,CAAQ,CAAGA,CAAQ,EAAIT,CAAI,CAACO,IAAL,CAAUL,CAAS,CAACM,eAApB,EAAqCE,IAArC,CAA0C,UAA1C,CAAvB,CACAC,CAAU,CAAGA,CAAU,EAAIX,CAAI,CAACO,IAAL,CAAUL,CAAS,CAACM,eAApB,EAAqCE,IAArC,CAA0C,YAA1C,CAA3B,CAEA,MAAOsB,CAAAA,CAAkB,CAAChC,CAAD,CAAOiB,CAAP,CAAaC,CAAb,CAAmBC,CAAnB,CAAyBV,CAAzB,CAAmCE,CAAnC,CAA+C,IAA/C,CAAqD,EAArD,CAC5B,CATM,C,uBAiBC,GAAM8B,CAAAA,CAAY,CAAG,SAACzC,CAAD,CAAU,CACnC,GAAMyE,CAAAA,CAAoB,CAAGzE,CAAI,CAACO,IAAL,CAAUL,CAAS,CAACwE,UAAV,CAAqBC,WAA/B,CAA7B,CACAF,CAAoB,CAACG,WAArB,CAAiC,QAAjC,EAEA,cAAE5E,CAAF,EAAQ6E,GAAR,CAAY,QAAZ,CAAsB,UAAW,CAC7B,cAAE,IAAF,EAAQtE,IAAR,CAAa,wBAAb,EAAqCmC,IAArC,CAA0C,UAA1C,CAAsD,UAAtD,CACH,CAFD,CAGH,CAPO,C,iBAeD,GAAM0B,CAAAA,CAAW,CAAG,SAACpE,CAAD,CAAU,CACjC,GAAMyE,CAAAA,CAAoB,CAAGzE,CAAI,CAACO,IAAL,CAAUL,CAAS,CAACwE,UAAV,CAAqBC,WAA/B,CAA7B,CACAF,CAAoB,CAACK,QAArB,CAA8B,QAA9B,EAEA,cAAE9E,CAAF,EAAQ6E,GAAR,CAAY,QAAZ,CAAsB,UAAW,CAC7B,cAAE,IAAF,EAAQtE,IAAR,CAAa,wBAAb,EAAqCmC,IAArC,CAA0C,SAA1C,CAAqD,SAArD,CACH,CAFD,CAGH,CAPM,C,uBASa,QAAPqC,CAAAA,IAAO,CAAC/E,CAAD,CAAOiD,CAAP,CAAgB,CAChClD,CAAsB,CAACC,CAAD,CAAOiD,CAAP,CACzB,C","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module to handler booking view changes.\n * Improvised from core_calendar.\n *\n * @module     local_booking/calendar_view_manager\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport CustomEvents from 'core/custom_interaction_events';\nimport SlotActions from 'local_booking/slot_actions';\nimport * as Repository from 'local_booking/repository';\nimport * as Selectors from 'local_booking/selectors';\n\n/**\n * Register event listeners for the module.\n *\n * @param {object} root The root element.\n */\n const registerEventListeners = (root) => {\n    root = $(root);\n\n    // Process previous/next week navigation links\n    root.on('click', Selectors.links.navLink, (e) => {\n        const wrapper = root.find(Selectors.calendarwrapper);\n        const courseId = wrapper.data('courseid');\n        const categoryId = wrapper.data('categoryid');\n        const link = e.currentTarget;\n\n        changeWeek(root, link.href, link.dataset.year, link.dataset.week, link.dataset.time, courseId, categoryId);\n        e.preventDefault();\n    });\n\n    const viewSelector = root.find(Selectors.viewSelector);\n    CustomEvents.define(viewSelector, [CustomEvents.events.activate]);\n    viewSelector.on(\n        CustomEvents.events.activate,\n        (e) => {\n            e.preventDefault();\n\n            const option = e.target;\n            if (option.classList.contains('active')) {\n                return;\n            }\n\n            const year = option.dataset.year,\n                week = option.dataset.week,\n                time = option.dataset.time,\n                courseId = option.dataset.courseid,\n                categoryId = option.dataset.categoryid;\n\n            refreshWeekContent(root, year, week, time, courseId, categoryId, root, 'local_booking/calendar_week')\n                .then(() => {\n                    return window.history.pushState({}, '', '?view=user');\n                }).fail(Notification.exception);\n        }\n    );\n\n};\n\n/**\n * Refresh the week content.\n *\n * @param {object} root The root element.\n * @param {number} year Year\n * @param {number} week week\n * @param {number} time The timestamp of the begining current week\n * @param {number} courseId The id of the course associated with the calendar shown\n * @param {number} categoryId The id of the category associated with the calendar shown\n * @param {object} target The element being replaced. If not specified, the calendarwrapper is used.\n * @param {string} template The template to be rendered.\n * @return {promise}\n */\n export const refreshWeekContent = (root, year, week, time, courseId, categoryId, target = null, template = '') => {\n    startLoading(root);\n\n    target = target || root.find(Selectors.calendarwrapper);\n    template = template || root.attr('data-template');\n    M.util.js_pending([root.get('id'), year, week, courseId].join('-'));\n\n    const action = target.data('action');\n    const view = target.data('viewall') ? 'all' : 'user';\n    const studentId = target.data('student-id');\n    const exerciseId = target.data('exercise-id');\n    time = time == 0 ? Date.now() / 1000 : time;\n\n    return Repository.getCalendarWeekData(year, week, time, courseId, categoryId, action, view, studentId, exerciseId)\n        .then(context => {\n            context.viewingmonth = true;\n            return Templates.render(template, context);\n        })\n        .then((html, js) => {\n            return Templates.replaceNode(target, html, js);\n        })\n        .always(() => {\n            M.util.js_complete([root.get('id'), year, week, courseId].join('-'));\n            SlotActions.setPasteState(root);\n            SlotActions.setSaveButtonState(root, action);\n            return stopLoading(root);\n        })\n        .fail(Notification.exception);\n};\n\n/**\n * Handle changes to the current calendar view.\n *\n * @param {object} root The container element\n * @param {string} url The calendar url to be shown\n * @param {number} year Year\n * @param {number} week week\n * @param {number} time The timestamp of the begining current week\n * @param {number} courseId The id of the course associated with the calendar shown\n * @param {number} categoryId The id of the category associated with the calendar shown\n * @return {promise}\n */\nexport const changeWeek = (root, url, year, week, time, courseId, categoryId) => {\n    return refreshWeekContent(root, year, week, time, courseId, categoryId, null, '')\n        .then((...args) => {\n            if (url.length && url !== '#') {\n                window.history.pushState({}, '', url);\n            }\n            return args;\n        });\n};\n\n/**\n * Reload the current month view data.\n *\n * @param {object} root The container element.\n * @param {number} courseId The id of the course associated with the calendar shown\n * @param {number} categoryId The id of the category associated with the calendar shown\n * @return {promise}\n */\nexport const reloadCurrentMonth = (root, courseId = 0, categoryId = 0) => {\n    const year = root.find(Selectors.calendarwrapper).data('year');\n    const week = root.find(Selectors.calendarwrapper).data('week');\n    const time = root.find(Selectors.calendarwrapper).data('time');\n\n    courseId = courseId || root.find(Selectors.calendarwrapper).data('courseid');\n    categoryId = categoryId || root.find(Selectors.calendarwrapper).data('categoryid');\n\n    return refreshWeekContent(root, year, week, time, courseId, categoryId, null, '');\n};\n\n/**\n * Set the element state to loading.\n *\n * @param {object} root The container element\n * @method startLoading\n */\n export const startLoading = (root) => {\n    const loadingIconContainer = root.find(Selectors.containers.loadingIcon);\n    loadingIconContainer.removeClass('hidden');\n\n    $(root).one('submit', function() {\n        $(this).find('input[type=\"submit\"]').attr('disabled', 'disabled');\n    });\n};\n\n/**\n * Remove the loading state from the element.\n *\n * @param {object} root The container element\n * @method stopLoading\n */\nexport const stopLoading = (root) => {\n    const loadingIconContainer = root.find(Selectors.containers.loadingIcon);\n    loadingIconContainer.addClass('hidden');\n\n    $(root).one('submit', function() {\n        $(this).find('input[type=\"submit\"]').attr('enabled', 'enabled');\n    });\n};\n\nexport const init = (root, view) => {\n    registerEventListeners(root, view);\n};"],"file":"calendar_view_manager.min.js"}