{"version":3,"file":"modal_actions.min.js","sources":["../src/modal_actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module handles additional logentry modal form action.\n *\n * @module     local_booking/modal_actions\n * @author     Mustafa Hajjar (mustafa.hajjar)\n * @copyright  BAVirtual.co.uk Â© 2024\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport * as Str from 'core/str';\nimport Notification from 'core/notification';\nimport ModalEvents from 'core/modal_events';\nimport Pending from 'core/pending';\nimport Repository from 'local_booking/repository';\nimport ModalDelete from 'local_booking/modal_delete';\nimport ModalWarning from 'local_booking/modal_warning';\nimport BookingSessions from 'local_booking/events';\nimport BookingActions from 'local_booking/booking_actions';\nimport Selectors from 'local_booking/selectors';\n\n/**\n * Prepares the action for the summary modal's delete action.\n *\n * @method  confirmDeletion\n * @param   {Number} logentryId The ID of the logentry.\n * @param   {Number} userId   The user of the logentry.\n * @param   {Number} courseId The course of the logentry.\n * @param   {bool}   cascade  Whether to cascade delete linked logentries.\n * @return  {Promise}\n */\nexport const confirmDeletion = (logentryId, userId, courseId, cascade) => {\n\n    let pendingPromise = new Pending('local_booking/booking_actions:confirmDeletion');\n    let deleteStrings = [\n        {\n            key: 'deletelogentry',\n            component: 'local_booking'\n        },\n    ];\n\n    let deletePromise;\n    deleteStrings.push({\n        key: 'confirmlogentrydelete',\n        component: 'local_booking'\n    });\n\n\n    deletePromise = ModalDelete.create();\n\n    let stringsPromise = Str.get_strings(deleteStrings);\n\n    // Setup modal delete prompt form\n    let finalPromise = $.when(stringsPromise, deletePromise)\n        .then(function(strings, deleteModal) {\n            deleteModal.setRemoveOnClose(true);\n            deleteModal.setTitle(strings[0]);\n            deleteModal.setBody(strings[1]);\n\n            deleteModal.show();\n\n            deleteModal.getRoot().on(ModalEvents.save, function () {\n                let pendingPromise = new Pending('local_booking/booking_actions:initModal:deletedlogentry');\n                // eslint-disable-next-line promise/no-nesting\n                Repository.deleteLogentry(logentryId, userId, courseId, cascade)\n                    .then(function() {\n                        $('body').trigger(BookingSessions.logentryDeleted, [logentryId, false]);\n                        return;\n                    })\n                    .then(pendingPromise.resolve)\n                    .always(function() {\n                        Notification.fetchNotifications();\n                    })\n                    .catch(Notification.exception);\n            });\n\n            return deleteModal;\n        })\n        .then(function(modal) {\n            pendingPromise.resolve();\n\n            return modal;\n        })\n        .catch(Notification.exception);\n\n    return finalPromise;\n};\n\n/**\n * Displays a warning modal with the specified message and title.\n *\n * @param {string} message - The message to display in the modal.\n * @param {string} title - The title of the modal.\n * @param {Object} [data={}] - Additional data to pass to the modal.\n * @param {Object} [options=null] - Options to customize the modal.\n * @param {string} [options.buttonType='ok'] - The type of buttons to display ('ok' or 'yesno').\n * @param {string} [options.buttonDefault='ok'] - The default button ('ok' or 'no').\n * @param {boolean} [options.stopExecution=true] - Whether to stop execution.\n * @param {string|null} [options.customEvent=null] - Custom event to trigger.\n * @param {boolean} [options.fromComponent=false] - Whether the warning is from a component.\n * @returns {Promise} - A promise that resolves when the modal is shown.\n */\nexport const showWarning = (message, title, data = {}, options = null) => {\n\n    title ??= 'wanringtitle';\n    options ??= {};\n    options.buttonType ??= 'ok';\n    options.buttonDefault ??= 'ok';\n    options.stopExecution ??= true;\n    options.customEvent ??= null;\n\n    // Setup modal footer\n    let footer = '<button type=\"button\" class=\"btn btn-primary\" data-action=\"ok\">Ok</button>';\n    if (options.buttonType == 'yesno') {\n        footer = '<button type=\"button\" class=\"btn ' + (options.buttonDefault == 'no' ?\n            'btn-primary' : 'btn-secondary') + '\" data-action=\"no\">No</button>';\n        footer += '<button type=\"button\" class=\"btn ' + (options.buttonDefault != 'no' ?\n            'btn-primary' : 'btn-secondary') + '\" data-action=\"yes\">Yes</button>';\n    }\n\n    let pendingPromise = new Pending('local_booking/booking_actions:showWarning');\n    let warningPromise = ModalWarning.create();\n    let stringsPromise, finalPromise;\n    let warningStrings = [{}];\n\n    /**\n     * Setup modal warning prompt form\n     * @param {Array} warningStrings - The warning strings to display.\n     */\n    async function setupModalWarningPromptForm(warningStrings) {\n        try {\n            if (options.fromComponent) {\n                // Add title and message to the warning strings\n                warningStrings = [{key: title, component: 'local_booking'}];\n                warningStrings.push({key: message, component: 'local_booking', param: data});\n\n                // Get strings for the warning modal\n                stringsPromise = Str.get_strings(warningStrings);\n            }\n\n            const warningModal = await warningPromise;\n\n            if (stringsPromise) {\n                const strings = await stringsPromise;\n                title = strings[0];\n                message = strings[1];\n            }\n\n            warningModal.setRemoveOnClose(true);\n            warningModal.setTitle(title);\n            warningModal.setBody(message);\n            warningModal.setData(data);\n            warningModal.setCustomEvent(options.customEvent);\n            warningModal.setFooter(footer);\n            warningModal.show();\n\n            pendingPromise.resolve();\n            return warningModal;\n        } catch (error) {\n            Notification.exception(error);\n        }\n        return null;\n    }\n\n    // Call the async function\n    setupModalWarningPromptForm(warningStrings);\n\n    return finalPromise;\n};\n\n/**\n * Register the listeners required to delete the logentry.\n *\n * @method  registerDelete\n * @param   {jQuery} root\n */\nexport const registerDelete = (root) => {\n\n    root.on('click', Selectors.actions.deleteLogentry, function(e) {\n        // Fetch the logentry title, and pass them into the new dialogue.\n        const target = e.target;\n        let logentrySource = root.find(Selectors.logentryitem),\n            logentryId = logentrySource.data('logentryId') ||\n                target.closest(Selectors.containers.summaryForm).dataset.logentryId,\n            userId = logentrySource.data('userId') || target.closest(Selectors.containers.summaryForm).dataset.userId,\n            courseId = logentrySource.data('courseId') || $(Selectors.wrappers.logbookwrapper).data('courseid'),\n            cascade = logentrySource.data('cascade') || target.closest(Selectors.containers.summaryForm).dataset.cascade;\n\n        confirmDeletion(logentryId, userId, courseId, cascade);\n\n        e.preventDefault();\n    });\n};\n\n/**\n * Register the listeners required to redirect to\n * exercise (assignment) grading page.\n *\n * @method  registerRedirect\n * @param   {jQuery} root\n */\nexport const registerRedirect = function(root) {\n    root.on('click', Selectors.actions.gotoFeedback, function(e) {\n        // Call redirect to assignment feedback page\n        BookingActions.gotoFeedback(root, e);\n\n        e.preventDefault();\n    });\n};\n"],"names":["confirmDeletion","logentryId","userId","courseId","cascade","deletePromise","pendingPromise","Pending","deleteStrings","key","component","push","ModalDelete","create","stringsPromise","Str","get_strings","$","when","then","strings","deleteModal","setRemoveOnClose","setTitle","setBody","show","getRoot","on","ModalEvents","save","deleteLogentry","trigger","BookingSessions","logentryDeleted","resolve","always","fetchNotifications","catch","Notification","exception","modal","message","title","data","options","buttonType","buttonDefault","stopExecution","customEvent","footer","finalPromise","warningPromise","ModalWarning","warningStrings","setupModalWarningPromptForm","fromComponent","param","warningModal","setData","setCustomEvent","setFooter","error","root","Selectors","actions","e","target","logentrySource","find","logentryitem","closest","containers","summaryForm","dataset","wrappers","logbookwrapper","preventDefault","gotoFeedback"],"mappings":"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"}