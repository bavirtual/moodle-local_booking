/**
 * Controls the message preference page.
 *
 * @module     local_booking/administration
 * @author     Mustafa Hajjar (mustafa.hajjar)
 * @copyright  BAVirtual.co.uk Â© 2023
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_booking/user_profile",["jquery","core/str","core/notification","local_booking/repository","local_booking/selectors"],(function($,Str,Notification,Repository,Selectors){const processUserPreference=function(preference,value,courseId,userId,element){return Repository.setUserPreferences(preference,value,courseId,userId).then((function(result){return result.saved})).always((function(){Notification.fetchNotifications()})).fail((function(ex){return Notification.exception(ex),$("#"+element).prop("checked",!$("#"+element).prop("checked")),!0}))},processSetting=function(courseId,userId,key,value,root){let response;switch(startLoading($("#"+key+"-region")),key){case"endorse":response=function(courseId,userId,endorse,root){let userProfile=root.find(Selectors.userprofilewrapper),endorsername=userProfile.data("endorsername"),endorser=userProfile.data("endorser"),endorsedate=new Date,endorsedon=endorsedate.toDateString(),endorsedatets=Math.round(endorsedate.getTime()/1e3),endorsestr=endorse?"endorsementmgs":"skilltestendorse",endorsemsgPromise=Str.get_string(endorsestr,"local_booking",{endorser:endorsername,endorsedate:endorsedon});endorsemsgPromise.then((function(message){return $("#endorsement-label").html(message),endorse?$("#endorsement-letter").removeClass("hidden"):$("#endorsement-letter").addClass("hidden"),message})).fail(Notification.exception);let result=0!==endorsemsgPromise.trim().length;return result&=processUserPreference("endorse",endorse,courseId,userId,"endorse"),result&=processUserPreference("endorser",endorse?endorser:"",courseId,userId,"endorse"),result&=processUserPreference("endorsedate",endorse?endorsedatets:"",courseId,userId,"endorse"),result&=processUserPreference("endorsenotify",endorse,courseId,userId,"endorse"),result}(courseId,userId,value,root);break;case"xcoursebookings":response=processUserPreference(key,value,1,userId,key);break;case"availabilityoverride":response=processUserPreference(key,value,courseId,userId,key);break;case"suspend":response=function(suspend,courseId,userId){return Repository.updateSuspendedStatus(suspend,courseId,userId).then().always((function(){Notification.fetchNotifications()})).fail((function(ex){return Notification.exception(ex),$("#suspended").prop("checked",!$("#suspended").prop("checked")),!0}))}(value,courseId,userId);break;case"onhold":case"keepactive":response=function(key,add,courseId,userId,root){const groupName=root.find(Selectors.userprofilewrapper).data(key+"group");return Repository.groupAddRemove(courseId,userId,groupName,add).then((function(response){return response.result})).always((function(){Notification.fetchNotifications()})).fail((function(ex){return Notification.exception(ex),$("#"+key).prop("checked",!$("#"+key).prop("checked")),!1}))}(key,value,courseId,userId,root)}return stopLoading($("#"+key+"-region")),response},registerEventListeners=function(root){var userProfile=root.find(Selectors.userprofilewrapper),courseId=userProfile.data("courseid"),userId=userProfile.data("userid");$("#endorse").click((function(){processSetting(courseId,userId,"endorse",this.checked,root)})),$("#suspended").click((function(){processSetting(courseId,userId,"suspend",this.checked)})),$("#onhold").click((function(){processSetting(courseId,userId,"onhold",this.checked,root).then((response=>0===response||($("#keepactive").prop("checked",!this.checked),processSetting(courseId,userId,"keepactive",!this.checked,root)))).fail(Notification.exception)})),$("#keepactive").click((function(){processSetting(courseId,userId,"keepactive",this.checked,root)})),$("#availabilityoverride").click((function(){processSetting(courseId,userId,"availabilityoverride",this.checked,root)})),$("#xcoursebookings").click((function(){processSetting(courseId,userId,"xcoursebookings",this.checked,root)})),$("#save_comment_button").click((function(){!function(courseId,userId,root){startLoading(root);const comment=$("#comment").val();Repository.updateProfileComment(courseId,userId,comment).then((function(response){let result=response.result;return Str.get_string(result?"commentsaved":"commentnotsaved","local_booking").then((function(string){return $("#status").addClass("comment-status-"+(result?"success":"error")),$("#status").removeClass("comment-status-"+(result?"error":"success")),$("#status").text(string).slideDown(1e3).delay(2e3).slideUp(1e3),!0})).fail(Notification.exception),!1})).always((function(){Notification.fetchNotifications(),stopLoading(root)})).fail(Notification.exception)}(courseId,userId,root)}))},startLoading=root=>{root.find(Selectors.containers.loadingIcon).removeClass("hidden")},stopLoading=root=>{root.find(Selectors.containers.loadingIcon).addClass("hidden")};return{init:function(root){root=$(root),registerEventListeners(root)}}}));

//# sourceMappingURL=user_profile.min.js.map