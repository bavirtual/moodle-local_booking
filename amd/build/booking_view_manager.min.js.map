{"version":3,"file":"booking_view_manager.min.js","sources":["../src/booking_view_manager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module handles session booking and logentry view changes.\n *\n * @module     local_booking/booking_view_manager\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport * as Str from 'core/str';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport ModalLogentrySummaryForm from 'local_booking/modal_logentry_summary';\nimport * as Repository from 'local_booking/repository';\nimport * as Selectors from 'local_booking/selectors';\n\n/**\n * Refresh student progression, mybookings, and myassignees content.\n *\n * @method  refreshBookingsContent\n * @param   {object} root The root element.\n * @param   {number} courseId The id of the course associated with the progression view shown\n * @param   {number} categoryId The id of the category associated with the progression view shown\n * @param   {object} target The element being replaced. If not specified, the bookingwrapper is used.\n * @param   {string} filter The filter to show students, inactive (including graduates), suspended, and default to active.\n * @return  {promise}\n */\nexport const refreshBookingsContent = (root, courseId, categoryId, target = null, filter = null) => {\n    startLoading(root);\n\n    const template = root.attr('data-template'),\n        mybookingstarget = root.find(Selectors.mybookingswrapper);\n    target = target || root.find(Selectors.bookingwrapper);\n    courseId = courseId || root.find(Selectors.bookingwrapper).data('courseid');\n    filter = filter || 'active';\n    var bookingsContext;\n    M.util.js_pending([root.get('id'), courseId, categoryId].join('-'));\n    return Repository.getBookingsData(courseId, filter)\n        .then((context) => {\n            bookingsContext = context;\n            return Templates.render(template, context);\n        })\n        .then((html, js) => {\n            return Templates.replaceNode(target, html, js);\n        })\n        .then(() => {\n            return Templates.render('local_booking/my_bookings', bookingsContext);\n        })\n        .then((html, js) => {\n            return Templates.replaceNode(mybookingstarget, html, js);\n        })\n        .always(() => {\n            M.util.js_complete([root.get('id'), courseId, categoryId].join('-'));\n            return stopLoading(root);\n        })\n        .fail(Notification.exception);\n};\n\n/**\n * Render the logentry new/edit modal.\n *\n * @method  renderLogentryModal\n * @param   {object} root       The container element\n * @param   {object} e          The triggered event.\n * @param   {Number} LogentryFormPromise  The Logentry form promise.\n * @param   {object} target     The target element.\n * @param   {Number} contextId  The course context id of the logentry.\n * @param   {number} courseId   The graded session course id.\n * @param   {number} userId     The graded session user id.\n * @param   {number} logentryId The graded session logbook entry id.\n * @param   {bool}   isNew      Whether the render is for edit.\n * @param   {string} template   The source template for edits.\n * @returns {promise}\n */\n export const renderLogentryModal = (root, e, LogentryFormPromise, target, contextId, courseId,\n    userId, logentryId, isNew, template) => {\n    const pendingPromise = new Pending('local_booking/booking_view_manager:renderLogentryModal');\n\n    return LogentryFormPromise\n    .then(function(modal) {\n        // Show the logentry form modal form when the user clicks on a session\n        // in the 'Instructor dashboard' page to add or edit a logentry\n        LogentryFormPromise.then(function(modal) {\n            var logegntrySession, flightDate, exerciseId, flightType, findpirepenabled;\n\n            // Sel elements not meant for new or additional logentries\n            if (isNew) {\n                // From booking_session_exporter\n                logegntrySession = target.closest(Selectors.actions.viewLogEntry);\n                flightDate = logegntrySession.dataset.flightDate;\n                exerciseId = logegntrySession.dataset.exerciseId;\n                flightType = logegntrySession.dataset.flightType;\n                findpirepenabled = $(Selectors.bookingwrapper).data('findpirep');\n            } else {\n                if (template == 'local_booking/logbook_std') {\n                    // From logbook\n                    let logegntrySession = target.closest(Selectors.containers.summaryForm);\n                    flightDate = logegntrySession.dataset.flightDate;\n                    exerciseId = logegntrySession.dataset.exerciseId;\n                    flightType = logegntrySession.dataset.flightType;\n                } else {\n                    // From get_logentry_view\n                    logegntrySession = root.find(Selectors.containers.summaryForm);\n                    flightDate = logegntrySession.data('flight-date');\n                    exerciseId = logegntrySession.data('exercise-id');\n                    flightType = logegntrySession.data('flight-type');\n                    findpirepenabled = logegntrySession.data('find-pirep');\n                }\n            }\n\n            // Set form properties\n            modal.setContextId(contextId);\n            modal.setCourseId(courseId);\n            modal.setUserId(userId);\n            modal.setLogentryId(logentryId);\n            modal.setExerciseId(exerciseId);\n            modal.setFlightDate(flightDate);\n            modal.setFlightType(flightType);\n            modal.hasFindPIREP(findpirepenabled);\n\n            // Handle hidden event.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                // Destroy when hidden.\n                modal.destroy();\n            });\n\n            modal.show();\n            e.stopImmediatePropagation();\n            return;\n        })\n        .fail(Notification.exception);\n        return modal;\n    })\n    .then(function(modal) {\n        pendingPromise.resolve();\n        return modal;\n    })\n    .catch(Notification.exception);\n };\n\n/**\n * Render the logentry summary modal.\n *\n * @method  renderLogentrySummaryModal\n * @param   {number} courseId The graded session course id.\n * @param   {number} userId The graded session user id.\n * @param   {number} logentryId The graded session logbook entry id.\n * @returns {promise}\n */\n export const renderLogentrySummaryModal = (courseId, userId, logentryId) => {\n    const pendingPromise = new Pending('local_booking/booking_view_manager:renderLogentrySummaryModal');\n\n    // Booking repository promise.\n    return Repository.getLogentryById(logentryId, courseId, userId)\n    .then((getEventResponse) => {\n        if (!getEventResponse.logentry) {\n            throw new Error(Str.get_string('errorlogentryfetch', 'local_booking') + logentryId);\n        }\n\n        return getEventResponse.logentry;\n    })\n    .then(logentryData => {\n        // Build the modal parameters from the logentry data.\n        const modalParams = {\n            title: Str.get_string('logentry', 'local_booking'),\n            type: ModalLogentrySummaryForm.TYPE,\n            body: Templates.render('local_booking/logentry_summary_body', logentryData)\n        };\n\n        // Create the modal.\n        return ModalFactory.create(modalParams);\n    })\n    .then(modal => {\n        // Handle hidden event.\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            // Destroy when hidden.\n            modal.destroy();\n        });\n        // Finally, render the modal!\n        modal.show();\n\n        return modal;\n    })\n    .then(modal => {\n        pendingPromise.resolve();\n\n        return modal;\n    })\n    .catch(Notification.exception);\n};\n\n/**\n * Set the element state to loading.\n *\n * @method  startLoading\n * @param   {object} root The container element\n */\n export const startLoading = (root) => {\n    const loadingIconContainer = root.find(Selectors.containers.loadingIcon);\n    loadingIconContainer.removeClass('hidden');\n\n    $(root).one('submit', function() {\n        $(this).find('input[type=\"submit\"]').attr('disabled', 'disabled');\n    });\n};\n\n/**\n * Remove the loading state from the element.\n *\n * @method  stopLoading\n * @param   {object} root The container element\n */\nexport const stopLoading = (root) => {\n    const loadingIconContainer = root.find(Selectors.containers.loadingIcon);\n    loadingIconContainer.addClass('hidden');\n\n    $(root).one('submit', function() {\n        $(this).find('input[type=\"submit\"]').attr('enabled', 'enabled');\n    });\n};\n"],"names":["_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireWildcard","obj","__esModule","_typeof","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireDefault","default","_jquery","Str","_templates","_notification","_pending","_modal_factory","_modal_events","_modal_logentry_summary","Repository","Selectors","_exports","refreshBookingsContent","root","courseId","categoryId","target","arguments","length","undefined","filter","startLoading","bookingsContext","template","attr","mybookingstarget","find","mybookingswrapper","bookingwrapper","data","M","util","js_pending","join","getBookingsData","then","context","Templates","render","html","js","replaceNode","always","js_complete","stopLoading","fail","Notification","exception","renderLogentryModal","e","LogentryFormPromise","contextId","userId","logentryId","isNew","pendingPromise","Pending","modal","logegntrySession","flightDate","exerciseId","flightType","findpirepenabled","closest","actions","viewLogEntry","dataset","$","containers","summaryForm","setContextId","setCourseId","setUserId","setLogentryId","setExerciseId","setFlightDate","setFlightType","hasFindPIREP","getRoot","on","ModalEvents","hidden","destroy","show","stopImmediatePropagation","resolve","renderLogentrySummaryModal","getLogentryById","getEventResponse","logentry","Error","get_string","logentryData","modalParams","title","type","ModalLogentrySummaryForm","TYPE","body","ModalFactory","create","loadingIcon","removeClass","one","this","addClass"],"mappings":"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"}