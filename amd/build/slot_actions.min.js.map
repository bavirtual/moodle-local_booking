{"version":3,"file":"slot_actions.min.js","sources":["../src/slot_actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Contain the logic for the quick add or update event modal.\n *\n * @module     local_booking/slot_actions\n * @author     Mustafa Hajjar (mustafa.hajjar)\n * @copyright  BAVirtual.co.uk Â© 2024\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/notification',\n    'core/pending',\n    'local_booking/repository',\n    'local_booking/calendar_view_manager',\n    'local_booking/modal_actions',\n    'local_booking/selectors',\n    ],\n    function(\n        $,\n        Notification,\n        Pending,\n        Repository,\n        CalendarViewManager,\n        ModalActions,\n        Selectors,\n    ) {\n\n    var Slots = [];\n    var BookedSlots = [];\n    var SlotIndexes = [];\n    let postActive = false;\n    let formSaved = true;\n\n    /**\n     * Save marked availability posts.\n     *\n     * @method saveWeekSlots\n     * @param {object} root The calendar root element\n     * @return {object} The create modal promise\n     */\n    function saveWeekSlots(root) {\n\n        CalendarViewManager.startLoading(root);\n\n        // Get year and week\n        const course = root.find(Selectors.wrappers.calendarwrapper).data('courseid');\n        const year = root.find(Selectors.wrappers.calendarwrapper).data('year');\n        const week = root.find(Selectors.wrappers.calendarwrapper).data('week');\n        const minslotperiod = root.find(Selectors.wrappers.calendarwrapper).data('minslotperiod');\n        const unixTsHr = 3600;\n        const lastMinute = 60;\n\n        // Get marked availability slots\n        getSlots(root);\n\n        // Evaluate each slot to ensure it is a minimum of 2hrs if minimum slots is required (minslotperiod!=0)\n        let minSlotPeriodMet = true;\n        $.map( Slots, function(val) {\n            if ((val.endtime - val.starttime + lastMinute) < (minslotperiod * unixTsHr) && minslotperiod != 0) {\n                minSlotPeriodMet = false;\n            }\n        });\n\n        if (minSlotPeriodMet) {\n            let serverCall = null;\n            if (Slots.length != 0) {\n                serverCall = Repository.saveSlots(Slots, course, year, week);\n            } else {\n                serverCall = Repository.clearSlots(course, year, week);\n            }\n\n            // Send a request to the server to clear slots.\n            return serverCall\n                .then(function(response) {\n                    if (response.validationerror) {\n                        // eslint-disable-next-line no-alert\n                        alert('Errors encountered: Unable to process availability posting action!');\n                    }\n                    formSaved = true;\n                    return;\n                })\n                .always(function() {\n                    Notification.fetchNotifications();\n                    return CalendarViewManager.stopLoading(root);\n                })\n                .fail(Notification.exception);\n        } else {\n            // Show warning message\n            CalendarViewManager.stopLoading(root);\n            ModalActions.showWarning('warnminslotperiod', minslotperiod);\n            return false;\n        }\n    }\n\n    /**\n     * Save marked booking posts.\n     *\n     * @method saveBookedSlot\n     * @param {object} root The calendar root element\n     * @return {object} The create modal promise\n     */\n     async function saveBookedSlot(root) {\n\n            CalendarViewManager.startLoading(root);\n\n            // Get exercise id and the user id from the URL\n            const course = $(Selectors.wrappers.calendarwrapper).data('courseid');\n            const exercise = $(Selectors.wrappers.calendarwrapper).data('exercise-id');\n            const studentid = $(Selectors.wrappers.calendarwrapper).data('student-id');\n\n            // Get marked availability slots\n            getSlots(root, 'book');\n\n            // Check if the instructor has conflicting bookings\n            const pendingPromise = new Pending('local_booking/hasConflictingBooking');\n            if (Array.isArray(BookedSlots) && BookedSlots.length === 1) {\n                let hasConflictingBooking = await Repository.hasConflictingBooking(studentid, BookedSlots[0])\n                    .then(function(response) {\n                        if (response.validationerror) {\n                            // eslint-disable-next-line no-alert\n                            alert('Errors encountered: Unable to check conflicting bookings!');\n                            CalendarViewManager.stopLoading(root);\n                        } else {\n                            // Check if there are no conflicting messages\n                            if (response.result) {\n                                ModalActions.showWarning(response.warnings[0].message);\n                                CalendarViewManager.stopLoading(root);\n                            }\n                        }\n                        return response.result;\n                    })\n                    .then(pendingPromise.resolve)\n                    .fail(Notification.exception);\n\n                // Save booking if no conflicting bookings were found\n                if (!hasConflictingBooking) {\n                    Repository.saveBookedSlot(BookedSlots[0], course, exercise, studentid)\n                    .then(function(response) {\n                        if (response.validationerror) {\n                            // eslint-disable-next-line no-alert\n                            alert('Errors encountered: Unable to save slot!');\n                            CalendarViewManager.stopLoading(root);\n                        } else {\n                            // Redirect to bookings view\n                            formSaved = true;\n                            location.href = M.cfg.wwwroot + '/local/booking/view.php?courseid=' + course;\n                        }\n                        return;\n                    })\n                    .fail(Notification.exception);\n                }\n            } else {\n                // Show warning message\n                CalendarViewManager.stopLoading(root);\n                ModalActions.showWarning('warnoneslotmax');\n            }\n        }\n\n    /**\n     * Update Slots & BookedSlots with marked availability\n     * posts in the calendar view.\n     *\n     * @method getSlots\n     * @param {object} root     The calendar root element\n     * @param {String} action   The action for display view/book\n     */\n    function getSlots(root, action) {\n\n        const slotType = action == 'book' ? 'slot-booked' : 'slot-marked';\n        const year = $(Selectors.wrappers.calendarwrapper).data('year');\n        const week = $(Selectors.wrappers.calendarwrapper).data('week');\n        const minute59 = 3540; // 59 minutes end of slot but before next hour\n\n        const tableId = $(Selectors.regions.slotsweek).attr('id');\n        const head = $('#' + tableId + ' th');\n        const colCount = document.getElementById(tableId).rows[0].cells.length;\n        var colOffset;\n\n        Slots.length = 0;\n        BookedSlots.length = 0;\n\n        // Get column index for the start of the week\n        head.each(function() {\n            if ($(this).data('region') == 'slot-week-day') {\n                colOffset = head.index(this) + 1;\n                return false;\n            }\n            return true;\n        });\n\n        // Get all slots for this week from the UI table\n        for (let i = colOffset; i <= colCount; i++) {\n            // Get slots for the current day\n            const dayHour = $('#' + tableId + ' td:nth-child(' + i + ')').map(function() {\n                return [[$(this).data(slotType), $(this).data('slot-timestamp')]];\n            }).get();\n\n            // Get each slot in the day (start and end times)\n            let aSlot = {};\n\n            // Check each day (column) and record marked slot start-end times\n            dayHour.forEach((hourSlot, index) => {\n                let isLastElement = index == dayHour.length - 1;\n\n                // Check if the slot is marked to record start or end time in marked sequence\n                if (hourSlot[0]) {\n                    if (Object.keys(aSlot).length === 0 && aSlot.constructor === Object) {\n                        aSlot.starttime = hourSlot[1];\n                        aSlot.endtime = hourSlot[1] + minute59;\n                    } else {\n                        aSlot.endtime = hourSlot[1] + minute59;\n                    }\n\n                // Add the slot if it has start and end, and this slot is empty => slot sequence ended\n                } else if (!(Object.keys(aSlot).length === 0 && aSlot.constructor === Object)) {\n                    aSlot = addSlot(aSlot, slotType, week, year);\n                }\n\n                // Add slot if it ends at the end of the day, edge case handling\n                if (isLastElement && !(Object.keys(aSlot).length === 0 && aSlot.constructor === Object)) {\n                    aSlot = addSlot(aSlot, slotType, week, year);\n                }\n            });\n        }\n    }\n\n    /**\n     * Adds a slot to local object array (Slots).\n     *\n     * @method addSlot\n     * @param {object} aSlot The slot to be add to the local object array\n     * @param {string} slotType The slot type availability post vs booked\n     * @param {int} week The week of the year\n     * @param {int} year The year\n     * @return {object} empty object\n     */\n     function addSlot(aSlot, slotType, week = 0, year = 0) {\n        if (slotType == 'slot-marked') {\n            Slots.push(aSlot);\n        } else if (slotType == 'slot-booked') {\n            aSlot.week = week;\n            aSlot.year = year;\n            BookedSlots.push(aSlot);\n        }\n        return {};\n    }\n\n    /**\n     * Update the indexes array tracking copied table indexes\n     * editing existing events.\n     *\n     * @param {object} root The calendar root element\n     * @method copySlots\n     */\n    function copySlots(root) {\n        SlotIndexes.length = 0;\n\n        $(Selectors.regions.day).each((idx, el) => {\n            if ($(el).data('slot-marked')) {\n                SlotIndexes.push([el.closest('tr').rowIndex, el.cellIndex]);\n            }\n        });\n\n        setPasteState(root);\n\n        return;\n    }\n\n    /**\n     * Paste slots by setting the cells from\n     * SlotIndexes (copied cells) to the calendar\n     *\n     * @method pasteSlots\n     * @param {object} root The calendar root element\n     */\n    function pasteSlots(root) {\n        if (SlotIndexes.length > 0) {\n            const table = document.getElementById(root.find(Selectors.regions.slotsweek).attr('id'));\n            SlotIndexes.forEach((idx) => {\n                let slot = table.rows[idx[0]].cells[idx[1]];\n                $(slot).data('slot-marked', 1);\n                $(slot).addClass('slot-selected', 1);\n            });\n            formSaved = false;\n        }\n\n        return;\n     }\n\n    /**\n     * Clear slots for a user per course in week and year\n     * given they are not otherwise booked\n     *\n     * @method clearWeekSlots\n     */\n    function clearWeekSlots() {\n        $('td').filter(function() {\n            if ($(this).data('slot-booked') == 0) {\n                $(this).data('slot-marked', 0);\n                $(this).removeClass('slot-selected');\n            }\n            return true;\n        });\n        formSaved = false;\n        return;\n    }\n\n    /**\n     * Set the cells from the copied SlotIndexes to the current table\n     *\n     * @method setPasteState\n     * @param {object} root The week calendar root element\n     */\n    function setPasteState(root) {\n        if (SlotIndexes.length > 0) {\n            root.find(Selectors.regions.pastebutton).addClass('btn-primary').removeClass('btn-secondary');\n        } else {\n            root.find(Selectors.regions.pastebutton).addClass('btn-secondary').removeClass('btn-primary');\n        }\n\n        return;\n     }\n\n    /**\n     * Set the cells from the CopiedSlotsIndexes to the current table\n     *\n     * @method setSlot\n     * @param {object} cell     The copied cell\n     * @param {String} action   The action mode: book|post\n     */\n    function setSlot(cell, action) {\n        const slotAction = action == 'book' ? 'slot-booked' : 'slot-marked';\n        const slotActionClass = action == 'book' ? 'slot-booked' : 'slot-selected';\n\n        if (!$(cell).data(slotAction)) {\n            $(cell).addClass(slotActionClass);\n        } else {\n            $(cell).removeClass(slotActionClass);\n        }\n        $(cell).data(slotAction, !$(cell).data(slotAction));\n\n        return;\n    }\n\n    /**\n     * Set cells selected and save buttons state\n     *\n     * @method setPosting\n     * @param {bool} state  The posting state\n     */\n    function setPosting(state) {\n        postActive = state;\n    }\n\n    /**\n     * Set cells selected and save buttons state\n     *\n     * @method postSlots\n     * @param {object} root     The calendar root element\n     * @param {String} action   The action behind the active view\n     * @param {object} target   The target event object (cell)\n     * @param {String} overridePost The override flag for posting state\n     */\n    function postSlots(root, action, target, overridePost = false) {\n        // Change marked state\n        if (typeof target !== 'undefined' && (postActive || overridePost) &&\n            !target.is(Selectors.regions.daytimeslot) && action !== 'all' && action !== '') {\n                formSaved = false;\n                setSlot(target, action);\n        }\n    }\n\n    /**\n     * Checks whether the calendar has been edited without saving\n     *\n     * @method isDirty\n     * @return {bool} dirtyState  The posting state\n     */\n    function isDirty() {\n        return !formSaved;\n    }\n\n    /**\n     * Reset the form saved flag so the form is no longer dirty\n     *\n     * @method clean\n     * @return {bool} dirtyState  The posting state\n     */\n    function clean() {\n        formSaved = true;\n    }\n\n    return {\n        saveWeekSlots: saveWeekSlots,\n        saveBookedSlot: saveBookedSlot,\n        clearWeekSlots: clearWeekSlots,\n        pasteSlots: pasteSlots,\n        setPasteState: setPasteState,\n        copySlots: copySlots,\n        postSlots: postSlots,\n        setPosting: setPosting,\n        isDirty: isDirty,\n        clean: clean,\n        Slots: Slots,\n        SlotIndexes: SlotIndexes\n    };\n});"],"names":["define","$","Notification","Pending","Repository","CalendarViewManager","ModalActions","Selectors","Slots","BookedSlots","SlotIndexes","postActive","formSaved","getSlots","root","action","slotType","year","wrappers","calendarwrapper","data","week","tableId","regions","slotsweek","attr","head","colCount","document","getElementById","rows","cells","length","colOffset","each","this","index","i","dayHour","map","get","aSlot","forEach","hourSlot","isLastElement","Object","keys","constructor","starttime","endtime","addSlot","push","setPasteState","find","pastebutton","addClass","removeClass","setSlot","cell","slotAction","slotActionClass","saveWeekSlots","startLoading","course","minslotperiod","minSlotPeriodMet","val","serverCall","saveSlots","clearSlots","then","response","validationerror","alert","always","fetchNotifications","stopLoading","fail","exception","showWarning","saveBookedSlot","exercise","studentid","pendingPromise","Array","isArray","hasConflictingBooking","result","warnings","message","resolve","location","href","M","cfg","wwwroot","clearWeekSlots","filter","pasteSlots","table","idx","slot","copySlots","day","el","closest","rowIndex","cellIndex","postSlots","target","overridePost","is","daytimeslot","setPosting","state","isDirty","clean"],"mappings":"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"}