{"version":3,"sources":["../src/booking.js"],"names":["define","$","Str","Pending","ViewManager","BookingActions","BookingEvents","BookingsSelectors","SELECTORS","PROGRESSION_WRAPPER","CANCEL_BUTTON","SESSION_ENTRY","registerBookingEventListeners","root","logentryFormModalPromise","body","on","canceled","refreshProgressionContent","refreshMyBookingsContent","created","updated","deleted","registerEditListeners","registerEventListeners","eventFormPromise","registerLogentryFormModal","contextId","data","courseId","e","sessionDate","attr","studentId","exerciseId","logentryId","then","modal","setContextId","setCourseId","setStudentId","setExerciseId","setLogentryId","setSessionDate","show","fail","Notification","exception","preventDefault","gradedSession","target","pendingPromise","matches","actions","viewEvent","closest","dataset","querySelector","stopPropagation","renderLogentrySummaryModal","resolve","catch","get_string","promptMsg","comment","prompt","cancelBooking","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for handling progression booking activity\n * Improvised from core_calendar.\n *\n * @module     local_booking/booking\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n            'jquery',\n            'core/str',\n            'core/pending',\n            'local_booking/view_manager',\n            'local_booking/booking_actions',\n            'local_booking/events',\n            'local_booking/selectors'\n        ],\n        function(\n            $,\n            Str,\n            Pending,\n            ViewManager,\n            BookingActions,\n            BookingEvents,\n            BookingsSelectors\n        ) {\n\n    var SELECTORS = {\n        PROGRESSION_WRAPPER: \".progressionwrapper\",\n        CANCEL_BUTTON: \"[data-region='cancel-button']\",\n        SESSION_ENTRY: \"[data-region='session-entry']\",\n    };\n\n    /**\n     * Listen to and handle any calendar events fired by the calendar UI.\n     *\n     * @method registerBookingEventListeners\n     * @param {object} root The calendar root element\n     * @param {object} logentryFormModalPromise A promise reolved with the event form modal\n     */\n     var registerBookingEventListeners = function(root, logentryFormModalPromise) {\n        var body = $('body');\n\n        body.on(BookingEvents.canceled, function() {\n            ViewManager.refreshProgressionContent(root);\n            ViewManager.refreshMyBookingsContent(root);\n        });\n        body.on(BookingEvents.created, function() {\n            ViewManager.refreshProgressionContent(root);\n        });\n        body.on(BookingEvents.updated, function() {\n            ViewManager.refreshProgressionContent(root);\n        });\n        body.on(BookingEvents.deleted, function() {\n            ViewManager.refreshProgressionContent(root);\n        });\n\n        if (logentryFormModalPromise !== 'undefined') {\n            BookingActions.registerEditListeners(root, logentryFormModalPromise);\n        }\n    };\n\n    /**\n     * Register event listeners for the module.\n     *\n     * @param {object} root The calendar root element\n     */\n     var registerEventListeners = function(root) {\n\n        var eventFormPromise = BookingActions.registerLogentryFormModal(root),\n            contextId = $(SELECTORS.PROGRESSION_WRAPPER).data('context-id'),\n            courseId = $(SELECTORS.PROGRESSION_WRAPPER).data('courseid');\n        registerBookingEventListeners(root, eventFormPromise);\n\n        if (contextId) {\n            // Listen the click on the progression table of sessions.\n            root.on('click', SELECTORS.SESSION_ENTRY, function(e) {\n                var sessionDate = $(this).attr('data-session-date');\n                var studentId = $(this).attr('data-student-id');\n                var exerciseId = $(this).attr('data-exercise-id');\n                var logentryId = $(this).attr('data-logentry-id');\n\n                if (logentryId == 0) {\n                    eventFormPromise.then(function(modal) {\n                        modal.setContextId(contextId);\n                        modal.setCourseId(courseId);\n                        modal.setStudentId(studentId);\n                        modal.setExerciseId(exerciseId);\n                        modal.setLogentryId(logentryId);\n                        modal.setSessionDate(sessionDate);\n                        modal.show();\n                        return;\n                    })\n                    .fail(Notification.exception);\n\n                    e.preventDefault();\n                } else {\n                    let gradedSession = null;\n                    let logentryId = null;\n                    const target = e.target;\n                    const pendingPromise = new Pending('local_booking/view_manager:logentryLink:click');\n\n                    if (target.matches(BookingsSelectors.actions.viewEvent)) {\n                        gradedSession = target;\n                    } else {\n                        gradedSession = target.closest(BookingsSelectors.actions.viewEvent);\n                    }\n\n                    if (gradedSession) {\n                        logentryId = gradedSession.dataset.logentryId;\n                    } else {\n                        logentryId = target.querySelector(BookingsSelectors.actions.viewEvent).dataset.logentryId;\n                    }\n\n                    if (logentryId) {\n                        // A link was found. Show the modal.\n\n                        e.preventDefault();\n                        // We've handled the event so stop it from bubbling\n                        // and causing the day click handler to fire.\n                        e.stopPropagation();\n\n                        ViewManager.renderLogentrySummaryModal(logentryId, courseId, studentId)\n                        .then(pendingPromise.resolve)\n                        .catch();\n                    } else {\n                        pendingPromise.resolve();\n                    }\n\n                }\n            });\n        }\n\n        // Listen the click on the Cancel booking buttons.\n        root.on('click', SELECTORS.CANCEL_BUTTON, function(e) {\n            // eslint-disable-next-line no-alert\n            Str.get_string('cancellationcomment', 'local_booking').then(function(promptMsg) {\n                var comment = prompt(promptMsg);\n                if (comment !== null) {\n                    BookingActions.cancelBooking(root, e, comment);\n                }\n                return;\n            }).catch(Notification.exception);\n        });\n    };\n\n    return {\n        init: function(root) {\n            root = $(root);\n            registerEventListeners(root);\n        }\n    };\n});\n"],"file":"booking.min.js"}