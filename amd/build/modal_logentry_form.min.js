define ("local_booking/modal_logentry_form",["jquery","core/event","core/str","core/notification","core/custom_interaction_events","core/modal","core/modal_registry","core/fragment","local_booking/events","local_booking/repository","local_booking/selectors"],function(a,b,c,d,e,f,g,h,i,j,k){var l=!1,m={ADVANCED_FORM:"[data-form-type=\"other\"]",SAVE_BUTTON:"[data-action=\"save\"]",LOADING_ICON_CONTAINER:"[data-region=\"loading-icon-container\"]"},n=function(a){f.call(this,a);this.logentryId=null;this.flightDate=null;this.exerciseId=null;this.courseId=null;this.contextId=null;this.userId=null;this.reloadingBody=!1;this.reloadingTitle=!1;this.saveButton=this.getFooter().find(m.SAVE_BUTTON)};n.TYPE="local_booking-modal_logentry_form";n.prototype=Object.create(f.prototype);n.prototype.constructor=n;n.prototype.setContextId=function(a){this.contextId=a};n.prototype.getContextId=function(){return this.contextId};n.prototype.setCourseId=function(a){this.courseId=a};n.prototype.getCourseId=function(){return this.courseId};n.prototype.hasCourseId=function(){return null!==this.courseId};n.prototype.setExerciseId=function(a){this.exerciseId=a};n.prototype.getExerciseId=function(){return this.exerciseId};n.prototype.hasExerciseId=function(){return null!==this.exerciseId};n.prototype.setUserId=function(a){this.userId=a};n.prototype.getUserId=function(){return this.userId};n.prototype.hasUserId=function(){return null!==this.userId};n.prototype.setLogentryId=function(a){this.logentryId=a};n.prototype.getLogentryId=function(){return this.logentryId};n.prototype.hasLogentryId=function(){return null!==this.logentryId&&0!=this.logentryId};n.prototype.setFlightDate=function(a){this.flightDate=a};n.prototype.getFlightDate=function(){return this.flightDate};n.prototype.hasFlightDate=function(){return null!==this.flightDate};n.prototype.getForm=function(){return this.getBody().find("form")};n.prototype.disableButtons=function(){this.saveButton.prop("disabled",!0)};n.prototype.enableButtons=function(){this.saveButton.prop("disabled",!1)};n.prototype.reloadTitleContent=function(){if(this.reloadingTitle){return this.titlePromise}this.reloadingTitle=!0;if(this.hasLogentryId()){this.titlePromise=c.get_string("editlogentry","local_booking")}else{this.titlePromise=c.get_string("newlogentry","local_booking")}this.titlePromise.then(function(a){this.setTitle(a);return a}.bind(this)).always(function(){this.reloadingTitle=!1}.bind(this)).fail(d.exception);return this.titlePromise};n.prototype.reloadBodyContent=function(a){if(this.reloadingBody){return this.bodyPromise}this.reloadingBody=!0;this.disableButtons();var b={};if(this.hasUserId()){b.userid=this.getUserId()}if(this.hasLogentryId()){b.logentryid=this.getLogentryId()}if(this.hasFlightDate()){b.flightdate=this.getFlightDate()}if(this.hasCourseId()){b.courseid=this.getCourseId()}if(this.hasExerciseId()){b.exerciseid=this.getExerciseId()}if("undefined"!=typeof a){b.formdata=a}this.bodyPromise=h.loadFragment("local_booking","logentry_form",this.getContextId(),b);this.setBody(this.bodyPromise);this.bodyPromise.then(function(){this.enableButtons();this.setInputMask();this.registerChangeListeners()}.bind(this)).fail(d.exception).always(function(){this.reloadingBody=!1}.bind(this)).fail(d.exception);return this.bodyPromise};n.prototype.setInputMask=function(){if("Dual"==a(k.bookingwrapper).data("trainingtype")){Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_dualtime"))}else{Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_multipilottime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_copilottime"))}Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_sessiontime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_pictime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_instructortime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_picustime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_checkpilottime"));Inputmask({regex:"^([01]?[0-9]|2[0-3]):[0-5][0-9]"}).mask(document.getElementById("id_deptime"));Inputmask({regex:"^([01]?[0-9]|2[0-3]):[0-5][0-9]"}).mask(document.getElementById("id_arrtime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_nighttime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_ifrtime"));Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsday"));Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsnight"))};n.prototype.registerChangeListeners=function(){var b=a("#id_p1pirep");b.on("change",function(a){if(!isNaN(b.val())){return this.getPIREPData(a)}}.bind(this));var c=a("#id_soloflight");c.on("change",function(a){return this.applyFlightOpsDefaults(a,"Solo")}.bind(this));pictime=document.getElementById("id_pictime");pictime.onchange=function(a){return this.applyFlightOpsDefaults(a)}.bind(this)};n.prototype.getPIREPData=function(b){var e=this.getFooter().find(m.LOADING_ICON_CONTAINER);rule=a(k.bookingwrapper).data("trainingtype");pirepdiv=a("#id_p1pirep").parent();pirep=a("#id_p1pirep").val();courseid=this.getCourseId();userid=this.getUserId();e.removeClass("hidden");return j.findPirep(pirep,courseid,userid).then(function(b){if(b.result){a("#id_p1pirep").removeClass("is-invalid");if(!a("#id_valid_p1pirep").length){c.get_string("pirepfound","local_booking").then(function(b){pirepdiv.append("<div class=\"form-control-feedback valid-feedback\" id=\"id_valid_p1pirep\" tabindex=\"0\" style=\"\">"+b+"</div");a("#id_p1pirep").addClass("is-valid");return b}).fail(d.exception)}a("#id_flightdate").val(b.logentry.flightdate);if("Dual"==rule&&!b.logentry.soloflight){a("#id_dualtime").val(b.logentry.pictime)}else if("Multicrew"==rule&&!b.logentry.soloflight){a("#id_multipilottime").val(b.logentry.pictime);a("#id_copilottime").val(b.logentry.pictime);a("#id_ifrttime").val(b.logentry.pictime)}a("#id_instructortime").val(b.logentry.pictime);a("input[name=\"linkedpirep\"]").val(b.logentry.linkedpirep);a("#id_pictime").val(b.logentry.pictime);a("#id_depicao").val(b.logentry.depicao);a("#id_arricao").val(b.logentry.arricao);a("#id_deptime").val(b.logentry.deptime);a("#id_arrtime").val(b.logentry.arrtime);a("#id_callsign").val(b.logentry.callsign);a("#id_aircraft").val(b.logentry.aircraft);a("#id_aircraftreg").val(b.logentry.aircraftreg);a("#id_fstd").val(b.logentry.fstd)}else{a("#id_p1pirep").addClass("is-invalid");if(!a("#id_error2_p1pirep").length){c.get_string("errorp1pirepnotfound","local_booking").then(function(a){pirepdiv.append("<div class=\"form-control-feedback invalid-feedback\" id=\"id_error2_p1pirep\" tabindex=\"0\" style=\"\">"+a+"</div");return a}).fail(d.exception)}else{a("#id_error2_p1pirep").show()}}}).always(function(){e.addClass("hidden");b.preventDefault();b.stopPropagation()}).fail(d.exception)};n.prototype.applyFlightOpsDefaults=function(b,c){c=c||a(k.bookingwrapper).data("trainingtype");var d=a("#id_pictime").val(),e=a("#id_soloflight").prop("checked"),f=function(b){if(a(b).is(":hidden")){a(b).val("")}else{a(b).val(0)}};switch(c){case"Dual":if(!e){a("#id_dualtime").val(d);a("#id_instructortime").val(d)}break;case"Multicrew":if(!e){a("#id_multipilottime").val(d);a("#id_copilottime").val(d)}break;case"Solo":a("#fitem_id_p2id").slideToggle("fast",f("#id_p2id"));a("#fitem_id_sessiontime").slideToggle("fast",f("#id_sessiontime"));a("#fitem_id_instructortime").slideToggle("fast",f("#id_instructortime"));a("#fitem_id_p2pirep").slideToggle("fast",f("#id_p2pirep"));a("#fitem_id_picustime").slideToggle("fast",f("#id_picustime"));a("#fitem_id_checkpilottime").slideToggle("fast",f("#id_checkpilottime"));if(a("#id_dualtime").length){a("#fitem_id_dualtime").slideToggle("fast",f("#id_dualtime"))}if(a("#id_multipilottime").length){a("#fitem_id_multipilottime").slideToggle("fast",f("#id_multipilottime"))}if(a("#id_copilottime").length){a("#fitem_id_copilottime").slideToggle("fast",f("#id_copilottime"))}break;}b.preventDefault();b.stopPropagation()};n.prototype.reloadAllContent=function(){return a.when(this.reloadTitleContent(),this.reloadBodyContent())};n.prototype.show=function(){this.reloadAllContent();f.prototype.show.call(this)};n.prototype.hide=function(){f.prototype.hide.call(this);this.setLogentryId(null);this.setFlightDate(null);this.setContextId(null);this.setCourseId(null);this.setExerciseId(null)};n.prototype.getFormData=function(){return this.getForm().serialize()};n.prototype.save=function(){var b,c=this.saveButton.find(m.LOADING_ICON_CONTAINER);b=this.getForm().find("[aria-invalid=\"true\"]");if(b.length){b.first().focus();return}c.removeClass("hidden");this.disableButtons();var e=this.getFormData(),f="contextid="+this.contextId+"&courseid="+this.courseId+"&exerciseid="+this.exerciseId+"&userid="+this.userId;return j.submitCreateUpdateLogentryForm(f,e).then(function(b){if(b.validationerror){this.reloadBodyContent(e)}else{var c=this.hasLogentryId();this.hide();if(c){a("body").trigger(i.updated,[b.logentry])}else{a("body").trigger(i.created,[b.logentry])}}}.bind(this)).always(function(){c.addClass("hidden");d.fetchNotifications();this.enableButtons()}.bind(this)).fail(d.exception)};n.prototype.registerEventListeners=function(){f.prototype.registerEventListeners.call(this);this.getModal().on(e.events.activate,m.SAVE_BUTTON,function(a,b){this.getForm().submit();b.originalEvent.preventDefault();a.stopPropagation()}.bind(this));this.getModal().on("submit",function(a){b.notifyFormSubmitAjax(this.getForm()[0]);this.save();a.preventDefault();a.stopPropagation()}.bind(this))};if(!l){g.register(n.TYPE,n,"local_booking/modal_logentry_form");l=!0}return n});
//# sourceMappingURL=modal_logentry_form.min.js.map
