{"version":3,"sources":["../src/booking.js"],"names":["define","$","Str","ModalFactory","ModalEvents","Pending","ModalLogentryForm","ViewManager","BookingActions","BookingEvents","BookingSelectors","SELECTORS","BOOKING_WRAPPER","CANCEL_BUTTON","OVERRIDE_BUTTON","SESSION_ENTRY","registerBookingEventListeners","root","logentryFormModalPromise","body","on","canceled","refreshProgressionContent","refreshMyBookingsContent","created","updated","deleted","registerActionListeners","registerEventListeners","logentryFormPromise","registerLogentryFormModal","contextId","data","courseId","e","sessionDate","attr","studentId","exerciseId","logentryId","additionalEntry","then","modal","setContextId","setCourseId","setStudentId","setExerciseId","setLogentryId","setSessionDate","setAdditionalEntry","show","fail","Notification","exception","preventDefault","logentrySession","target","pendingPromise","matches","actions","viewLogEntry","closest","dataset","querySelector","stopPropagation","renderLogentrySummaryModal","resolve","catch","get_string","promptMsg","comment","prompt","cancelBooking","overrideRestriction","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for handling progression booking activity\n * Improvised from core_calendar.\n *\n * @module     local_booking/booking\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n            'jquery',\n            'core/str',\n            'core/modal_factory',\n            'core/modal_events',\n            'core/pending',\n            'local_booking/modal_logentry_form',\n            'local_booking/booking_view_manager',\n            'local_booking/booking_actions',\n            'local_booking/events',\n            'local_booking/selectors'\n        ],\n        function(\n            $,\n            Str,\n            ModalFactory,\n            ModalEvents,\n            Pending,\n            ModalLogentryForm,\n            ViewManager,\n            BookingActions,\n            BookingEvents,\n            BookingSelectors\n        ) {\n\n    var SELECTORS = {\n        BOOKING_WRAPPER: \".bookingwrapper\",\n        CANCEL_BUTTON: \"[data-region='cancel-button']\",\n        OVERRIDE_BUTTON: \"[data-region='override-button']\",\n        SESSION_ENTRY: \"[data-region='session-entry']\",\n    };\n\n    /**\n     * Listen to and handle any calendar events fired by the calendar UI.\n     *\n     * @method registerBookingEventListeners\n     * @param  {object} root The calendar root element\n     * @param  {object} logentryFormModalPromise A promise reolved with the event form modal\n     */\n     var registerBookingEventListeners = function(root, logentryFormModalPromise) {\n        var body = $('body');\n\n        body.on(BookingEvents.canceled, function() {\n            ViewManager.refreshProgressionContent(root);\n            ViewManager.refreshMyBookingsContent(root);\n        });\n        body.on(BookingEvents.created, function() {\n            ViewManager.refreshProgressionContent(root);\n        });\n        body.on(BookingEvents.updated, function() {\n            ViewManager.refreshProgressionContent(root);\n        });\n        body.on(BookingEvents.deleted, function() {\n            ViewManager.refreshProgressionContent(root);\n        });\n\n        BookingActions.registerActionListeners(root, logentryFormModalPromise);\n    };\n\n    /**\n     * Register event listeners for the module.\n     *\n     * @method  registerEventListeners\n     * @param   {object} root The calendar root element\n     */\n     var registerEventListeners = function(root) {\n\n        var logentryFormPromise = BookingActions.registerLogentryFormModal(root),\n            contextId = $(SELECTORS.BOOKING_WRAPPER).data('contextid'),\n            courseId = $(SELECTORS.BOOKING_WRAPPER).data('courseid');\n        registerBookingEventListeners(root, logentryFormPromise);\n\n        if (contextId) {\n            // Listen the click on the progression table of sessions.\n            root.on('click', SELECTORS.SESSION_ENTRY, function(e) {\n                var sessionDate = $(this).attr('data-session-date');\n                var studentId = $(this).attr('data-student-id');\n                var exerciseId = $(this).attr('data-exercise-id');\n                var logentryId = $(this).attr('data-logentry-id');\n                var additionalEntry = $(this).attr('data-is-additional') !== undefined;\n\n                if (logentryId == 0) {\n                    logentryFormPromise.then(function(modal) {\n                        modal.setContextId(contextId);\n                        modal.setCourseId(courseId);\n                        modal.setStudentId(studentId);\n                        modal.setExerciseId(exerciseId);\n                        modal.setLogentryId(logentryId);\n                        modal.setSessionDate(sessionDate);\n                        modal.setAdditionalEntry(additionalEntry);\n                        modal.show();\n                        return;\n                    })\n                    .fail(Notification.exception);\n\n                    e.preventDefault();\n                } else {\n                    let logentrySession = null;\n                    let logentryId = null;\n                    const target = e.target;\n                    const pendingPromise = new Pending('local_booking/booking_view_manager:logentrySession:click');\n\n                    if (target.matches(BookingSelectors.actions.viewLogEntry)) {\n                        logentrySession = target;\n                    } else {\n                        logentrySession = target.closest(BookingSelectors.actions.viewLogEntry);\n                    }\n\n                    if (logentrySession) {\n                        logentryId = logentrySession.dataset.logentryId;\n                    } else {\n                        logentryId = target.querySelector(BookingSelectors.actions.viewLogEntry).dataset.logentryId;\n                    }\n\n                    if (logentryId) {\n                        // A link was found. Show the modal.\n\n                        e.preventDefault();\n                        // We've handled the event so stop it from bubbling\n                        // and causing the day click handler to fire.\n                        e.stopPropagation();\n\n                        ViewManager.renderLogentrySummaryModal(logentryId, courseId, studentId)\n                        .then(pendingPromise.resolve)\n                        .catch();\n                    } else {\n                        pendingPromise.resolve();\n                    }\n\n                }\n            });\n        }\n\n        // Listen the click on the Cancel booking buttons.\n        root.on('click', SELECTORS.CANCEL_BUTTON, function(e) {\n            // eslint-disable-next-line no-alert\n            Str.get_string('cancellationcomment', 'local_booking').then(function(promptMsg) {\n                var comment = prompt(promptMsg);\n                if (comment !== null) {\n                    BookingActions.cancelBooking(root, e, comment);\n                }\n                return;\n            }).catch(Notification.exception);\n        });\n\n        // Listen the click on the Override button in the booking confirmation page.\n        root.on('click', SELECTORS.OVERRIDE_BUTTON, function() {\n            return BookingActions.overrideRestriction(root);\n        });\n    };\n\n    return {\n        init: function(root) {\n            root = $(root);\n            registerEventListeners(root);\n        }\n    };\n});\n"],"file":"booking.min.js"}