/**
 * This module handles logbook entry form.
 *
 * @module     local_booking/modal_logentry_form
 * @author     Mustafa Hajjar (mustafahajjar@gmail.com)
 * @copyright  BAVirtual.co.uk Â© 2021
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_booking/modal_logentry_form",["jquery","core_form/events","core/str","core/notification","core/custom_interaction_events","core/modal","core/modal_registry","core/fragment","local_booking/events","local_booking/repository","local_booking/selectors"],(function($,FormEvents,Str,Notification,CustomEvents,Modal,ModalRegistry,Fragment,LogbookEvents,Repository,Selectors){var registered=!1,SELECTORS_SAVE_BUTTON='[data-action="save"]',SELECTORS_LOADING_ICON_CONTAINER='[data-region="loading-icon-container"]',ModalLogEntryForm=function(root){Modal.call(this,root),this.contextId=null,this.courseId=null,this.userId=null,this.logentryId=null,this.flightDate=null,this.exerciseId=null,this.pirepLookupId=null,this.hasfindpirep=!1,this.reloadingBody=!1,this.reloadingTitle=!1,this.saveButton=this.getFooter().find(SELECTORS_SAVE_BUTTON)};return ModalLogEntryForm.TYPE="local_booking-modal_logentry_form",(ModalLogEntryForm.prototype=Object.create(Modal.prototype)).constructor=ModalLogEntryForm,ModalLogEntryForm.prototype.setContextId=function(id){this.contextId=id},ModalLogEntryForm.prototype.getContextId=function(){return this.contextId},ModalLogEntryForm.prototype.setCourseId=function(id){this.courseId=id},ModalLogEntryForm.prototype.getCourseId=function(){return this.courseId},ModalLogEntryForm.prototype.hasCourseId=function(){return null!==this.courseId},ModalLogEntryForm.prototype.setExerciseId=function(id){this.exerciseId=id},ModalLogEntryForm.prototype.getExerciseId=function(){return this.exerciseId},ModalLogEntryForm.prototype.hasExerciseId=function(){return null!==this.exerciseId},ModalLogEntryForm.prototype.setUserId=function(id){this.userId=id},ModalLogEntryForm.prototype.getUserId=function(){return this.userId},ModalLogEntryForm.prototype.hasUserId=function(){return null!==this.userId},ModalLogEntryForm.prototype.setLogentryId=function(id){this.logentryId=id},ModalLogEntryForm.prototype.getLogentryId=function(){return this.logentryId},ModalLogEntryForm.prototype.hasLogentryId=function(){return null!==this.logentryId&&0!=this.logentryId},ModalLogEntryForm.prototype.setFlightDate=function(time){this.flightDate=time},ModalLogEntryForm.prototype.getFlightDate=function(){return this.flightDate},ModalLogEntryForm.prototype.hasFlightDate=function(){return null!==this.flightDate},ModalLogEntryForm.prototype.setFlightType=function(flighttype){this.flightType=flighttype},ModalLogEntryForm.prototype.getFlightType=function(){return this.flightType},ModalLogEntryForm.prototype.hasFindPIREP=function(hasfindpirep){return void 0!==hasfindpirep&&(this.hasfindpirep=hasfindpirep),this.hasfindpirep},ModalLogEntryForm.prototype.getForm=function(){return this.getBody().find("form")},ModalLogEntryForm.prototype.disableButtons=function(){this.saveButton.prop("disabled",!0)},ModalLogEntryForm.prototype.enableButtons=function(){this.saveButton.prop("disabled",!1)},ModalLogEntryForm.prototype.reloadTitleContent=function(){return this.reloadingTitle||(this.reloadingTitle=!0,this.titlePromise=Repository.getExerciseName(this.courseId,this.exerciseId).then((function(response){return response.exercisename})).fail(Notification.exception),this.titlePromise.then(function(string){return this.setTitle(string),string}.bind(this)).always(function(){this.reloadingTitle=!1}.bind(this)).fail(Notification.exception)),this.titlePromise},ModalLogEntryForm.prototype.reloadBodyContent=function(formData){if(this.reloadingBody)return this.bodyPromise;this.reloadingBody=!0,this.disableButtons();var args={};return this.hasUserId()&&(args.userid=this.getUserId()),this.hasLogentryId()&&(args.logentryid=this.getLogentryId()),this.hasFlightDate()&&(args.flightdate=this.getFlightDate()),this.hasCourseId()&&(args.courseid=this.getCourseId()),this.hasExerciseId()&&(args.exerciseid=this.getExerciseId()),void 0!==formData&&(args.formdata=formData),this.bodyPromise=Fragment.loadFragment("local_booking","logentry_form",this.getContextId(),args),this.setBody(this.bodyPromise),this.bodyPromise.then(function(){if(this.hasFindPIREP()&&!$("#id_error2_p1pirep").length){let p1pirep=$("#id_p1pirep");p1pirep.parent().prepend('<div class="input-group" id="id_pirepgroup">'),$("#id_pirepgroup").append(p1pirep),$("#id_pirepgroup").append('<div class="input-group-append" id="id_find_pirep">'),$("#id_find_pirep").append('<button type="button" class="btn btn-primary search-icon"><i class="icon fa fa-search fa-fw " aria-hidden="true"></i></button>')}this.doDynamicDisplay(),this.enableButtons(),this.setInputMask(),this.registerChangeListeners()}.bind(this)).fail(Notification.exception).always(function(){this.reloadingBody=!1}.bind(this)).fail(Notification.exception),this.bodyPromise},ModalLogEntryForm.prototype.setInputMask=function(){"Dual"==$(Selectors.bookingwrapper).data("trainingtype")?Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_dualtime")):"Multicrew"==$(Selectors.bookingwrapper).data("trainingtype")&&Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_multipilottime")),"check"==$("input[name='flighttypehidden']").val()?Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_picustime")):"solo"==$("input[name='flighttypehidden']").val()?Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_flighttime")):Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_groundtime")),Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_flighttime")),Inputmask({regex:"^([01]?[0-9]|2[0-3]):[0-5][0-9]"}).mask(document.getElementById("id_deptime")),Inputmask({regex:"^([01]?[0-9]|2[0-3]):[0-5][0-9]"}).mask(document.getElementById("id_arrtime")),Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_nighttime")),Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_ifrtime")),Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp1day")),Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp1night")),0==this.getLogentryId()&&(Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp2day")),Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp2night")))},ModalLogEntryForm.prototype.registerChangeListeners=function(){this.hasFindPIREP()&&$("#id_find_pirep").on("click",function(e){if(!isNaN($("#id_p1pirep").val()))return this.getPIREPData(e)}.bind(this));$('input[name="flighttype"]').on("change",function(){$("input[name='flighttypehidden']").val($("input[name='flighttype']:checked").val()),this.doDynamicDisplay(),this.applyFlightTimes()}.bind(this)),$('input[name="passfail"]').on("change",function(){this.doDynamicDisplay(),this.applyFlightTimes()}.bind(this)),$('input[name="flightrule"]').on("change",function(){this.doDynamicDisplay(),this.applyFlightTimes()}.bind(this)),flighttime=document.getElementById("id_flighttime"),flighttime.onchange=function(){return this.applyFlightTimes(!0)}.bind(this)},ModalLogEntryForm.prototype.getPIREPData=function(e){var loadingContainer=this.getFooter().find(SELECTORS_LOADING_ICON_CONTAINER);return rule=$(Selectors.bookingwrapper).data("trainingtype"),pirepdiv=$("#id_p1pirep").parent(),pirep=$("#id_p1pirep").val(),courseid=this.getCourseId(),exerciseid=this.getExerciseId(),""!=pirep?(loadingContainer.removeClass("hidden"),Repository.findPirep(pirep,courseid,$("#id_p1id").val(),exerciseid).then(function(response){if($("#id_p1pirep").removeClass("is-invalid"),response.result){$("#id_valid_p1pirep").length||Str.get_string("pirepfound","local_booking").then((function(string){return pirepdiv.append('<div class="form-control-feedback valid-feedback" id="id_valid_p1pirep" tabindex="0" style="">'+string+"</div>"),$("#id_p1pirep").addClass("is-valid"),string})).fail(Notification.exception);var d=new Date(1e3*response.logentry.flightdate),month=""+(d.getMonth()+1),day=""+d.getDate(),year=d.getFullYear(),time=response.logentry.deptime,hour=time.substring(0,2),minute=time.substring(time.indexOf(":")+1,time.length);$("#id_flightdate_day").val(day),$("#id_flightdate_month").val(month),$("#id_flightdate_year").val(year),$("#id_flightdate_hour").val(hour),$("#id_flightdate_minute").val(minute),$('input[name="linkedpirep"]').val(response.logentry.linkedpirep),$("#id_flighttime").val(response.logentry.flighttime),$("#id_depicao").val(response.logentry.depicao),$("#id_arricao").val(response.logentry.arricao),$("#id_deptime").val(response.logentry.deptime),$("#id_arrtime").val(response.logentry.arrtime),$("#id_callsign").val(response.logentry.callsign),$("#id_aircraft").val(response.logentry.aircraft),$("#id_aircraftreg").val(response.logentry.aircraftreg),$("#id_enginetype").val(response.logentry.enginetype),$("#id_route").val(response.logentry.route),$("#id_fstd").val(response.logentry.fstd),this.doDynamicDisplay(),this.applyFlightTimes()}else $("#id_p1pirep").addClass("is-invalid"),$("#id_error2_p1pirep").length?$("#id_error2_p1pirep").show():(pirepdiv.append('<div class="form-control-feedback invalid-feedback" id="id_error2_p1pirep" tabindex="0" style="">'+response.warnings[0].message+"</div>"),$("#id_p1pirep").val(""),$("#id_p1pirep").focus()),this.hasFindPIREP()&&$("#id_p1pirep").parent().each((function(){$("#id_find_pirep").insertAfter($("#id_p1pirep"),this)}))}.bind(this)).always((function(){loadingContainer.addClass("hidden"),e.preventDefault(),e.stopPropagation()})).fail(Notification.exception)):""},ModalLogEntryForm.prototype.applyFlightTimes=function(force){const rule=$(Selectors.bookingwrapper).data("trainingtype");var flighttype=$("input[name='flighttypehidden']").val(),flighttime=$("#id_flighttime").val(),passfail=$("input[name='passfail']:checked").val(),ifr="ifr"==$("input[name='flightrule']:checked").val();(!(0!=this.getLogentryId())||force)&&("training"==flighttype||"check"==flighttype&&"fail"==passfail?($("#id_dualtime").val("Dual"==rule?flighttime:""),$("#id_ifrtime").val(ifr?flighttime:""),$("#id_multipilottime").val("Multicrew"==rule?flighttime:""),$("#id_copilottime").val("Multicrew"==rule?flighttime:""),$("#id_checkpilottime").val("check"==flighttype?flighttime:""),$("#id_picustime").val("")):"solo"==flighttype?($("#id_ifrtime").val(ifr?flighttime:""),$("#id_dualtime").val(""),$("#id_multipilottime").val(""),$("#id_copilottime").val(""),$("#id_picustime").val("")):"check"!=flighttype&&"pass"!=passfail||($("#id_ifrtime").val(ifr?flighttime:""),$("#id_picustime").val(flighttime),$("#id_checkpilottime").val(flighttime),$("#id_multipilottime").val("Multicrew"==rule?flighttime:""),$("#id_dualtime").val(""),$("#id_copilottime").val("")))},ModalLogEntryForm.prototype.doDynamicDisplay=function(){const rule=$(Selectors.bookingwrapper).data("trainingtype");var flighttype=$("input[name='flighttypehidden']").val(),passfail=$("input[name='passfail']:checked").val(),ifr="ifr"==$("input[name='flightrule']:checked").val(),editmode=0!=this.getLogentryId(),toggle=function(div,element,show,value){let force=arguments.length>4&&void 0!==arguments[4]&&arguments[4];void 0!==div&&void 0!==element&&((this.getForm().find('[aria-expanded="true"]').attr("aria-expanded")||force)&&(show?$(div).slideDown("fast"):$(div).slideUp("fast")),void 0!==value&&$(element).val(value))}.bind(this),setLabel=function(element,editlabelkey,labelkey){editmode?Str.get_string(editlabelkey,"local_booking").then((function(label){return $(element).text(label),label})).fail(Notification.exception):Str.get_string(labelkey,"local_booking").then((function(label){return $(element).text(label),label})).fail(Notification.exception)};"training"==flighttype||"check"==flighttype&&"fail"==passfail?(p1label="training"==flighttype||editmode?"Dual"==rule?"p1dual":"p1multicrew":"examiner",setLabel("label[for='id_p1pirep']","pirep","training"==flighttype?"instpirep":"examinerpirep"),setLabel("label[for='id_p1id']",p1label,p1label),toggle("#fitem_id_p2id","#id_p2id",!0),toggle("#fitem_id_dualtime","#id_dualtime","Dual"==rule),toggle("#fitem_id_groundtime","#id_groundtime",!0,$("#id_groundtime").val(),!0),toggle("#fitem_id_ifrtime","#id_ifrtime",ifr),toggle("#fitem_id_nighttime","#id_nighttime",ifr),toggle("#fitem_id_multipilottime","#id_multipilottime","Multicrew"==rule),toggle("#fitem_id_copilottime","#id_copilottime","Multicrew"==rule),toggle("#fitem_id_checkpilottime","#id_checkpilottime",!1),toggle("#fitem_id_picustime","#id_picustime",!1)):"solo"==flighttype?(setLabel("label[for='id_p1pirep']","logbooksolopirep","logbooksolopirep"),setLabel("label[for='id_p1id']","p2dual","p2dual"),editmode||$("#id_p1id").val($("#id_p2id").val()),toggle("#fitem_id_ifrtime","#id_ifrtime",ifr),$("#id_landingsp1day").val("1"),$("#id_landingsp2day").val("0"),toggle("#fitem_id_p2id","#id_p2id",!1,$("#id_p2id").val(),!0),toggle("#fitem_id_groundtime","#id_groundtime",!1,"",!0),toggle("#fitem_id_dualtime","#id_dualtime",!1),toggle("#fitem_id_multipilottime","#id_multipilottime",!1),toggle("#fitem_id_copilottime","#id_copilottime",!1),toggle("#fitem_id_picustime","#id_picustime",!1),toggle("#fgroup_id_landingsp2","#id_landingsp2",!1)):"check"!=flighttype&&"pass"!=passfail||(setLabel("label[for='id_p1pirep']","pirep","examinerpirep"),setLabel("label[for='id_p1id']","examiner","examiner"),toggle("#fitem_id_p2id","#id_p2id",!0),toggle("#fitem_id_ifrtime","#id_ifrtime",ifr),toggle("#fitem_id_multipilottime","#id_multipilottime","Multicrew"==rule),toggle("#fitem_id_picustime","#id_picustime",!0),toggle("#fitem_id_dualtime","#id_dualtime",!1),toggle("#fitem_id_copilottime","#id_copilottime",!1),toggle("#fitem_id_checkpilottime","#id_checkpilottime",!1))},ModalLogEntryForm.prototype.reloadAllContent=function(){return $.when(this.reloadTitleContent(),this.reloadBodyContent())},ModalLogEntryForm.prototype.show=function(){this.reloadAllContent(),Modal.prototype.show.call(this)},ModalLogEntryForm.prototype.hide=function(){Modal.prototype.hide.call(this),this.setLogentryId(null),this.setFlightDate(null),this.setContextId(null),this.setCourseId(null),this.setExerciseId(null)},ModalLogEntryForm.prototype.getFormData=function(){return this.getForm().serialize()},ModalLogEntryForm.prototype.save=function(){var invalid,loadingContainer=this.saveButton.find(SELECTORS_LOADING_ICON_CONTAINER);if("training"!=$("input[name='flighttypehidden']").val()&&$("#id_groundtime").val("00:00"),!(invalid=this.getForm().find('[aria-invalid="true"]')).length){loadingContainer.removeClass("hidden"),this.disableButtons();var formData=this.getFormData(),formArgs="contextid="+this.contextId+"&courseid="+this.courseId+"&exerciseid="+this.exerciseId+"&userid="+this.userId;return Repository.submitCreateUpdateLogentryForm(formArgs,formData).then(function(response){if(response.validationerror)this.reloadBodyContent(formData);else{var isExisting=this.hasLogentryId();this.hide(),isExisting?$("body").trigger(LogbookEvents.logentryupdated,[response.logentry]):$("body").trigger(LogbookEvents.logentrycreated,[response.logentry])}}.bind(this)).always(function(){loadingContainer.addClass("hidden"),Notification.fetchNotifications(),this.enableButtons()}.bind(this)).fail(Notification.exception)}invalid.first().focus()},ModalLogEntryForm.prototype.registerEventListeners=function(){Modal.prototype.registerEventListeners.call(this),this.getModal().on(CustomEvents.events.activate,SELECTORS_SAVE_BUTTON,function(e,data){this.getForm().submit(),data.originalEvent.preventDefault(),e.stopPropagation()}.bind(this)),this.getModal().on("submit",function(e){FormEvents.notifyFormSubmittedByJavascript(this.getForm()[0]),this.save(),e.preventDefault(),e.stopPropagation()}.bind(this)),this.getModal().on("click","a[aria-expanded]",function(){setTimeout(function(){this.doDynamicDisplay()}.bind(this),100)}.bind(this))},registered||(ModalRegistry.register(ModalLogEntryForm.TYPE,ModalLogEntryForm,"local_booking/modal_logentry_form"),registered=!0),ModalLogEntryForm}));

//# sourceMappingURL=modal_logentry_form.min.js.map