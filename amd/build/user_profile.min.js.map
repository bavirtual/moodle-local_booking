{"version":3,"sources":["../src/user_profile.js"],"names":["define","$","Str","Notification","Repository","Selectors","setEndorsement","courseId","userId","endorse","root","userProfile","find","userprofilewrapper","endorsername","data","endorser","endorsedate","Date","endorsedon","toDateString","endorsedatets","Math","round","getTime","endorsestr","endorsemsgPromise","get_string","then","message","html","removeClass","addClass","bind","fail","exception","processUserPreference","preference","value","element","updateUserPreferences","always","fetchNotifications","ex","prop","processSuspendedStatus","suspend","updateSuspendedStatus","processGroup","key","group","updateGroup","processSetting","startLoading","stopLoading","registerEventListeners","click","checked","loadingIconContainer","containers","loadingIcon","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Controls the message preference page.\n *\n * @module     local_booking/administration\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/str',\n    'core/notification',\n    'local_booking/repository',\n    'local_booking/selectors'\n],\nfunction(\n    $,\n    Str,\n    Notification,\n    Repository,\n    Selectors\n) {\n\n    /**\n     * Set the endorsed message.\n     *\n     * @param  {string} courseId    The course id for suspension.\n     * @param  {string} userId      The user id to be suspended.\n     * @param  {string} endorse     Endorse true/false.\n     * @param  {object} root        The root element.\n     * @method setEndorsement\n     */\n     const setEndorsement = function(courseId, userId, endorse, root) {\n        // Get endorsement information (endorser, date, and message) from template\n        let userProfile = root.find(Selectors.userprofilewrapper),\n        endorsername = userProfile.data('endorsername'),\n        endorser = userProfile.data('endorser'),\n        endorsedate = new Date(),\n        endorsedon = endorsedate.toDateString(),\n        endorsedatets = Math.round(endorsedate.getTime() / 1000),\n        endorsestr = endorse ? 'endorsementmgs' : 'skilltestendorse';\n\n        // Process endorsement message\n        let endorsemsgPromise = Str.get_string(endorsestr, 'local_booking', {endorser: endorsername, endorsedate: endorsedon});\n        endorsemsgPromise.then(function(message) {\n            // Set endorsement message\n            $('#endorsement-label').html(message);\n            // Show/hide recommendation letter link\n            if (endorse) {\n                $('#endorsement-letter').removeClass('hidden');\n            } else {\n                $('#endorsement-letter').addClass('hidden');\n            }\n\n            return message;\n        }.bind(this))\n        .fail(Notification.exception);\n\n        // Persist endorsement in user preferences\n        processUserPreference('endorse', endorse, courseId, userId, 'endorse');\n        processUserPreference('endorser', endorse ? endorser : '', courseId, userId, 'endorse');\n        processUserPreference('endorsedate', endorse ? endorsedatets : '', courseId, userId, 'endorse');\n        processUserPreference('endorsenotify', endorse, courseId, userId, 'endorse');\n    };\n\n    /**\n     * Process the user setting preference depending on the passed\n     * preference and value pairs.\n     *\n     * @param  {string} preference  The  preferencekey of the setting.\n     * @param  {string} value       The value data.\n     * @param  {string} courseId    The course id for suspension.\n     * @param  {string} userId      The user id to be suspended.\n     * @param  {string} element     The element to handl GUI.\n     * @method processUserPreference\n     * @return {bool}\n     */\n     const processUserPreference = function(preference, value, courseId, userId, element) {\n        return Repository.updateUserPreferences(preference, value, courseId, userId)\n        .then()\n        .always(function() {\n            Notification.fetchNotifications();\n        })\n        .fail(function(ex) {\n            Notification.exception(ex);\n            // Handle toggle failure\n            $('#' + element).prop('checked', !$('#' + element).prop('checked'));\n            return;\n        });\n    };\n\n    /**\n     * Process the user suspension status.\n     *\n     * @param  {bool}   suspend     Suspend true/false.\n     * @param  {string} courseId    The course id for suspension.\n     * @param  {string} userId      The user id to be suspended.\n     * @method processSuspendedStatus\n     * @return {bool}\n     */\n     const processSuspendedStatus = function(suspend, courseId, userId) {\n        return Repository.updateSuspendedStatus(suspend, courseId, userId)\n        .then()\n        .always(function() {\n            Notification.fetchNotifications();\n        })\n        .fail(function(ex) {\n            Notification.exception(ex);\n            // Handle toggle failure\n            $('#suspended').prop('checked', !$('#suspended').prop('checked'));\n            return;\n        });\n    };\n\n    /**\n     * Process the user group membership status on-hold and keep active.\n     *\n     * @param  {string} key         The key of the setting.\n     * @param  {string} value      Join or leave true/false.\n     * @param  {string} courseId    The course id for suspension.\n     * @param  {string} userId      The user id to be suspended.\n     * @param  {object} root        The root element.\n     * @method processGroup\n     * @return {bool}\n     */\n     const processGroup = function(key, value, courseId, userId, root) {\n        // Get the group name from the template\n        let userProfile = root.find(Selectors.userprofilewrapper),\n        group = userProfile.data(key + 'group');\n\n        return Repository.updateGroup(group, value, courseId, userId)\n        .then()\n        .always(function() {\n            Notification.fetchNotifications();\n        })\n        .fail(function(ex) {\n            Notification.exception(ex);\n            // Handle toggle failure\n            $('#' + key).prop('checked', !$('#' + key).prop('checked'));\n            return;\n        });\n    };\n\n    /**\n     * Create all of the event listeners for the message preferences page.\n     *\n     * @param  {string} courseId    The course id for suspension.\n     * @param  {string} userId      The user id to be suspended.\n     * @param  {string} key         The key of the setting.\n     * @param  {string} value       Setting value.\n     * @param  {object} root        The root element.\n     * @method processSetting\n     */\n     const processSetting = function(courseId, userId, key, value, root) {\n\n        // Show progressing icon\n        startLoading($('#' + key + '-region'));\n\n        // Process the different toggle actions\n        switch (key) {\n            case 'endorse':\n                // Process student endorsement and handle UI\n                setEndorsement(courseId, userId, value, root);\n                break;\n            case 'availabilityoverride':\n                // Process availability override in user preferences and handle UI\n                processUserPreference(key, value, courseId, userId, key);\n                break;\n            case 'suspend':\n                // Toggle enrolment status suspension on/off and handle UI\n                processSuspendedStatus(value, courseId, userId);\n                break;\n            case 'onhold':\n            case 'keepactive':\n                // Process keep active in user preferences and handle UI\n                processGroup(key, value, courseId, userId, root);\n                break;\n        }\n\n        // Stop showing progressing icon\n        stopLoading($('#' + key + '-region'));\n    };\n\n    /**\n     * Create all of the event listeners for the message preferences page.\n     *\n     * @param  {object} root    The root element.\n     * @method registerEventListeners\n     */\n    const registerEventListeners = function(root) {\n\n        var userProfile = root.find(Selectors.userprofilewrapper),\n        courseId = userProfile.data('courseid'),\n        userId = userProfile.data('userid');\n\n        // Handle endorsement toggle clicks\n        $('#endorse').click(function() {\n            processSetting(courseId, userId, 'endorse', this.checked, root);\n        });\n\n        // Handle suspension toggle clicks\n        $('#suspended').click(function() {\n            processSetting(courseId, userId, 'suspend', this.checked);\n        });\n\n        // Handle on-hold toggle clicks\n        $('#onhold').click(function() {\n            processSetting(courseId, userId, 'onhold', this.checked, root);\n        });\n\n        // Handle keep active toggle clicks\n        $('#keepactive').click(function() {\n            processSetting(courseId, userId, 'keepactive', this.checked, root);\n        });\n\n        // Handle restriction override toggle clicks\n        $('#availabilityoverride').click(function() {\n            processSetting(courseId, userId, 'availabilityoverride', this.checked, root);\n        });\n    };\n\n    /**\n     * Set the element state to loading.\n     *\n     * @method  startLoading\n     * @param   {object} root The container element\n     */\n    const startLoading = (root) => {\n        const loadingIconContainer = root.find(Selectors.containers.loadingIcon);\n        loadingIconContainer.removeClass('hidden');\n    };\n\n    /**\n     * Unset the element state of loading.\n     *\n     * @method  stopLoading\n     * @param   {object} root The container element\n     */\n    const stopLoading = (root) => {\n        const loadingIconContainer = root.find(Selectors.containers.loadingIcon);\n        loadingIconContainer.addClass('hidden');\n    };\n\n    return {\n        init: function(root) {\n            root = $(root);\n            registerEventListeners(root);\n        }\n    };\n});\n"],"file":"user_profile.min.js"}