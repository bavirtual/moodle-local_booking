{"version":3,"sources":["../src/booking.js"],"names":["define","$","Str","Pending","ModalFactory","ViewManager","BookingActions","BookingEvents","ModalLogentryEditForm","Selectors","registerBookingEventListeners","root","body","on","canceled","refreshBookingsContent","refreshMyBookingsContent","created","updated","deleted","cancelbutton","e","get_string","then","promptMsg","comment","prompt","cancelBooking","catch","Notification","exception","val","actions","gotoFeedback","preventDefault","registerSessionEventListeners","contextId","bookingwrapper","data","courseId","viewLogEntry","logentryId","attr","userId","stopPropagation","registerLogentryEditForm","registerLogentrySummaryForm","stopImmediatePropagation","isNew","LogentryFormPromise","create","type","TYPE","large","target","pendingPromise","renderLogentryModal","resolve","renderLogentrySummaryModal","modal","editLogentry","getRoot","addLogentry","registerEventListeners","init","stopLoading"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for registering listeners\n * for all session booking and logentry events.\n *\n * @module     local_booking/booking\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n        'jquery',\n        'core/str',\n        'core/pending',\n        'core/modal_factory',\n        'local_booking/booking_view_manager',\n        'local_booking/booking_actions',\n        'local_booking/events',\n        'local_booking/modal_logentry_form',\n        'local_booking/selectors'\n    ],\n    function(\n        $,\n        Str,\n        Pending,\n        ModalFactory,\n        ViewManager,\n        BookingActions,\n        BookingEvents,\n        ModalLogentryEditForm,\n        Selectors\n    ) {\n\n    /**\n     * Listen to and handle any logentry events fired by\n     * Logentry and PIREP the modal forms.\n     *\n     * @method registerBookingEventListeners\n     * @param  {object} root The booking root element\n     * @param  {object} logentryFormModalPromise A promise reolved with the Logentry form modal\n     * @param  {object} pirepFormPromise A promise reolved with the PIREP verification form modal\n     */\n     const registerBookingEventListeners = function(root) {\n        const body = $('body');\n\n        body.on(BookingEvents.canceled, function() {\n            ViewManager.refreshBookingsContent(root);\n            ViewManager.refreshMyBookingsContent(root);\n        });\n        body.on(BookingEvents.created, function() {\n            ViewManager.refreshBookingsContent(root);\n        });\n        body.on(BookingEvents.updated, function() {\n            ViewManager.refreshBookingsContent(root);\n        });\n        body.on(BookingEvents.deleted, function() {\n            ViewManager.refreshBookingsContent(root);\n        });\n\n        // Listen to the click on the Cancel booking buttons in 'Instructor dashboard' page.\n        root.on('click', Selectors.cancelbutton, function(e) {\n            // eslint-disable-next-line no-alert\n            Str.get_string('cancellationcomment', 'local_booking').then(function(promptMsg) {\n                const comment = prompt(promptMsg);\n                if (comment !== null) {\n                    BookingActions.cancelBooking(root, e, comment);\n                }\n                return;\n            }).catch(Notification.exception);\n        });\n\n        // Register the listeners required to redirect to\n        // $('input[name=\"studentsfilter\"]').change(function() {\n        // $('input[type=radio][name=studentsfilter]').change(function() {\n        root.on('change', 'input[type=radio][name=studentsfilter]', function() {\n            // Call redirect to assignment feedback page\n            ViewManager.refreshBookingsContent(root, 0, 0, null, $('input[name=\"studentsfilter\"]:checked').val());\n        });\n\n        // Register the listeners required to redirect to\n        root.on('click', Selectors.actions.gotoFeedback, function(e) {\n            // Call redirect to assignment feedback page\n            BookingActions.gotoFeedback(root, e);\n\n            e.preventDefault();\n        });\n    };\n\n    /**\n     * Register event listeners for session clicks.\n     *\n     * @param {object} root The root element.\n     */\n    const registerSessionEventListeners = (root) => {\n\n        // Get promise for the logentry form for create and edit\n        const contextId = $(Selectors.bookingwrapper).data('contextid'),\n        courseId = $(Selectors.bookingwrapper).data('courseid');\n\n        if (contextId) {\n            // Listen the click on the progression table of sessions for a logentry (new/view).\n            root.on('click', Selectors.actions.viewLogEntry, function(e) {\n                let logentryId = $(this).attr('data-logentry-id'),\n                userId = $(this).attr('data-student-id');\n\n                // A logentry needs to be created or edite, show the modal form.\n                e.preventDefault();\n                // We've handled the event so stop it from bubbling\n                // and causing the day click handler to fire.\n                e.stopPropagation();\n\n                if (logentryId == 0) {\n                    registerLogentryEditForm(null, e, contextId, courseId, userId, logentryId, true);\n                } else {\n                    registerLogentrySummaryForm(contextId, courseId, userId, logentryId);\n                }\n                e.stopImmediatePropagation();\n            });\n        }\n    };\n\n    /**\n     * Register the form and listeners required for\n     * creating and editing logentries.\n     *\n     * @method registerLogentryEditForm\n     * @param  {object} root       The root element.\n     * @param  {object} e          The triggered event.\n     * @param  {Number} contextId  The course context id of the logentry.\n     * @param  {Number} courseId   The course id of the logentry.\n     * @param  {Number} userId     The user id the logentry belongs to.\n     * @param  {Number} logentryId The logentry id.\n     * @param  {bool}   isNew      Whether to register for edit mode.\n     */\n    const registerLogentryEditForm = (root, e, contextId, courseId, userId, logentryId, isNew) => {\n        const LogentryFormPromise = ModalFactory.create({\n            type: ModalLogentryEditForm.TYPE,\n            large: true\n        });\n\n        const target = e.target;\n        const pendingPromise = new Pending('local_booking/registerLogentryEditForm');\n\n        ViewManager.renderLogentryModal(root, e, LogentryFormPromise, target, contextId, courseId, userId, logentryId, isNew)\n        .then(pendingPromise.resolve())\n        .catch();\n    };\n\n    /**\n     * Register the form and listeners required for\n     * viewing the logentry summary form.\n     *\n     * @method registerLogentrySummaryForm\n     * @param  {Number} contextId  The course context id of the logentry.\n     * @param  {Number} courseId   The course id of the logentry.\n     * @param  {Number} userId     The user id the logentry belongs to.\n     * @param  {Number} logentryId The logentry id.\n     */\n    const registerLogentrySummaryForm = (contextId, courseId, userId, logentryId) => {\n        const pendingPromise = new Pending('local_booking/registerLogentrySummaryForm');\n\n        if (logentryId) {\n            ViewManager.renderLogentrySummaryModal(courseId, userId, logentryId)\n            .then(function(modal) {\n                $('body').on(BookingEvents.editLogentry, function(e, userId, logentryId) {\n                    registerLogentryEditForm(modal.getRoot(), e, contextId, courseId, userId, logentryId);\n                    e.stopImmediatePropagation();\n                });\n                $('body').on(BookingEvents.addLogentry, function(e, userId) {\n                    registerLogentryEditForm(modal.getRoot(), e, contextId, courseId, userId, 0);\n                    e.stopImmediatePropagation();\n                });\n                return modal;\n            })\n            .then(pendingPromise.resolve())\n            .catch();\n        } else {\n            pendingPromise.resolve();\n        }\n    };\n\n    /**\n     * Register event listeners for logbook entry,\n     * and session cancellation in both\n     * 'Instructor dashboard' and 'Session selection' pages.\n     *\n     * @method  registerEventListeners\n     * @param   {object} root The booking root element\n     */\n     const registerEventListeners = function(root) {\n\n        // Register listeners to booking actions\n        registerBookingEventListeners(root);\n\n        // Register listeners to session click actions\n        registerSessionEventListeners(root);\n    };\n\n    return {\n        init: function(root) {\n            var root = $(root);\n            registerEventListeners(root);\n            ViewManager.stopLoading(root);\n        }\n    };\n});\n"],"file":"booking.min.js"}