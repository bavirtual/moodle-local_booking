{"version":3,"sources":["../src/booking_actions.js"],"names":["define","$","Str","Notification","CustomEvents","Modal","ModalRegistry","ModalFactory","ModalEvents","Pending","ModalLogentryForm","Repository","BookingEvents","ModalDelete","BookingSelectors","ViewManager","confirmDeletion","logentrytId","logentrytTitle","pendingPromise","deleteStrings","key","component","deletePromise","push","param","create","type","types","SAVE_CANCEL","stringsPromise","get_strings","finalPromise","when","then","strings","deleteModal","setRemoveOnClose","setTitle","setBody","setSaveButtonText","show","getRoot","on","save","deleteLogentry","trigger","deleted","resolve","catch","exception","deleteAll","modal","registerRedirect","root","actions","gotoFeedback","e","logentrySource","find","logentryItem","modId","data","userId","location","href","M","cfg","wwwroot","preventDefault","registerRemove","remove","closest","registerEditListeners","logentryFormModalPromise","editLogentry","studentId","bookingWrapper","progressionwrapper","setLogentryId","setStudentId","setCourseId","setContextId","stopImmediatePropagation","registerLogentryFormModal","logentryFormPromise","TYPE","large","edit","target","currentTarget","logentryWrapper","fail","cancelBooking","comment","startLoading","courseId","bookingId","dataset","bookingid","response","validationerror","alert","always","canceled","fetchNotifications","stopLoading"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A module to handle CRUD operations within the UI.\n * Improvised from core_calendar.\n *\n * @module     local_booking/booking_actions\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/str',\n    'core/notification',\n    'core/custom_interaction_events',\n    'core/modal',\n    'core/modal_registry',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/pending',\n    'local_booking/modal_logentry_form',\n    'local_booking/repository',\n    'local_booking/events',\n    'local_booking/modal_delete',\n    'local_booking/selectors',\n    'local_booking/view_manager',\n],\nfunction(\n    $,\n    Str,\n    Notification,\n    CustomEvents,\n    Modal,\n    ModalRegistry,\n    ModalFactory,\n    ModalEvents,\n    Pending,\n    ModalLogentryForm,\n    Repository,\n    BookingEvents,\n    ModalDelete,\n    BookingSelectors,\n    ViewManager,\n) {\n\n    /**\n     * Cancel a specific booking and trigger update UI event.\n     *\n     * @method cancelBooking\n     * @param {object} root     The My Bookings root element\n     * @param {object} e        The click event on the Cancel button\n     * @param {string} comment  The click event on the Cancel button\n     * @return {object} The create modal promise\n     */\n    var cancelBooking = (root, e, comment) => {\n        ViewManager.startLoading(root);\n\n        var target = e.target;\n        // Get course id and booking id\n        const courseId = courseId || root.find(BookingSelectors.progressionwrapper).data('courseid');\n        const bookingId = target.dataset.bookingid;\n\n        // Send the request data to the server for processing.\n        return Repository.cancelBooking(bookingId, comment)\n            .then(function(response) {\n                if (response.validationerror) {\n                    // eslint-disable-next-line no-alert\n                    alert('Errors encountered: Unable to cancel booking!');\n                }\n                return;\n            })\n            .always(function() {\n                $('body').trigger(BookingEvents.canceled, [root, false]);\n                Notification.fetchNotifications();\n                ViewManager.stopLoading(root);\n            })\n            .fail(Notification.exception);\n    };\n\n    /**\n     * Prepares the action for the summary modal's delete action.\n     *\n     * @param {Number} logentrytId The ID of the logentry.\n     * @param {string} logentrytTitle The logentry title.\n     * @return {Promise}\n     */\n    function confirmDeletion(logentrytId, logentrytTitle) {\n        var pendingPromise = new Pending('local_booking/logentry_actions:confirmDeletion');\n        var deleteStrings = [\n            {\n                key: 'deletelogentry',\n                component: 'local_booking'\n            },\n        ];\n\n        var deletePromise;\n        deleteStrings.push({\n            key: 'confirmlogentrydelete',\n            component: 'local_booking',\n            param: logentrytTitle\n        });\n\n\n        deletePromise = ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n        });\n\n        var stringsPromise = Str.get_strings(deleteStrings);\n\n        var finalPromise = $.when(stringsPromise, deletePromise)\n        .then(function(strings, deleteModal) {\n            deleteModal.setRemoveOnClose(true);\n            deleteModal.setTitle(strings[0]);\n            deleteModal.setBody(strings[1]);\n            deleteModal.setSaveButtonText(strings[0]);\n\n            deleteModal.show();\n\n            deleteModal.getRoot().on(ModalEvents.save, function() {\n                var pendingPromise = new Pending('local_booking/logentry_actions:initModal:deletedlogentry');\n                Repository.deleteLogentry(logentrytId, false)\n                    .then(function() {\n                        $('body').trigger(BookingEvents.deleted, [logentrytId, false]);\n                        return;\n                    })\n                    .then(pendingPromise.resolve)\n                    .catch(Notification.exception);\n            });\n\n            deleteModal.getRoot().on(BookingEvents.deleteAll, function() {\n                var pendingPromise = new Pending('local_booking/logentry_actions:initModal:deletedalllogentry');\n                Repository.deleteLogentry(logentrytId, true)\n                    .then(function() {\n                        $('body').trigger(BookingEvents.deleted, [logentrytId, true]);\n                        return;\n                    })\n                    .then(pendingPromise.resolve)\n                    .catch(Notification.exception);\n            });\n\n            return deleteModal;\n        })\n        .then(function(modal) {\n            pendingPromise.resolve();\n\n            return modal;\n        })\n        .catch(Notification.exception);\n\n        return finalPromise;\n    }\n\n    /**\n     * Create the logentry form modal for creating new logentries and\n     * editing existing logentries.\n     *\n     * @method registerLogentryFormModal\n     * @param {object} root The progression booking root element\n     * @return {object} The create modal promise\n     */\n    var registerLogentryFormModal = function(root) {\n        var logentryFormPromise = ModalFactory.create({\n            type: ModalLogentryForm.TYPE,\n            large: true\n        });\n\n        root.on('click', BookingSelectors.actions.edit, function(e) {\n            e.preventDefault();\n            var target = $(e.currentTarget),\n                bookingWrapper = target.closest(BookingSelectors.progressionwrapper),\n                logentryWrapper = target.closest(BookingSelectors.logentryItem);\n\n            logentryFormPromise.then(function(modal) {\n                // When something within the progression booking tells us the user wants\n                // to edit an logentry then show the logentry form modal.\n                modal.setLogentryId(logentryWrapper.data('logentrytId'));\n                modal.setStudentId(logentryWrapper.data('studentId'));\n                modal.setCourseId(bookingWrapper.data('courseId'));\n                modal.setContextId(bookingWrapper.data('contextId'));\n                modal.show();\n\n                e.stopImmediatePropagation();\n                return;\n            }).fail(Notification.exception);\n        });\n\n\n        return logentryFormPromise;\n    };\n\n    /**\n     * Register the listeners required to remove the logentry.\n     *\n     * @param   {jQuery} root\n     */\n     function registerRemove(root) {\n        root.on('click', BookingSelectors.actions.remove, function(e) {\n            // Fetch the logentry title, and pass them into the new dialogue.\n            var logentrySource = $(this).closest(BookingSelectors.logentryItem);\n            var logentrytId = logentrySource.data('logentrytId'),\n                logentrytTitle = logentrySource.data('logentrytTitle');\n            confirmDeletion(logentrytId, logentrytTitle);\n\n            e.preventDefault();\n        });\n    }\n\n    /**\n     * Register the listeners required to remove the logentry.\n     *\n     * @param   {jQuery} root\n     */\n    function registerRedirect(root) {\n        root.on('click', BookingSelectors.actions.gotoFeedback, function(e) {\n            // Fetch the logentry title, and pass them into the new dialogue.\n            var logentrySource = root.find(BookingSelectors.logentryItem),\n                modId = logentrySource.data('exerciseId'),\n                userId = logentrySource.data('studentId');\n                $('body').trigger(BookingEvents.gotoFeedback, [modId]);\n\n                // Redirect to the grading and feedback page\n                location.href = M.cfg.wwwroot + '/mod/assign/view.php?id=' + modId +\n                    '&rownum=0&userid=' + userId + '&action=grader';\n\n            e.preventDefault();\n        });\n    }\n\n    /**\n     * Register the listeners required to edit the logentry.\n     *\n     * @param   {jQuery} root\n     * @param   {Promise} logentryFormModalPromise\n     * @returns {Promise}\n     */\n    function registerEditListeners(root, logentryFormModalPromise) {\n        var pendingPromise = new Pending('local_booking/logentry_actions:registerEditListeners');\n\n        return logentryFormModalPromise\n        .then(function(modal) {\n            // When something within the progression booking tells us the user wants\n            // to edit an logentry then show the logentry form modal.\n            $('body').on(BookingEvents.editLogentry, function(e, logentrytId, studentId) {\n                var bookingWrapper = root.find(BookingSelectors.progressionwrapper);\n                modal.setLogentryId(logentrytId);\n                modal.setStudentId(studentId);\n                modal.setCourseId(bookingWrapper.data('courseid'));\n                modal.setContextId(bookingWrapper.data('contextId'));\n                modal.show();\n\n                e.stopImmediatePropagation();\n            });\n            return modal;\n        })\n        .then(function(modal) {\n            pendingPromise.resolve();\n\n            return modal;\n        })\n        .catch(Notification.exception);\n    }\n\n    return {\n        registerRedirect: registerRedirect,\n        registerRemove: registerRemove,\n        registerEditListeners: registerEditListeners,\n        registerLogentryFormModal: registerLogentryFormModal,\n        cancelBooking: cancelBooking\n    };\n});\n"],"file":"booking_actions.min.js"}