{"version":3,"file":"calendar_view_manager.min.js","sources":["../src/calendar_view_manager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module to handler booking view changes.\n * Improvised from core_calendar.\n *\n * @module     local_booking/calendar_view_manager\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2021\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport CustomEvents from 'core/custom_interaction_events';\nimport SlotActions from 'local_booking/slot_actions';\nimport * as Repository from 'local_booking/repository';\nimport * as Selectors from 'local_booking/selectors';\n\n/**\n * Register event listeners for the module.\n *\n * @method  registerEventListeners\n * @param   {object} root The root element.\n */\n const registerEventListeners = (root) => {\n    root = $(root);\n\n    // Process previous/next week navigation links\n    root.on('click', Selectors.links.navLink, (e) => {\n        const wrapper = root.find(Selectors.calendarwrapper);\n        const courseId = wrapper.data('courseid');\n        const categoryId = wrapper.data('categoryid');\n        const link = e.currentTarget;\n\n        changeWeek(root, link.href, link.dataset.year, link.dataset.week, link.dataset.time, courseId, categoryId);\n        e.preventDefault();\n    });\n\n    const viewSelector = root.find(Selectors.viewSelector);\n    CustomEvents.define(viewSelector, [CustomEvents.events.activate]);\n    viewSelector.on(\n        CustomEvents.events.activate,\n        (e) => {\n            e.preventDefault();\n\n            const option = e.target;\n            if (option.classList.contains('active')) {\n                return;\n            }\n\n            const year = option.dataset.year,\n                week = option.dataset.week,\n                time = option.dataset.time,\n                courseId = option.dataset.courseid,\n                categoryId = option.dataset.categoryid;\n\n            refreshWeekContent(root, year, week, time, courseId, categoryId, e.target, 'local_booking/availability_calendar')\n                .then(() => {\n                    return window.history.pushState({}, '', '?view=user');\n                }).fail(Notification.exception);\n        }\n    );\n\n    // Tnitialize button state\n    const action = root.find(Selectors.calendarwrapper).data('action');\n    SlotActions.setPasteState(root);\n    SlotActions.setSaveButtonState(root, action);\n};\n\n/**\n * Refresh the week content.\n *\n * @method  refreshWeekContent\n * @param   {object} root The root element.\n * @param   {number} year Year\n * @param   {number} week week\n * @param   {number} time The timestamp of the begining current week\n * @param   {number} courseId The id of the course associated with the calendar shown\n * @param   {number} categoryId The id of the category associated with the calendar shown\n * @param   {object} target The element being replaced. If not specified, the calendarwrapper is used.\n * @param   {string} template The template to be rendered.\n * @return  {promise}\n */\n export const refreshWeekContent = (root, year, week, time, courseId, categoryId, target = null, template = '') => {\n    startLoading(root);\n\n    target = target || root.find(Selectors.calendarwrapper);\n    template = template || root.attr('data-template');\n    M.util.js_pending([root.get('id'), year, week, courseId].join('-'));\n\n    const action = target.data('action');\n    const view = target.data('viewall') ? 'all' : 'user';\n    const studentId = target.data('student-id');\n    const exerciseId = target.data('exercise-id');\n    time = time == 0 ? Date.now() / 1000 : time;\n\n    return Repository.getCalendarWeekData(year, week, time, courseId, categoryId, action, view, studentId, exerciseId)\n        .then(context => {\n            context.viewingmonth = true;\n            return Templates.render(template, context);\n        })\n        .then((html, js) => {\n            return Templates.replaceNode(target, html, js);\n        })\n        .always(() => {\n            M.util.js_complete([root.get('id'), year, week, courseId].join('-'));\n            SlotActions.setPasteState(root);\n            SlotActions.setSaveButtonState(root, action);\n            return stopLoading(root);\n        })\n        .fail(Notification.exception);\n};\n\n/**\n * Handle changes to the current calendar view.\n *\n * @method  changeWeek\n * @param   {object} root The container element\n * @param   {string} url The calendar url to be shown\n * @param   {number} year Year\n * @param   {number} week week\n * @param   {number} time The timestamp of the begining current week\n * @param   {number} courseId The id of the course associated with the calendar shown\n * @param   {number} categoryId The id of the category associated with the calendar shown\n * @return  {promise}\n */\nexport const changeWeek = (root, url, year, week, time, courseId, categoryId) => {\n    return refreshWeekContent(root, year, week, time, courseId, categoryId, null, '')\n        .then((...args) => {\n            if (url.length && url !== '#') {\n                window.history.pushState({}, '', url);\n            }\n            return args;\n        });\n};\n\n/**\n * Reload the current month view data.\n *\n * @method  reloadCurrentMonth\n * @param   {object} root The container element.\n * @param   {number} courseId The id of the course associated with the calendar shown\n * @param   {number} categoryId The id of the category associated with the calendar shown\n * @return  {promise}\n */\nexport const reloadCurrentMonth = (root, courseId = 0, categoryId = 0) => {\n    const year = root.find(Selectors.calendarwrapper).data('year');\n    const week = root.find(Selectors.calendarwrapper).data('week');\n    const time = root.find(Selectors.calendarwrapper).data('time');\n\n    courseId = courseId || root.find(Selectors.calendarwrapper).data('courseid');\n    categoryId = categoryId || root.find(Selectors.calendarwrapper).data('categoryid');\n\n    return refreshWeekContent(root, year, week, time, courseId, categoryId, null, '');\n};\n\n/**\n * Set the element state to loading.\n *\n * @method  startLoading\n * @param   {object} root The container element\n */\n export const startLoading = (root) => {\n    const loadingIconContainer = root.find(Selectors.containers.loadingIcon);\n    loadingIconContainer.removeClass('hidden');\n\n    $(root).one('submit', function() {\n        $(this).find('input[type=\"submit\"]').attr('disabled', 'disabled');\n    });\n};\n\n/**\n * Remove the loading state from the element.\n *\n * @method  stopLoading\n * @param   {object} root The container element\n */\nexport const stopLoading = (root) => {\n    const loadingIconContainer = root.find(Selectors.containers.loadingIcon);\n    loadingIconContainer.addClass('hidden');\n\n    $(root).one('submit', function() {\n        $(this).find('input[type=\"submit\"]').attr('enabled', 'enabled');\n    });\n};\n\nexport const init = (root, view) => {\n    registerEventListeners(root, view);\n};"],"names":["_getRequireWildcardCache","e","WeakMap","r","t","_interopRequireWildcard","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireDefault","_jquery","_templates","_notification","_custom_interaction_events","_slot_actions","Repository","Selectors","refreshWeekContent","root","year","week","time","courseId","categoryId","target","arguments","length","undefined","template","startLoading","find","calendarwrapper","attr","M","util","js_pending","join","action","data","view","studentId","exerciseId","Date","now","getCalendarWeekData","then","context","viewingmonth","Templates","render","html","js","replaceNode","always","js_complete","SlotActions","setPasteState","setSaveButtonState","stopLoading","fail","Notification","exception","_exports","changeWeek","url","window","history","pushState","_len","args","Array","_key","reloadCurrentMonth","containers","loadingIcon","removeClass","$","one","this","addClass","init","on","links","navLink","wrapper","link","currentTarget","href","dataset","preventDefault","viewSelector","CustomEvents","define","events","activate","option","classList","contains","courseid","categoryid","registerEventListeners"],"mappings":"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"}