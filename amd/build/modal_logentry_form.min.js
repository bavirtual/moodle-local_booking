define ("local_booking/modal_logentry_form",["jquery","core/event","core/str","core/notification","core/custom_interaction_events","core/modal","core/modal_registry","core/fragment","local_booking/events","local_booking/repository","local_booking/selectors"],function(a,b,c,d,e,f,g,h,i,j,k){var l=!1,m={ADVANCED_FORM:"[data-form-type=\"other\"]",SAVE_BUTTON:"[data-action=\"save\"]",LOADING_ICON_CONTAINER:"[data-region=\"loading-icon-container\"]"},n=function(a){f.call(this,a);this.logentryId=null;this.flightDate=null;this.exerciseId=null;this.courseId=null;this.contextId=null;this.userId=null;this.p1Id=null;this.pirepLookupId=null;this.reloadingBody=!1;this.reloadingTitle=!1;this.saveButton=this.getFooter().find(m.SAVE_BUTTON)};n.TYPE="local_booking-modal_logentry_form";n.prototype=Object.create(f.prototype);n.prototype.constructor=n;n.prototype.setContextId=function(a){this.contextId=a};n.prototype.getContextId=function(){return this.contextId};n.prototype.setCourseId=function(a){this.courseId=a};n.prototype.getCourseId=function(){return this.courseId};n.prototype.hasCourseId=function(){return null!==this.courseId};n.prototype.setExerciseId=function(a){this.exerciseId=a};n.prototype.getExerciseId=function(){return this.exerciseId};n.prototype.hasExerciseId=function(){return null!==this.exerciseId};n.prototype.setUserId=function(a){this.userId=a};n.prototype.getUserId=function(){return this.userId};n.prototype.hasUserId=function(){return null!==this.userId};n.prototype.setLogentryId=function(a){this.logentryId=a};n.prototype.getLogentryId=function(){return this.logentryId};n.prototype.hasLogentryId=function(){return null!==this.logentryId&&0!=this.logentryId};n.prototype.setFlightDate=function(a){this.flightDate=a};n.prototype.getFlightDate=function(){return this.flightDate};n.prototype.hasFlightDate=function(){return null!==this.flightDate};n.prototype.getForm=function(){return this.getBody().find("form")};n.prototype.disableButtons=function(){this.saveButton.prop("disabled",!0)};n.prototype.enableButtons=function(){this.saveButton.prop("disabled",!1)};n.prototype.reloadTitleContent=function(){if(this.reloadingTitle){return this.titlePromise}this.reloadingTitle=!0;if(this.hasLogentryId()){this.titlePromise=c.get_string("editlogentry","local_booking")}else{this.titlePromise=c.get_string("newlogentry","local_booking")}this.titlePromise.then(function(a){this.setTitle(a);return a}.bind(this)).always(function(){this.reloadingTitle=!1}.bind(this)).fail(d.exception);return this.titlePromise};n.prototype.reloadBodyContent=function(b){if(this.reloadingBody){return this.bodyPromise}this.reloadingBody=!0;this.disableButtons();var c={};if(this.hasUserId()){c.userid=this.getUserId()}if(this.hasLogentryId()){c.logentryid=this.getLogentryId()}if(this.hasFlightDate()){c.flightdate=this.getFlightDate()}if(this.hasCourseId()){c.courseid=this.getCourseId()}if(this.hasExerciseId()){c.exerciseid=this.getExerciseId()}if("undefined"!=typeof b){c.formdata=b}this.bodyPromise=h.loadFragment("local_booking","logentry_form",this.getContextId(),c);this.setBody(this.bodyPromise);this.bodyPromise.then(function(){this.p1Id=a("#id_p1id").val();this.applyFlightOpsDefaults();this.enableButtons();this.setInputMask();this.registerChangeListeners()}.bind(this)).fail(d.exception).always(function(){this.reloadingBody=!1}.bind(this)).fail(d.exception);return this.bodyPromise};n.prototype.setInputMask=function(){if("Dual"==a(k.bookingwrapper).data("trainingtype")){Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_dualtime"))}else{Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_multipilottime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_copilottime"))}Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_groundtime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_pictime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_instructortime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_picustime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_checkpilottime"));Inputmask({regex:"^([01]?[0-9]|2[0-3]):[0-5][0-9]"}).mask(document.getElementById("id_deptime"));Inputmask({regex:"^([01]?[0-9]|2[0-3]):[0-5][0-9]"}).mask(document.getElementById("id_arrtime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_nighttime"));Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_ifrtime"));Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp1day"));Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp1night"));if(0==this.getLogentryId()){Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp2day"));Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp2night"))}};n.prototype.registerChangeListeners=function(){var b=a("#id_p1pirep");b.on("change",function(a){if(!isNaN(b.val())){return this.getPIREPData(a)}}.bind(this));var c=a("input[name=\"flighttype\"]");c.on("change",function(){return this.applyFlightOpsDefaults()}.bind(this));var d=a("input[name=\"passfail\"]");d.on("change",function(){return this.applyFlightOpsDefaults()}.bind(this));pictime=document.getElementById("id_pictime");pictime.onchange=function(){return this.applyFlightOpsDefaults()}.bind(this)};n.prototype.getPIREPData=function(b){var e=this.getFooter().find(m.LOADING_ICON_CONTAINER);rule=a(k.bookingwrapper).data("trainingtype");pirepdiv=a("#id_p1pirep").parent();pirep=a("#id_p1pirep").val();courseid=this.getCourseId();if(""!=pirep){e.removeClass("hidden");return j.findPirep(pirep,courseid,a("#id_p1id").val()).then(function(b){if(b.result){a("#id_p1pirep").removeClass("is-invalid");if(!a("#id_valid_p1pirep").length){c.get_string("pirepfound","local_booking").then(function(b){pirepdiv.append("<div class=\"form-control-feedback valid-feedback\" id=\"id_valid_p1pirep\" tabindex=\"0\" style=\"\">"+b+"</div");a("#id_p1pirep").addClass("is-valid");return b}).fail(d.exception)}var e=new Date(1e3*b.logentry.flightdate),f=""+(e.getMonth()+1),g=""+e.getDate(),h=e.getFullYear(),i=b.logentry.deptime,j=i.substring(0,2),k=i.substring(i.indexOf(":")+1,i.length);a("#id_flightdate_day").val(g);a("#id_flightdate_month").val(f);a("#id_flightdate_year").val(h);a("#id_flightdate_hour").val(j);a("#id_flightdate_minute").val(k);if("Dual"==rule){a("#id_dualtime").val(b.logentry.pictime)}else if("Multicrew"==rule){a("#id_multipilottime").val(b.logentry.pictime);a("#id_copilottime").val(b.logentry.pictime);a("#id_ifrtime").val(b.logentry.pictime)}a("input[name=\"linkedpirep\"]").val(b.logentry.linkedpirep);a("#id_pictime").val(b.logentry.pictime);a("#id_depicao").val(b.logentry.depicao);a("#id_arricao").val(b.logentry.arricao);a("#id_deptime").val(b.logentry.deptime);a("#id_arrtime").val(b.logentry.arrtime);a("#id_callsign").val(b.logentry.callsign);a("#id_aircraft").val(b.logentry.aircraft);a("#id_aircraftreg").val(b.logentry.aircraftreg);a("#id_enginetype").val(b.logentry.enginetype);a("#id_route").val(b.logentry.route);a("#id_fstd").val(b.logentry.fstd);if("check"==a("input[name='flighttype']:checked").val()){a("#id_picustime").val(b.logentry.pictime);a("#id_checkpilottime").val(b.logentry.pictime)}else{a("#id_instructortime").val(b.logentry.pictime)}}else{a("#id_p1pirep").addClass("is-invalid");if(!a("#id_error2_p1pirep").length){pirepdiv.append("<div class=\"form-control-feedback invalid-feedback\" id=\"id_error2_p1pirep\" tabindex=\"0\" style=\"\">"+b.warnings[0].message+"</div");a("#id_p1pirep").val("");a("#id_p1pirep").focus()}else{a("#id_error2_p1pirep").show()}}}).always(function(){e.addClass("hidden");b.preventDefault();b.stopPropagation()}).fail(d.exception)}else{return""}};n.prototype.applyFlightOpsDefaults=function(){rule=a(k.bookingwrapper).data("trainingtype");var b=a("#id_pictime").val(),c=a("input[name='flighttype']:checked").val(),d=a("input[name='passfail']:checked").val(),e=0!=this.getLogentryId(),f=""==a("#id_p1pirep").val(),g=function(b,c,d,e){if(d){a(b).slideDown("fast")}else{a(b).slideUp("fast")}if("undefined"!=typeof e){h(c,d,e)}},h=function(b,c,d){if(c&&!f){if((!a(b).val()||0==!a(b).val())&&!e){a(b).val("")}}else{a(b).val(d)}};if("training"==c||"check"==c&&"fail"==d){a("label[for='id_p1pirep']").text(e?"PIREP":"Instructor PIREP");a("#id_p1id").val(this.p1Id);g("#fitem_id_p2id","#id_p2id","solo"!=c);g("#fgroup_id_passfail","#id_passfail","check"==c);g("#fitem_id_dualtime","#id_dualtime","Dual"==rule&&(!e||e&&""!=a("#id_dualtime").val()),"Dual"==rule?b:0);if(f){g("#fitem_id_pictime","#id_pictime",!e||e&&""!=a("#id_pictime").val(),e||"check"==c?0:b)}g("#fitem_id_instructortime","#id_instructortime",!e&&"check"!=c||e&&""!=a("#id_instructortime").val(),e||"check"==c?0:b);g("#fitem_id_groundtime","#id_groundtime","training"==c,f?a("#id_groundtime").val():0);g("#fitem_id_multipilottime","#id_multipilottime","Multicrew"==rule,"Multicrew"==rule?b:0);g("#fitem_id_copilottime","#id_copilottime","Multicrew"==rule&&(!e||e&&""!=a("#id_copilottime").val()),"Multicrew"==rule?b:0);g("#fitem_id_picustime","#id_picustime",!1,0);g("#fitem_id_checkpilottime","#id_checkpilottime",!1,0)}else if("solo"==c){a("label[for='id_p1pirep']").text(e?"PIREP":"Solo PIREP");a("#id_p1id").val(a("#id_p2id").val());g("#fitem_id_p2id","#id_p2id",!1);g("#fgroup_id_passfail","#id_passfail",!1);g("#fitem_id_dualtime","#id_dualtime",!1,0);g("#fitem_id_instructortime","#id_instructortime",!1,0);g("#fitem_id_groundtime","#id_groundtime",!1,0);g("#fitem_id_multipilottime","#id_multipilottime",!1,0);g("#fitem_id_copilottime","#id_copilottime",!1,0);g("#fitem_id_picustime","#id_picustime",!1,0);g("#fitem_id_checkpilottime","#id_checkpilottime",!1,0);g("#fgroup_id_landingsp2","#id_landingsp2",!1);a("#id_landingsp1day").val("1");a("#id_landingsp2day").val("0")}else if("check"==c||"pass"==d){a("label[for='id_p1pirep']").text(e?"PIREP":"Instructor PIREP");a("#id_p1id").val(this.p1Id);g("#fitem_id_p2id","#id_p2id",!0);g("#fgroup_id_passfail","#id_passfail",!0);g("#fitem_id_dualtime","#id_dualtime",!1,0);g("#fitem_id_pictime","#id_pictime",!e||e&&""!=a("#id_pictime").val(),0);g("#fitem_id_instructortime","#id_instructortime",!1,0);g("#fitem_id_groundtime","#id_groundtime",!1,0);g("#fitem_id_multipilottime","#id_multipilottime","Multicrew"==rule,0);g("#fitem_id_copilottime","#id_copilottime",!1,0);g("#fitem_id_picustime","#id_picustime",!e||e&&""!=a("#id_picustime").val(),b);g("#fitem_id_checkpilottime","#id_checkpilottime",!e||e&&""!=a("#id_checkpilottime").val(),b)}};n.prototype.reloadAllContent=function(){return a.when(this.reloadTitleContent(),this.reloadBodyContent())};n.prototype.show=function(){this.reloadAllContent();f.prototype.show.call(this)};n.prototype.hide=function(){f.prototype.hide.call(this);this.setLogentryId(null);this.setFlightDate(null);this.setContextId(null);this.setCourseId(null);this.setExerciseId(null)};n.prototype.getFormData=function(){return this.getForm().serialize()};n.prototype.save=function(){var b,c=this.saveButton.find(m.LOADING_ICON_CONTAINER);b=this.getForm().find("[aria-invalid=\"true\"]");if(b.length){b.first().focus();return}c.removeClass("hidden");this.disableButtons();var e=this.getFormData(),f="contextid="+this.contextId+"&courseid="+this.courseId+"&exerciseid="+this.exerciseId+"&userid="+this.userId;return j.submitCreateUpdateLogentryForm(f,e).then(function(b){if(b.validationerror){this.reloadBodyContent(e)}else{var c=this.hasLogentryId();this.hide();if(c){a("body").trigger(i.updated,[b.logentry])}else{a("body").trigger(i.created,[b.logentry])}}}.bind(this)).always(function(){c.addClass("hidden");d.fetchNotifications();this.enableButtons()}.bind(this)).fail(d.exception)};n.prototype.registerEventListeners=function(){f.prototype.registerEventListeners.call(this);this.getModal().on(e.events.activate,m.SAVE_BUTTON,function(a,b){this.getForm().submit();b.originalEvent.preventDefault();a.stopPropagation()}.bind(this));this.getModal().on("submit",function(a){b.notifyFormSubmitAjax(this.getForm()[0]);this.save();a.preventDefault();a.stopPropagation()}.bind(this))};if(!l){g.register(n.TYPE,n,"local_booking/modal_logentry_form");l=!0}return n});
//# sourceMappingURL=modal_logentry_form.min.js.map
