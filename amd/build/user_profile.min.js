/**
 * Controls the message preference page.
 *
 * @module     local_booking/administration
 * @author     Mustafa Hajjar (mustafa.hajjar)
 * @copyright  BAVirtual.co.uk Â© 2024
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_booking/user_profile",["jquery","core/str","core/notification","local_booking/repository","local_booking/selectors"],(function($,Str,Notification,Repository,Selectors){const processSetting=function(courseId,userId,key,value,root){let response;switch(startLoading($("#"+key+"-region")),key){case"endorsed":response=setEndorsement(courseId,userId,value,root);break;case"xcoursebookings":response=processUserPreference(key,value,1,userId,key);break;case"overrideminslotperiod":response=processProgressFlag(key,value,courseId,userId,key);break;case"suspend":response=processSuspendedStatus(value,courseId,userId);break;case"onhold":case"keepactive":response=processGroup(key,value,courseId,userId,root)}return stopLoading($("#"+key+"-region")),response},setEndorsement=function(courseId,userId,endorse,root){let userProfile=root.find(Selectors.wrappers.userprofilewrapper),endorserName=userProfile.data("endorsername"),endorserId=userProfile.data("endorserid"),endorseDate=new Date,endorsedOn=endorseDate.toDateString(),endorseDateTS=Math.round(endorseDate.getTime()/1e3),endorsestr=endorse?"endorsementmsg":"skilltestendorsed";Str.get_string(endorsestr,"local_booking",{endorsername:endorserName,endorsedate:endorsedOn}).then((function(message){return $("#endorsement-label").html(message),endorse?$("#endorsement-letter").removeClass("hidden"):$("#endorsement-letter").addClass("hidden"),message})).fail(Notification.exception);const endorsement={endorsed:endorse,endorserid:endorserId,endorsedate:endorseDateTS};let result=processProgressFlag("endorsement",JSON.stringify(endorsement),courseId,userId,"endorsed");return result&=processProgressFlag("notifications.endorsement",endorse,courseId,userId),result},processProgressFlag=function(progressKey,value,courseId,studentId){let element=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return Repository.setProgressFlag(progressKey,value,courseId,studentId).then((function(result){return result.saved})).always((function(){Notification.fetchNotifications()})).fail((function(ex){return Notification.exception(ex),null!==element&&$("#"+element).prop("checked",!$("#"+element).prop("checked")),!0}))},processUserPreference=function(preference,value,courseId,userId,element){return Repository.setUserPreferences(preference,value,courseId,userId).then((function(result){return result.saved})).always((function(){Notification.fetchNotifications()})).fail((function(ex){return Notification.exception(ex),$("#"+element).prop("checked",!$("#"+element).prop("checked")),!0}))},processSuspendedStatus=function(suspend,courseId,userId){return Repository.updateSuspendedStatus(suspend,courseId,userId).then().always((function(){Notification.fetchNotifications()})).fail((function(ex){return Notification.exception(ex),$("#suspended").prop("checked",!$("#suspended").prop("checked")),!0}))},processGroup=function(key,add,courseId,userId,root){const groupName=root.find(Selectors.wrappers.userprofilewrapper).data(key+"group");return Repository.groupAddRemove(courseId,userId,groupName,add).then((function(response){return response.result})).always((function(){Notification.fetchNotifications()})).fail((function(ex){return Notification.exception(ex),$("#"+key).prop("checked",!$("#"+key).prop("checked")),!1}))},updateComment=function(courseId,userId,root){startLoading(root);const comment=$("#comment").val();return Repository.updateProfileComment(courseId,userId,comment).then((function(response){let result=response.result;return Str.get_string(result?"commentsaved":"commentnotsaved","local_booking").then((function(string){return $("#status").addClass("comment-status-"+(result?"success":"error")),$("#status").removeClass("comment-status-"+(result?"error":"success")),$("#status").text(string).slideDown(1e3).delay(2e3).slideUp(1e3),!0})).fail(Notification.exception),!1})).always((function(){Notification.fetchNotifications(),stopLoading(root)})).fail(Notification.exception)},startLoading=root=>{root.find(Selectors.containers.loadingIcon).removeClass("hidden")},stopLoading=root=>{root.find(Selectors.containers.loadingIcon).addClass("hidden")};return{init:function(root){!function(root){var userProfile=root.find(Selectors.wrappers.userprofilewrapper),courseId=userProfile.data("courseid"),userId=userProfile.data("userid");$("#endorsed").click((function(){processSetting(courseId,userId,"endorsed",this.checked,root)})),$("#suspended").click((function(){processSetting(courseId,userId,"suspend",this.checked)})),$("#onhold").click((function(){processSetting(courseId,userId,"onhold",this.checked,root).then((response=>0===response||($("#keepactive").prop("checked",!this.checked),processSetting(courseId,userId,"keepactive",!this.checked,root)))).fail(Notification.exception)})),$("#keepactive").click((function(){processSetting(courseId,userId,"keepactive",this.checked,root)})),$("#overrideminslotperiod").click((function(){processSetting(courseId,userId,"overrideminslotperiod",this.checked,root)})),$("#xcoursebookings").click((function(){processSetting(courseId,userId,"xcoursebookings",this.checked,root)})),$("#save_comment_button").click((function(){updateComment(courseId,userId,root)}))}(root=$(root))}}}));

//# sourceMappingURL=user_profile.min.js.map